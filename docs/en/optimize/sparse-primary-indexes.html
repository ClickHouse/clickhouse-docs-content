<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-en/guides/best-practices/sparse-primary-indexes">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">A Practical Introduction to Primary Indexes in ClickHouse | ClickHouse Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://clickhouse.com/docs/img/logo.png"><meta data-rh="true" name="twitter:image" content="https://clickhouse.com/docs/img/logo.png"><meta data-rh="true" property="og:url" content="https://clickhouse.com/docs/en/optimize/sparse-primary-indexes"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="A Practical Introduction to Primary Indexes in ClickHouse | ClickHouse Docs"><meta data-rh="true" name="description" content="In this guide we are going to do a deep dive into ClickHouse indexing."><meta data-rh="true" property="og:description" content="In this guide we are going to do a deep dive into ClickHouse indexing."><link data-rh="true" rel="icon" href="/docs/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://clickhouse.com/docs/en/optimize/sparse-primary-indexes"><link data-rh="true" rel="alternate" href="https://clickhouse.com/docs/en/optimize/sparse-primary-indexes" hreflang="en"><link data-rh="true" rel="alternate" href="https://clickhouse.com/docs/en/optimize/sparse-primary-indexes" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://62VCH2MD74-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/docs/knowledgebase/rss.xml" title="ClickHouse Knowledge Base Feed RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/docs/knowledgebase/atom.xml" title="ClickHouse Knowledge Base Feed Atom Feed">
<link rel="alternate" type="application/json" href="/docs/knowledgebase/feed.json" title="ClickHouse Knowledge Base Feed JSON Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-KF1LLRTQ5Q"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-KF1LLRTQ5Q",{})</script>


<link rel="search" type="application/opensearchdescription+xml" title="ClickHouse Docs" href="/docs/opensearch.xml">





<script src="/docs/js/analytics.js"></script><link rel="stylesheet" href="/docs/assets/css/styles.d4633d58.css">
<link rel="preload" href="/docs/assets/js/runtime~main.c931671b.js" as="script">
<link rel="preload" href="/docs/assets/js/main.05424d61.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top navBar_gvJn"><div class="navbarHeaderContainer_rccn navbar-header"><div class="navbar__inner navbarInner_W6bg"><div class="navbar__items"><a href="https://clickhouse.com/" target="_blank" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/docs/img/logo_without_text.svg" alt="ClickHouse" class="themedImage_ToTc themedImage--light_HNdA"><img src="/docs/img/logo_without_text.svg" alt="ClickHouse" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">ClickHouse</b></a><div class="navbarItemsList_uIZ2 navbar-items-list"><div class="navbar__item dropdown"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link ch-menu">Product</a><ul class="dropdown__menu"><li><a href="https://clickhouse.com/cloud" target="_blank" rel="noopener noreferrer" class="dropdown__link">ClickHouse Cloud</a></li><li><a href="https://clickhouse.com/clickhouse" target="_blank" rel="noopener noreferrer" class="dropdown__link">ClickHouse Open Source</a></li></ul></div><a href="https://clickhouse.com/customer-stories" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link ch-menu">Use Cases</a><div class="navbar__item dropdown"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link ch-menu">Company</a><ul class="dropdown__menu"><li><a href="https://clickhouse.com/blog" target="_blank" rel="noopener noreferrer" class="dropdown__link">Blog</a></li><li><a href="https://clickhouse.com/company/our-story" target="_blank" rel="noopener noreferrer" class="dropdown__link">Our story</a></li><li><a href="https://clickhouse.com/company/careers" target="_blank" rel="noopener noreferrer" class="dropdown__link">Careers</a></li><li><a href="https://clickhouse.com/company/contact" target="_blank" rel="noopener noreferrer" class="dropdown__link">Contact us</a></li><li><a href="https://clickhouse.com/company/news-events" target="_blank" rel="noopener noreferrer" class="dropdown__link">News and events</a></li></ul></div><div class="navbar__item dropdown"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link ch-menu">Learn</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/en/intro">Docs</a></li><li><a href="https://clickhouse.com/learn" target="_blank" rel="noopener noreferrer" class="dropdown__link">ClickHouse Academy</a></li></ul></div><a href="https://clickhouse.com/pricing" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link ch-menu">Pricing</a></div></div><div class="navbar__items navbar__items--right"><div class="navbar__item">
                <div class="nav-items-btns">
                  <a href="https://clickhouse.cloud/signIn" class="sign-in navbar__item navbar__link ch-menu">
                    Sign in
                  </a>
                  <a href="https://clickhouse.cloud/signUp" class="click-button-anchor">
                    <button class="click-button primary-btn">Free Trial</button>
                  </a>
                </div></div><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button></div></div><div class="secondary-nav--items secondaryMenu_iuff"><div class="scrollableElement_Qqzp secondaryMenuLeft_tFZR secondary-nav--items-left"><a aria-current="page" class="navbar__item navbar__link ch-menu navbar__link--active" href="/docs/en/intro">Docs</a><a class="navbar__item navbar__link ch-menu" href="/docs/en/cloud/overview">Cloud</a><a class="navbar__item navbar__link ch-menu" href="/docs/en/sql-reference">SQL Reference</a><a class="navbar__item navbar__link ch-menu" href="/docs/knowledgebase">Knowledge Base</a></div><div class="secondaryMenuRight__9m4 secondary-nav--items-right"><div class="navbar__item dropdown dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg width="14" height="13" viewBox="0 0 14 13" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M6.95 12.6496L9.75 5.26628H11.0333L13.8333 12.6496H12.55L11.9 10.7663H8.91667L8.25 12.6496H6.95ZM9.28333 9.69961H11.5L10.4167 6.64961H10.3667L9.28333 9.69961ZM2.08333 10.7996L1.21667 9.93294L4.33333 6.83294C3.94444 6.39961 3.60556 5.95228 3.31667 5.49094C3.02778 5.03005 2.77222 4.54405 2.55 4.03294H3.83333C4.02222 4.41072 4.22222 4.74672 4.43333 5.04094C4.64444 5.33561 4.89444 5.64405 5.18333 5.96628C5.63889 5.47739 6.01667 4.97472 6.31667 4.45828C6.61667 3.94139 6.86667 3.3885 7.06667 2.79961H0.25V1.58294H4.55V0.349609H5.78333V1.58294H10.0833V2.79961H8.3C8.07778 3.53294 7.78333 4.24116 7.41667 4.92428C7.05 5.60783 6.59444 6.25516 6.05 6.86628L7.53333 8.36628L7.06667 9.63294L5.16667 7.73294L2.08333 10.7996Z" fill="currentColor"/>
</svg></a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/en/intro">English</a></li><li><a class="dropdown__link" href="/docs/ru">Russian</a></li><li><a class="dropdown__link" href="/docs/zh">Chinese</a></li></ul></div><button class="colorModeButton_hk25 navbar-color-toggle"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M8.7227 0.724664C8.7227 0.330045 8.39191 0 8.0036 0C7.60809 0 7.2773 0.330045 7.2773 0.724664V2.18834C7.2773 2.57578 7.60809 2.90583 8.0036 2.90583C8.39191 2.90583 8.7227 2.57578 8.7227 2.18834V0.724664ZM11.5991 3.4009C11.3258 3.67354 11.3258 4.13274 11.6063 4.41256C11.8796 4.6852 12.347 4.69238 12.6274 4.40538L13.6629 3.3722C13.9434 3.09238 13.9362 2.62601 13.6629 2.34619C13.3897 2.07354 12.9222 2.08072 12.649 2.35336L11.5991 3.4009ZM3.37258 4.40538C3.64584 4.6852 4.11326 4.6852 4.38652 4.41256C4.66697 4.14709 4.66697 3.66637 4.4009 3.4009L3.3582 2.35336C3.09213 2.08789 2.61753 2.07354 2.34427 2.34619C2.07101 2.62601 2.06382 3.09238 2.33708 3.36502L3.37258 4.40538ZM7.9964 11.774C10.0602 11.774 11.7717 10.0664 11.7717 8C11.7717 5.93363 10.0602 4.22601 7.9964 4.22601C5.93258 4.22601 4.22112 5.93363 4.22112 8C4.22112 10.0664 5.93258 11.774 7.9964 11.774ZM7.9964 10.4395C6.65888 10.4395 5.55146 9.33453 5.55146 8C5.55146 6.66547 6.65888 5.56054 7.9964 5.56054C9.33393 5.56054 10.4413 6.66547 10.4413 8C10.4413 9.33453 9.33393 10.4395 7.9964 10.4395ZM15.2809 8.71749C15.6692 8.71749 16 8.38744 16 8C16 7.60538 15.6692 7.28251 15.2809 7.28251H13.8211C13.4328 7.28251 13.102 7.60538 13.102 8C13.102 8.38744 13.4328 8.71749 13.8211 8.71749H15.2809ZM0.719101 7.28251C0.330787 7.28251 0 7.60538 0 8C0 8.38744 0.330787 8.71749 0.719101 8.71749H2.17888C2.57438 8.71749 2.90517 8.38744 2.90517 8C2.90517 7.60538 2.57438 7.28251 2.17888 7.28251H0.719101ZM12.6202 11.5946C12.347 11.322 11.8796 11.322 11.5991 11.5946C11.3258 11.8744 11.3258 12.3336 11.6063 12.6135L12.649 13.6538C12.9294 13.9265 13.3897 13.9193 13.6701 13.6395C13.9434 13.3668 13.9434 12.9076 13.6629 12.6278L12.6202 11.5946ZM2.33708 12.6206C2.05663 12.9004 2.05663 13.3668 2.3227 13.6395C2.60315 13.9121 3.07056 13.9193 3.34382 13.6466L4.38652 12.6135C4.66697 12.3336 4.66697 11.8744 4.4009 11.6018C4.12045 11.322 3.65303 11.322 3.37258 11.5946L2.33708 12.6206ZM8.7227 13.8117C8.7227 13.4242 8.39191 13.0942 8.0036 13.0942C7.60809 13.0942 7.2773 13.4242 7.2773 13.8117V15.2753C7.2773 15.6628 7.60809 16 8.0036 16C8.39191 16 8.7227 15.6628 8.7227 15.2753V13.8117Z" fill="currentColor"></path></svg><span>light Mode</span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_W2AM"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage_qMb8"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_mhZE"><div class="sidebarSearchContainer_Lwc8"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_Y1UP"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menuListItemCollapsed_i9wL menu__list-item-collapsible" data-link="false"><a class="menu__link">Get Started</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/en/intro">What is ClickHouse?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/en/getting-started/quick-start">Quick Start</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/en/tutorial">Advanced Tutorial</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/en/install">Install</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item top-nav-item"><div class="menuListItemCollapsed_i9wL menu__list-item-collapsible" data-link="false"><a class="menu__link">Concepts</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/en/concepts/why-clickhouse-is-so-fast">Why is ClickHouse so Fast?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/en/concepts/olap">What is OLAP?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/en/about-us/distinctive-features">Why is ClickHouse unique?</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menuListItemCollapsed_i9wL menu__list-item-collapsible" data-link="false"><a class="menu__link menu__link--active">Guides</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/en/guides/creating-tables">Creating Tables</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/en/guides/inserting-data">Inserting Data</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/en/guides/writing-queries">SELECT Queries</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/en/guides/developer/mutations">Updating and Deleting Data</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/en/guides/joining-tables">Joining Tables</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menuListItemCollapsed_i9wL menu__list-item-collapsible" data-link="true"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/en/guides/developer/cascading-materialized-views">Advanced Guides</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menuListItemCollapsed_i9wL menu__list-item-collapsible" data-link="true"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/en/optimize/sparse-primary-indexes">Best Practices</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/en/optimize/sparse-primary-indexes">Sparse Primary Indexes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/en/optimize/skipping-indexes">Data Skipping Indexes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/en/optimize/asynchronous-inserts">Asynchronous Inserts</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/en/optimize/avoid-mutations">Avoid Mutations</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/en/optimize/avoid-nullable-columns">Avoid Nullable Columns</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/en/optimize/avoidoptimizefinal">Avoid Optimize Final</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/en/optimize/bulk-inserts">Bulk Inserts</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/en/optimize/partitioning-key">Partitioning Key</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menuListItemCollapsed_i9wL menu__list-item-collapsible" data-link="true"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/en/getting-started/example-datasets">Example Datasets</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menuListItemCollapsed_i9wL menu__list-item-collapsible" data-link="false"><a class="menu__link">Integrations</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/en/integrations">View all integrations</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/en/integrations/s3">AWS S3</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/en/integrations/gcs">Google Cloud Storage (GCS)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/en/integrations/postgresql">PostgreSQL</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/en/integrations/mysql">MySQL</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/en/integrations/kafka">Kafka</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/en/integrations/dbt">dbt</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/en/integrations/redshift">Redshift</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed top-nav-item"><div class="menuListItemCollapsed_i9wL menu__list-item-collapsible" data-link="true"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/en/integrations/airbyte">More...</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menuListItemCollapsed_i9wL menu__list-item-collapsible" data-link="false"><a class="menu__link">Data Formats</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/en/integrations/data-formats/csv-tsv">CSV and TSV</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/en/integrations/data-formats/json">JSON</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/en/integrations/data-formats/parquet">Parquet</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/en/integrations/data-formats/arrow-avro-orc">Avro, Arrow and ORC</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/en/interfaces/formats">View all formats...</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menuListItemCollapsed_i9wL menu__list-item-collapsible" data-link="false"><a class="menu__link">Clients and Drivers</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/en/integrations/sql-clients/clickhouse-client-local">clickhouse-client (CLI)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/en/integrations/sql-clients/sql-console">SQL Console</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/en/getting-started/playground">ClickHouse Playground</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/en/integrations/language-clients/nodejs">Node.js</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/en/integrations/java">Java</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/en/integrations/python">Python</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menuListItemCollapsed_i9wL menu__list-item-collapsible" data-link="true"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/en/integrations/language-clients/nodejs">View all languages</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menuListItemCollapsed_i9wL menu__list-item-collapsible" data-link="true"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/en/interfaces/overview">Drivers and Interfaces</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menuListItemCollapsed_i9wL menu__list-item-collapsible" data-link="true"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/en/integrations/datagrip">SQL Clients</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menuListItemCollapsed_i9wL menu__list-item-collapsible" data-link="true"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/en/integrations/data-visualization">Business Intelligence</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menuListItemCollapsed_i9wL menu__list-item-collapsible" data-link="false"><a class="menu__link">Managing ClickHouse</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/en/operations/access-rights">Users and Roles</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/en/operations/backup">Backup and Restore</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/en/operations/monitoring">Monitoring</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menuListItemCollapsed_i9wL menu__list-item-collapsible" data-link="true"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/en/guides/sre/configuring-ldap">Security</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menuListItemCollapsed_i9wL menu__list-item-collapsible" data-link="true"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/en/operations/settings">Advanced Settings</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menuListItemCollapsed_i9wL menu__list-item-collapsible" data-link="true"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/en/guides/sre/scaling-clusters">Performance and Optimizations</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menuListItemCollapsed_i9wL menu__list-item-collapsible" data-link="true"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/en/operations/utilities">Tools and Utilities</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menuListItemCollapsed_i9wL menu__list-item-collapsible" data-link="true"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/en/operations/update">More...</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menuListItemCollapsed_i9wL menu__list-item-collapsible" data-link="false"><a class="menu__link">About ClickHouse</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/en/about-us/adopters">Adopters</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menuListItemCollapsed_i9wL menu__list-item-collapsible" data-link="true"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/changelog">Changelog</a><button aria-label="Toggle the collapsible sidebar category &#x27;Changelog&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/en/whats-new/security-changelog">Security Changelog</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/en/whats-new/roadmap">Roadmap</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menuListItemCollapsed_i9wL menu__list-item-collapsible" data-link="true"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/en/development/developer-instruction">Contribute</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/en/about-us/history">ClickHouse History</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_RiV8"><div class="container padding-top--md padding-bottom--lg main-content-wrapper"><div class="row"><div class="col docItemCol_z5aJ"><div class="docItemContainer_c0TR"><article><div class="theme-doc-markdown markdown"><h1>A Practical Introduction to Primary Indexes in ClickHouse</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a href="#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction">​</a></h2><p>In this guide we are going to do a deep dive into ClickHouse indexing. We will illustrate and discuss in detail:</p><ul><li><a href="#an-index-design-for-massive-data-scales">how indexing in ClickHouse is different from traditional relational database management systems</a></li><li><a href="#a-table-with-a-primary-key">how ClickHouse is building and using a table’s sparse primary index</a></li><li><a href="#using-multiple-primary-indexes">what some of the best practices are for indexing in ClickHouse</a></li></ul><p>You can optionally execute all ClickHouse SQL statements and queries given in this guide by yourself on your own machine.
For installation of ClickHouse and getting started instructions, see the <a href="/docs/en/getting-started/quick-start">Quick Start</a>.</p><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_WoCw"><div class="alert-icon admonitionIcon_Ibzs"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></div><div class="alert-content admonitionContent_vXIg"><div class="admonitionHeading_TMsN">note</div><p>This guide is focusing on ClickHouse sparse primary indexes.</p><p>For ClickHouse <a href="/docs/en/engines/table-engines/mergetree-family/mergetree#table_engine-mergetree-data_skipping-indexes">secondary data skipping indexes</a>, see the <a href="/docs/en/optimize/skipping-indexes">Tutorial</a>.</p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="data-set">Data Set<a href="#data-set" class="hash-link" aria-label="Direct link to Data Set" title="Direct link to Data Set">​</a></h3><p>Throughout this guide we will use a sample anonymized web traffic data set.</p><ul><li>We will use a subset of 8.87 million rows (events) from the sample data set.</li><li>The uncompressed data size is 8.87 million events and about 700 MB. This compresses to 200 mb when stored in ClickHouse.</li><li>In our subset, each row contains three columns that indicate an internet user (<code>UserID</code> column) who clicked on a URL (<code>URL</code> column) at a specific time (<code>EventTime</code> column).</li></ul><p>With these three columns we can already formulate some typical web analytics queries such as:</p><ul><li>&quot;What are the top 10 most clicked urls for a specific user?”</li><li>&quot;What are the top 10 users that most frequently clicked a specific URL?&quot;</li><li>“What are the most popular times (e.g. days of the week) at which a user clicks on a specific URL?”</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="test-machine">Test Machine<a href="#test-machine" class="hash-link" aria-label="Direct link to Test Machine" title="Direct link to Test Machine">​</a></h3><p>All runtime numbers given in this document are based on running ClickHouse 22.2.1 locally on a MacBook Pro with the Apple M1 Pro chip and 16GB of RAM.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="a-full-table-scan">A full table scan<a href="#a-full-table-scan" class="hash-link" aria-label="Direct link to A full table scan" title="Direct link to A full table scan">​</a></h3><p>In order to see how a query is executed over our data set without a primary key, we create a table (with a MergeTree table engine) by executing the following SQL DDL statement:</p><div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TABLE</span><span class="token plain"> hits_NoPrimaryKey</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token identifier">UserID</span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token plain"> UInt32</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token identifier">URL</span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token plain"> String</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token identifier">EventTime</span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">DateTime</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ENGINE</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> MergeTree</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">KEY</span><span class="token plain"> tuple</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Next insert a subset of the hits data set into the table with the following SQL insert statement.
This uses the <a href="/docs/en/sql-reference/table-functions/url">URL table function</a> in order to load a  subset of the full dataset hosted remotely at clickhouse.com:</p><div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">INTO</span><span class="token plain"> hits_NoPrimaryKey </span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">   intHash32</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">UserID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> UserID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">   URL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">   EventTime</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> url</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;https://datasets.clickhouse.com/hits/tsv/hits_v1.tsv.xz&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;TSV&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;WatchID UInt64,  JavaEnable UInt8,  Title String,  GoodEvent Int16,  EventTime DateTime,  EventDate Date,  CounterID UInt32,  ClientIP UInt32,  ClientIP6 FixedString(16),  RegionID UInt32,  UserID UInt64,  CounterClass Int8,  OS UInt8,  UserAgent UInt8,  URL String,  Referer String,  URLDomain String,  RefererDomain String,  Refresh UInt8,  IsRobot UInt8,  RefererCategories Array(UInt16),  URLCategories Array(UInt16), URLRegions Array(UInt32),  RefererRegions Array(UInt32),  ResolutionWidth UInt16,  ResolutionHeight UInt16,  ResolutionDepth UInt8,  FlashMajor UInt8, FlashMinor UInt8,  FlashMinor2 String,  NetMajor UInt8,  NetMinor UInt8, UserAgentMajor UInt16,  UserAgentMinor FixedString(2),  CookieEnable UInt8, JavascriptEnable UInt8,  IsMobile UInt8,  MobilePhone UInt8,  MobilePhoneModel String,  Params String,  IPNetworkID UInt32,  TraficSourceID Int8, SearchEngineID UInt16,  SearchPhrase String,  AdvEngineID UInt8,  IsArtifical UInt8,  WindowClientWidth UInt16,  WindowClientHeight UInt16,  ClientTimeZone Int16,  ClientEventTime DateTime,  SilverlightVersion1 UInt8, SilverlightVersion2 UInt8,  SilverlightVersion3 UInt32,  SilverlightVersion4 UInt16,  PageCharset String,  CodeVersion UInt32,  IsLink UInt8,  IsDownload UInt8,  IsNotBounce UInt8,  FUniqID UInt64,  HID UInt32,  IsOldCounter UInt8, IsEvent UInt8,  IsParameter UInt8,  DontCountHits UInt8,  WithHash UInt8, HitColor FixedString(1),  UTCEventTime DateTime,  Age UInt8,  Sex UInt8,  Income UInt8,  Interests UInt16,  Robotness UInt8,  GeneralInterests Array(UInt16), RemoteIP UInt32,  RemoteIP6 FixedString(16),  WindowName Int32,  OpenerName Int32,  HistoryLength Int16,  BrowserLanguage FixedString(2),  BrowserCountry FixedString(2),  SocialNetwork String,  SocialAction String,  HTTPError UInt16, SendTiming Int32,  DNSTiming Int32,  ConnectTiming Int32,  ResponseStartTiming Int32,  ResponseEndTiming Int32,  FetchTiming Int32,  RedirectTiming Int32, DOMInteractiveTiming Int32,  DOMContentLoadedTiming Int32,  DOMCompleteTiming Int32,  LoadEventStartTiming Int32,  LoadEventEndTiming Int32, NSToDOMContentLoadedTiming Int32,  FirstPaintTiming Int32,  RedirectCount Int8, SocialSourceNetworkID UInt8,  SocialSourcePage String,  ParamPrice Int64, ParamOrderID String,  ParamCurrency FixedString(3),  ParamCurrencyID UInt16, GoalsReached Array(UInt32),  OpenstatServiceName String,  OpenstatCampaignID String,  OpenstatAdID String,  OpenstatSourceID String,  UTMSource String, UTMMedium String,  UTMCampaign String,  UTMContent String,  UTMTerm String, FromTag String,  HasGCLID UInt8,  RefererHash UInt64,  URLHash UInt64,  CLID UInt32,  YCLID UInt64,  ShareService String,  ShareURL String,  ShareTitle String,  ParsedParams Nested(Key1 String,  Key2 String, Key3 String, Key4 String, Key5 String,  ValueDouble Float64),  IslandID FixedString(16),  RequestNum UInt32,  RequestTry UInt8&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> URL </span><span class="token operator" style="color:rgb(212, 212, 212)">!=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The response is:</p><div class="language-response codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-response codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">Ok.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">0 rows in set. Elapsed: 145.993 sec. Processed 8.87 million rows, 18.40 GB (60.78 thousand rows/s., 126.06 MB/s.)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ClickHouse client’s result output shows us that the statement above inserted 8.87 million rows into the table.</p><p>Lastly, in order to simplify the discussions later on in this guide and to make the diagrams and results reproducible, we <a href="/docs/en/sql-reference/statements/optimize">optimize</a> the table using the FINAL keyword:</p><div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">OPTIMIZE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TABLE</span><span class="token plain"> hits_NoPrimaryKey FINAL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_WoCw"><div class="alert-icon admonitionIcon_Ibzs"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></div><div class="alert-content admonitionContent_vXIg"><div class="admonitionHeading_TMsN">note</div><p>In general it is not required nor recommended to immediately optimize a table
after loading data into it. Why this is necessary for this example will become apparent.</p></div></div><p>Now we execute our first web analytics query. The following is calculating the top 10 most clicked urls for the internet user with the UserID 749927693:</p><div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> URL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">count</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">URL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> Count</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> hits_NoPrimaryKey</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> UserID </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">749927693</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> URL</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> Count </span><span class="token keyword" style="color:rgb(86, 156, 214)">DESC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">10</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The response is:</p><div class="language-response codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-response codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">┌─URL────────────────────────────┬─Count─┐</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ http://auto.ru/chatay-barana.. │   170 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ http://auto.ru/chatay-id=371...│    52 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ http://public_search           │    45 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ http://kovrik-medvedevushku-...│    36 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ http://forumal                 │    33 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ http://korablitz.ru/L_1OFFER...│    14 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ http://auto.ru/chatay-id=371...│    14 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ http://auto.ru/chatay-john-D...│    13 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ http://auto.ru/chatay-john-D...│    10 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ http://wot/html?page/23600_m...│     9 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">└────────────────────────────────┴───────┘</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">10 rows in set. Elapsed: 0.022 sec.</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#9CDCFE"><span class="token plain">Processed 8.87 million rows,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">70.45 MB (398.53 million rows/s., 3.17 GB/s.)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ClickHouse client’s result output indicates that ClickHouse executed a full table scan! Each single row of the 8.87 million rows of our table was streamed into ClickHouse. That doesn’t scale.</p><p>To make this (way) more efficient and (much) faster, we need to use a table with a appropriate primary key. This will allow ClickHouse to automatically (based on the primary key’s column(s)) create a sparse primary index which can then be used to significantly speed up the execution of our example query.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="related-content">Related content<a href="#related-content" class="hash-link" aria-label="Direct link to Related content" title="Direct link to Related content">​</a></h3><ul><li>Blog: <a href="https://clickhouse.com/blog/clickhouse-faster-queries-with-projections-and-primary-indexes" target="_blank" rel="noopener noreferrer">Super charging your ClickHouse queries</a></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="clickhouse-index-design">ClickHouse Index Design<a href="#clickhouse-index-design" class="hash-link" aria-label="Direct link to ClickHouse Index Design" title="Direct link to ClickHouse Index Design">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="an-index-design-for-massive-data-scales">An index design for massive data scales<a href="#an-index-design-for-massive-data-scales" class="hash-link" aria-label="Direct link to An index design for massive data scales" title="Direct link to An index design for massive data scales">​</a></h3><p>In traditional relational database management systems, the primary index would contain one entry per table row. For our data set this would result in the primary index - often a <a href="https://en.wikipedia.org/wiki/B%2B_tree" target="_blank" rel="noopener noreferrer">B(+)-Tree</a> data structure - containing 8.87 million entries. Such an index allows the fast location of specific rows, resulting in high efficiency for lookup queries and point updates. Searching an entry in a B(+)-Tree data structure has average time complexity of <code>O(log2 n)</code>. For a table of 8.87 million rows, this means 23 steps are required to locate any index entry. This capability comes at a cost: additional disk and memory overheads and higher insertion costs when adding new rows to the table and entries to the index (and also sometimes rebalancing of the B-Tree).</p><p>Considering the challenges associated with B-Tree indexes, table engines in ClickHouse utilise a different approach. The ClickHouse <a href="/docs/en/engines/table-engines/mergetree-family">MergeTree Engine Family</a> has been designed and optimized to handle massive data volumes. These tables are designed to receive millions of row inserts per second and store very large (100s of Petabytes) volumes of data. Data is quickly written to a table <a href="/docs/en/engines/table-engines/mergetree-family/mergetree#mergetree-data-storage">part by part</a>, with rules applied for merging the parts in the background. In ClickHouse each part has its own primary index. When parts are merged, then the merged part’s primary indexes are also merged. At the very large scale that ClickHouse is designed for, it is paramount to be very disk and memory efficient. Therefore, instead of indexing every row, the primary index for a part has one index entry (known as a ‘mark’) per group of rows (called ‘granule’) - this technique is called <strong>sparse index</strong>.</p><p>Sparse indexing is possible because ClickHouse is storing the rows for a part on disk ordered by the primary key column(s). Instead of directly locating single rows (like a B-Tree based index), the sparse primary index allows it to quickly (via a binary search over index entries) identify groups of rows that could possibly match the query. The located groups of potentially matching rows (granules) are then in parallel streamed into the ClickHouse engine in order to find the matches. This index design allows for the primary index to be small (it can, and must, completely fit into the main memory), whilst still significantly speeding up query execution times: especially for range queries that are typical in data analytics use cases.</p><p>The following illustrates in detail how ClickHouse is building and using its sparse primary index. Later on in the article, we will discuss some best practices for choosing, removing, and ordering the table columns that are used to build the index (primary key columns).</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="a-table-with-a-primary-key">A table with a primary key<a href="#a-table-with-a-primary-key" class="hash-link" aria-label="Direct link to A table with a primary key" title="Direct link to A table with a primary key">​</a></h3><p>Create a table that has a compound primary key with key columns UserID and URL:</p><div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TABLE</span><span class="token plain"> hits_UserID_URL</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token identifier">UserID</span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token plain"> UInt32</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token identifier">URL</span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token plain"> String</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token identifier">EventTime</span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">DateTime</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ENGINE</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> MergeTree</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">KEY</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">UserID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> URL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">UserID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> URL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> EventTime</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">SETTINGS index_granularity </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">8192</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> index_granularity_bytes </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><details class="details_lb9f alert alert--info details_r1OI" data-collapsed="true"><summary>DDL Statement Details</summary><div><div class="collapsibleContent_i85q"><p></p><p>In order to simplify the discussions later on in this guide, as well as  make the diagrams and results reproducible, the DDL statement</p><ul><li>specifies a compound sorting key for the table via an `ORDER BY` clause</li><br><li>explicitly controls how many index entries the primary index will have through the settings:</li><br><ul><li>`index_granularity: explicitly set to its default value of 8192. This means that for each group of 8192 rows, the primary index will have one index entry, e.g. if the table contains 16384 rows then the index will have two index entries.</li><br><li>`index_granularity_bytes`: set to 0 in order to disable <a href="https://clickhouse.com/docs/en/whats-new/changelog/2019/#experimental-features-1" target="_blank" rel="noopener noreferrer">adaptive index granularity</a>. Adaptive index granularity means that ClickHouse automatically creates one index entry for a group of n rows if either of these are true:<ul><li>if n is less than 8192 and the size of the combined row data for that n rows is larger than or equal to 10 MB (the default value for index_granularity_bytes) or</li><li>if the combined row data size for n rows is less than 10 MB but n is 8192.</li></ul></li></ul></ul><p></p></div></div></details><p>The primary key in the DDL statement above causes the creation of the primary index based on the two specified key columns.</p><br>Next insert the data:<div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">INTO</span><span class="token plain"> hits_UserID_URL </span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">   intHash32</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">UserID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> UserID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">   URL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">   EventTime</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> url</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;https://datasets.clickhouse.com/hits/tsv/hits_v1.tsv.xz&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;TSV&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;WatchID UInt64,  JavaEnable UInt8,  Title String,  GoodEvent Int16,  EventTime DateTime,  EventDate Date,  CounterID UInt32,  ClientIP UInt32,  ClientIP6 FixedString(16),  RegionID UInt32,  UserID UInt64,  CounterClass Int8,  OS UInt8,  UserAgent UInt8,  URL String,  Referer String,  URLDomain String,  RefererDomain String,  Refresh UInt8,  IsRobot UInt8,  RefererCategories Array(UInt16),  URLCategories Array(UInt16), URLRegions Array(UInt32),  RefererRegions Array(UInt32),  ResolutionWidth UInt16,  ResolutionHeight UInt16,  ResolutionDepth UInt8,  FlashMajor UInt8, FlashMinor UInt8,  FlashMinor2 String,  NetMajor UInt8,  NetMinor UInt8, UserAgentMajor UInt16,  UserAgentMinor FixedString(2),  CookieEnable UInt8, JavascriptEnable UInt8,  IsMobile UInt8,  MobilePhone UInt8,  MobilePhoneModel String,  Params String,  IPNetworkID UInt32,  TraficSourceID Int8, SearchEngineID UInt16,  SearchPhrase String,  AdvEngineID UInt8,  IsArtifical UInt8,  WindowClientWidth UInt16,  WindowClientHeight UInt16,  ClientTimeZone Int16,  ClientEventTime DateTime,  SilverlightVersion1 UInt8, SilverlightVersion2 UInt8,  SilverlightVersion3 UInt32,  SilverlightVersion4 UInt16,  PageCharset String,  CodeVersion UInt32,  IsLink UInt8,  IsDownload UInt8,  IsNotBounce UInt8,  FUniqID UInt64,  HID UInt32,  IsOldCounter UInt8, IsEvent UInt8,  IsParameter UInt8,  DontCountHits UInt8,  WithHash UInt8, HitColor FixedString(1),  UTCEventTime DateTime,  Age UInt8,  Sex UInt8,  Income UInt8,  Interests UInt16,  Robotness UInt8,  GeneralInterests Array(UInt16), RemoteIP UInt32,  RemoteIP6 FixedString(16),  WindowName Int32,  OpenerName Int32,  HistoryLength Int16,  BrowserLanguage FixedString(2),  BrowserCountry FixedString(2),  SocialNetwork String,  SocialAction String,  HTTPError UInt16, SendTiming Int32,  DNSTiming Int32,  ConnectTiming Int32,  ResponseStartTiming Int32,  ResponseEndTiming Int32,  FetchTiming Int32,  RedirectTiming Int32, DOMInteractiveTiming Int32,  DOMContentLoadedTiming Int32,  DOMCompleteTiming Int32,  LoadEventStartTiming Int32,  LoadEventEndTiming Int32, NSToDOMContentLoadedTiming Int32,  FirstPaintTiming Int32,  RedirectCount Int8, SocialSourceNetworkID UInt8,  SocialSourcePage String,  ParamPrice Int64, ParamOrderID String,  ParamCurrency FixedString(3),  ParamCurrencyID UInt16, GoalsReached Array(UInt32),  OpenstatServiceName String,  OpenstatCampaignID String,  OpenstatAdID String,  OpenstatSourceID String,  UTMSource String, UTMMedium String,  UTMCampaign String,  UTMContent String,  UTMTerm String, FromTag String,  HasGCLID UInt8,  RefererHash UInt64,  URLHash UInt64,  CLID UInt32,  YCLID UInt64,  ShareService String,  ShareURL String,  ShareTitle String,  ParsedParams Nested(Key1 String,  Key2 String, Key3 String, Key4 String, Key5 String,  ValueDouble Float64),  IslandID FixedString(16),  RequestNum UInt32,  RequestTry UInt8&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> URL </span><span class="token operator" style="color:rgb(212, 212, 212)">!=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The response looks like:</p><div class="language-response codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-response codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">0 rows in set. Elapsed: 149.432 sec. Processed 8.87 million rows, 18.40 GB (59.38 thousand rows/s., 123.16 MB/s.)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><br>And optimize the table:<div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">OPTIMIZE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TABLE</span><span class="token plain"> hits_UserID_URL FINAL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><br>We can use the following query to obtain metadata about our table:<div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    part_type</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    formatReadableQuantity</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">rows</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">rows</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    formatReadableSize</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">data_uncompressed_bytes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> data_uncompressed_bytes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    formatReadableSize</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">data_compressed_bytes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> data_compressed_bytes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    formatReadableSize</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">primary_key_bytes_in_memory</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> primary_key_bytes_in_memory</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    marks</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    formatReadableSize</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">bytes_on_disk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> bytes_on_disk</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> system</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">parts</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">table</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;hits_UserID_URL&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">AND</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">active </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">FORMAT Vertical</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The response is:</p><div class="language-response codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-response codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">part_type:                   Wide</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">path:                        ./store/d9f/d9f36a1a-d2e6-46d4-8fb5-ffe9ad0d5aed/all_1_9_2/</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">rows:                        8.87 million</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">data_uncompressed_bytes:     733.28 MiB</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">data_compressed_bytes:       206.94 MiB</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">primary_key_bytes_in_memory: 96.93 KiB</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">marks:                       1083</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">bytes_on_disk:               207.07 MiB</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">1 rows in set. Elapsed: 0.003 sec.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The output of the ClickHouse client shows:</p><ul><li>The table’s data is stored in <a href="/docs/en/engines/table-engines/mergetree-family/mergetree#mergetree-data-storage">wide format</a> in a specific directory on disk meaning that there will be one data file (and one mark file) per table column inside that directory.</li><li>The table has 8.87 million rows.</li><li>The uncompressed data size of all rows together is 733.28 MB.</li><li>The compressed size on disk of all rows together is 206.94 MB.</li><li>The table has a primary index with 1083 entries (called ‘marks’) and the size of the index is 96.93 KB.</li><li>In total, the table’s data and mark files and primary index file together take 207.07 MB on disk.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="data-is-stored-on-disk-ordered-by-primary-key-columns">Data is stored on disk ordered by primary key column(s)<a href="#data-is-stored-on-disk-ordered-by-primary-key-columns" class="hash-link" aria-label="Direct link to Data is stored on disk ordered by primary key column(s)" title="Direct link to Data is stored on disk ordered by primary key column(s)">​</a></h3><p>Our table that we created above has</p><ul><li>a compound <a href="/docs/en/engines/table-engines/mergetree-family/mergetree#primary-keys-and-indexes-in-queries">primary key</a> <code>(UserID, URL)</code> and</li><li>a compound <a href="/docs/en/engines/table-engines/mergetree-family/mergetree#choosing-a-primary-key-that-differs-from-the-sorting-key">sorting key</a> <code>(UserID, URL, EventTime)</code>.</li></ul><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_WoCw"><div class="alert-icon admonitionIcon_Ibzs"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></div><div class="alert-content admonitionContent_vXIg"><div class="admonitionHeading_TMsN">note</div><ul><li><p>If we would have specified only the sorting key, then the primary key would be implicitly defined to be equal to the sorting key.</p></li><li><p>In order to be memory efficient we explicitly specified a primary key that only contains columns that our queries are filtering on. The primary index that is based on the primary key is completely loaded into the main memory.</p></li><li><p>In order to have consistency in the guide’s diagrams and in order to maximise compression ratio we defined a separate sorting key that includes all of our table&#x27;s columns (if in a column similar data is placed close to each other, for example via sorting, then that data will be compressed better).</p></li><li><p>The primary key needs to be a prefix of the sorting key if both are specified.</p></li></ul></div></div><p>The inserted rows are stored on disk in lexicographical order (ascending) by the primary key columns (and the additional EventTime column from the sorting key).</p><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_WoCw"><div class="alert-icon admonitionIcon_Ibzs"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></div><div class="alert-content admonitionContent_vXIg"><div class="admonitionHeading_TMsN">note</div><p>ClickHouse allows inserting multiple rows with identical primary key column values. In this case (see row 1 and row 2 in the diagram below), the final order is determined by the specified sorting key and therefore the value of the <code>EventTime</code> column.</p></div></div><p>ClickHouse is a <a href="https://clickhouse.com/docs/en/introduction/distinctive-features/#true-column-oriented-dbms" target="_blank" rel="noopener noreferrer">column-oriented database management system</a>. As shown in the diagram below</p><ul><li>for the on disk representation, there is a single data file (*.bin) per table column where all the values for that column are stored in a <a href="https://clickhouse.com/docs/en/introduction/distinctive-features/#data-compression" target="_blank" rel="noopener noreferrer">compressed</a> format, and</li><li>the 8.87 million rows are stored on disk in lexicographic ascending order by the primary key columns (and the additional sort key columns) i.e. in this case<ul><li>first by <code>UserID</code>,</li><li>then by <code>URL</code>,</li><li>and lastly by <code>EventTime</code>:</li></ul></li></ul><img loading="lazy" src="/docs/assets/images/sparse-primary-indexes-01-cc9409cc279f3a74cb498d158ef7c95e.png" class="image" class="img_ev3q">UserID.bin, URL.bin, and EventTime.bin are the data files on disk where the values of the `UserID`, `URL`, and `EventTime` columns are stored.<br><br><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_WoCw"><div class="alert-icon admonitionIcon_Ibzs"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></div><div class="alert-content admonitionContent_vXIg"><div class="admonitionHeading_TMsN">note</div><ul><li><p>As the primary key defines the lexicographical order of the rows on disk, a table can only have one primary key.</p></li><li><p>We are numbering rows starting with 0 in order to be aligned with the ClickHouse internal row numbering scheme that is also used for logging messages.</p></li></ul></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="data-is-organized-into-granules-for-parallel-data-processing">Data is organized into granules for parallel data processing<a href="#data-is-organized-into-granules-for-parallel-data-processing" class="hash-link" aria-label="Direct link to Data is organized into granules for parallel data processing" title="Direct link to Data is organized into granules for parallel data processing">​</a></h3><p>For data processing purposes, a table&#x27;s column values are logically divided into granules.
A granule is the smallest indivisible data set that is streamed into ClickHouse for data processing.
This means that instead of reading individual rows, ClickHouse is always reading (in a streaming fashion and in parallel) a whole group (granule) of rows.</p><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_WoCw"><div class="alert-icon admonitionIcon_Ibzs"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></div><div class="alert-content admonitionContent_vXIg"><div class="admonitionHeading_TMsN">note</div><p>Column values are not physically stored inside granules: granules are just a logical organization of the column values for query processing.</p></div></div><p>The following diagram shows how the (column values of) 8.87 million rows of our table
are organized into 1083 granules, as a result of the table&#x27;s DDL statement containing the setting <code>index_granularity</code> (set to its default value of 8192).</p><img loading="lazy" src="/docs/assets/images/sparse-primary-indexes-02-f6b524b73c2747c0c26aaf8a8a06a89e.png" class="image" class="img_ev3q"><p>The first (based on physical order on disk) 8192 rows (their column values) logically belong to granule 0, then the next 8192 rows (their column values) belong to granule 1 and so on.</p><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_WoCw"><div class="alert-icon admonitionIcon_Ibzs"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></div><div class="alert-content admonitionContent_vXIg"><div class="admonitionHeading_TMsN">note</div><ul><li><p>The last granule (granule 1082) &quot;contains&quot; less than 8192 rows.</p></li><li><p>We mentioned in the beginning of this guide in the &quot;DDL Statement Details&quot;, that we disabled <a href="/docs/en/whats-new/changelog/2019#experimental-features-1">adaptive index granularity</a> (in order to simplify the discussions in this guide, as well as make the diagrams and results reproducible).</p><p>Therefore all granules (except the last one) of our example table have the same size.</p></li><li><p>For tables with adaptive index granularity (index granularity is adaptive by <a href="/docs/en/engines/table-engines/mergetree-family/mergetree#index_granularity_bytes">default</a>) the size of some granules can be less than 8192 rows depending on the row data sizes.</p></li></ul><ul><li><p>We marked some column values from our primary key columns (<code>UserID</code>, <code>URL</code>) in orange.
These orange-marked column values are the primary key column values of each first row of each granule.
As we will see below, these orange-marked column values will be the entries in the table&#x27;s primary index.</p></li><li><p>We are numbering granules starting with 0 in order to be aligned with the ClickHouse internal numbering scheme that is also used for logging messages.</p></li></ul></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-primary-index-has-one-entry-per-granule">The primary index has one entry per granule<a href="#the-primary-index-has-one-entry-per-granule" class="hash-link" aria-label="Direct link to The primary index has one entry per granule" title="Direct link to The primary index has one entry per granule">​</a></h3><p>The primary index is created based on the granules shown in the diagram above. This index is an uncompressed flat array file (primary.idx), containing so-called numerical index marks starting at 0.</p><p>The diagram below shows that the index stores the primary key column values (the values marked in orange in the diagram above) for each first row for each granule.
Or in other words: the primary index stores the primary key column values from each 8192nd row of the table (based on the physical row order defined by the primary key columns).
For example</p><ul><li>the first index entry (‘mark 0’ in the diagram below) is storing the key column values of the first row of granule 0 from the diagram above,</li><li>the second index entry (‘mark 1’ in the diagram below) is storing the key column values of the first row of granule 1 from the diagram above, and so on.</li></ul><img loading="lazy" src="/docs/assets/images/sparse-primary-indexes-03a-3ce2298f3ae8d3577ad662796ed7de5c.png" class="image" class="img_ev3q"><p>In total the index has 1083 entries for our table with 8.87 million rows and 1083 granules:</p><img loading="lazy" src="/docs/assets/images/sparse-primary-indexes-03b-269cbb9a4febef2ad4e1e6a821fcbc11.png" class="image" class="img_ev3q"><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_WoCw"><div class="alert-icon admonitionIcon_Ibzs"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></div><div class="alert-content admonitionContent_vXIg"><div class="admonitionHeading_TMsN">note</div><ul><li><p>For tables with <a href="/docs/en/whats-new/changelog/2019#experimental-features-1">adaptive index granularity</a>, there is also one &quot;final&quot; additional mark stored in the primary index that records the values of the primary key columns of the last table row, but because we disabled adaptive index granularity (in order to simplify the discussions in this guide, as well as make the diagrams and results reproducible), the index of our example table doesn&#x27;t include this final mark.</p></li><li><p>The primary index file is completely loaded into the main memory. If the file is larger than the available free memory space then ClickHouse will raise an error.</p></li></ul></div></div><details class="details_lb9f alert alert--info details_r1OI" data-collapsed="true"><summary>Inspecting the content of the primary index</summary><div><div class="collapsibleContent_i85q"><p></p><p>On a self-managed ClickHouse cluster we can use the <a href="https://clickhouse.com/docs/en/sql-reference/table-functions/file/" target="_blank" rel="noopener noreferrer">file table function</a> for inspecting the content of the primary index of our example table.</p><p>For that we first need to copy the primary index file into the <a href="https://clickhouse.com/docs/en/operations/server-configuration-parameters/settings/#server_configuration_parameters-user_files_path" target="_blank" rel="noopener noreferrer">user_files_path</a> of a node from the running cluster:</p><ul><li>Step 1: Get part-path that contains the primary index file</li>` SELECT path FROM system.parts WHERE table = &#x27;hits_UserID_URL&#x27; AND active = 1 `<p>returns <code>/Users/tomschreiber/Clickhouse/store/85f/85f4ee68-6e28-4f08-98b1-7d8affa1d88c/all_1_9_4</code> on the test machine.</p><li>Step 2: Get user_files_path</li>The <a href="https://github.com/ClickHouse/ClickHouse/blob/22.12/programs/server/config.xml#L505" target="_blank" rel="noopener noreferrer">default user_files_path</a> on Linux is `/var/lib/clickhouse/user_files/`<p>and on Linux you can check if it got changed: <code>$ grep user_files_path /etc/clickhouse-server/config.xml</code></p><p>On the test machine the path is <code>/Users/tomschreiber/Clickhouse/user_files/</code></p><li>Step 3: Copy the primary index file into the user_files_path</li>` cp /Users/tomschreiber/Clickhouse/store/85f/85f4ee68-6e28-4f08-98b1-7d8affa1d88c/all_1_9_4/primary.idx /Users/tomschreiber/Clickhouse/user_files/primary-hits_UserID_URL.idx `<br></ul><p>Now we can inspect the content of the primary index via SQL:</p><ul><li>Get amount of entries</li>` SELECT count( )<br>FROM file(&#x27;primary-hits_UserID_URL.idx&#x27;, &#x27;RowBinary&#x27;, &#x27;UserID UInt32, URL String&#x27;); `<br><br>returns `1083`<br><br><li>Get first two index marks</li>` SELECT UserID, URL<br>FROM file(&#x27;primary-hits_UserID_URL.idx&#x27;, &#x27;RowBinary&#x27;, &#x27;UserID UInt32, URL String&#x27;)<br>LIMIT 0, 2; `<br><br>returns<br>` 240923, http://showtopics.html%3...<br>4073710, http://mk.ru&amp;pos=3_0 `<br><br><li>Get last index mark</li>` SELECT UserID, URL<br>FROM file(&#x27;primary-hits_UserID_URL.idx&#x27;, &#x27;RowBinary&#x27;, &#x27;UserID UInt32, URL String&#x27;)<br>LIMIT 1082, 1; `<br><br>returns<br>` 4292714039 │ http://sosyal-mansetleri... `</ul><p>This matches exactly our diagram of the primary index content for our example table:</p><img loading="lazy" src="/docs/assets/images/sparse-primary-indexes-03b-269cbb9a4febef2ad4e1e6a821fcbc11.png" class="image" class="img_ev3q"><p></p></div></div></details><p>The primary key entries are called index marks because each index entry is marking the start of a specific data range. Specifically for the example table:</p><ul><li><p>UserID index marks:<br>
The stored <code>UserID</code> values in the primary index are sorted in ascending order.<br>
‘mark 1’ in the diagram above thus indicates that the <code>UserID</code> values of all table rows in granule 1, and in all following granules, are guaranteed to be greater than or equal to 4.073.710.</p><p><a href="#the-primary-index-is-used-for-selecting-granules">As we will see later</a>, this global order enables ClickHouse to <a href="https://github.com/ClickHouse/ClickHouse/blob/22.3/src/Storages/MergeTree/MergeTreeDataSelectExecutor.cpp#L1452" target="_blank" rel="noopener noreferrer">use a binary search algorithm</a> over the index marks for the first key column when a query is filtering on the first column of the primary key.</p></li><li><p>URL index marks:<br>
The quite similar cardinality of the primary key columns <code>UserID</code> and <code>URL</code>
means that the index marks for all key columns after the first column in general only indicate a data range as long as the predecessor key column value stays the same for all table rows within at least the current granule.<br>
For example, because the UserID values of mark 0 and mark 1 are different in the diagram above, ClickHouse can&#x27;t assume that all URL values of all table rows in granule 0 are larger or equal to <code>&#x27;http://showtopics.html%3...&#x27;</code>. However, if the UserID values of mark 0 and mark 1 would be the same in the diagram above (meaning that the UserID value stays the same for all table rows within the granule 0), the ClickHouse could assume that all URL values of all table rows in granule 0 are larger or equal to <code>&#x27;http://showtopics.html%3...&#x27;</code>.</p><p> We will discuss the consequences of this on query execution performance in more detail later.</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-primary-index-is-used-for-selecting-granules">The primary index is used for selecting granules<a href="#the-primary-index-is-used-for-selecting-granules" class="hash-link" aria-label="Direct link to The primary index is used for selecting granules" title="Direct link to The primary index is used for selecting granules">​</a></h3><p>We can now execute our queries with support from the primary index.</p><p>The following calculates the top 10 most clicked urls for the UserID 749927693.</p><div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> URL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">count</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">URL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> Count</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> hits_UserID_URL</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> UserID </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">749927693</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> URL</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> Count </span><span class="token keyword" style="color:rgb(86, 156, 214)">DESC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">10</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The response is:</p><div class="language-response codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-response codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">┌─URL────────────────────────────┬─Count─┐</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ http://auto.ru/chatay-barana.. │   170 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ http://auto.ru/chatay-id=371...│    52 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ http://public_search           │    45 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ http://kovrik-medvedevushku-...│    36 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ http://forumal                 │    33 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ http://korablitz.ru/L_1OFFER...│    14 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ http://auto.ru/chatay-id=371...│    14 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ http://auto.ru/chatay-john-D...│    13 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ http://auto.ru/chatay-john-D...│    10 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ http://wot/html?page/23600_m...│     9 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">└────────────────────────────────┴───────┘</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">10 rows in set. Elapsed: 0.005 sec.</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#9CDCFE"><span class="token plain">Processed 8.19 thousand rows,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">740.18 KB (1.53 million rows/s., 138.59 MB/s.)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The output for the ClickHouse client is now showing that instead of doing a full table scan, only 8.19 thousand rows were streamed into ClickHouse.</p><p>If <a href="https://clickhouse.com/docs/en/operations/server-configuration-parameters/settings/#server_configuration_parameters-logger" target="_blank" rel="noopener noreferrer">trace logging</a> is enabled then the ClickHouse server log file shows that ClickHouse was running a <a href="https://github.com/ClickHouse/ClickHouse/blob/22.3/src/Storages/MergeTree/MergeTreeDataSelectExecutor.cpp#L1452" target="_blank" rel="noopener noreferrer">binary search</a> over the 1083 UserID index marks, in order to identify granules that possibly can contain rows with a UserID column value of <code>749927693</code>. This requires 19 steps with an average time complexity of <code>O(log2 n)</code>:</p><div class="language-response codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-response codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">...Executor): Key condition: (column 0 in [749927693, 749927693])</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#9CDCFE"><span class="token plain">...Executor): Running binary search on index range for part all_1_9_2 (1083 marks)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">...Executor): Found (LEFT) boundary mark: 176</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">...Executor): Found (RIGHT) boundary mark: 177</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">...Executor): Found continuous range in 19 steps</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">...Executor): Selected 1/1 parts by partition key, 1 parts by primary key,</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#9CDCFE"><span class="token plain">              1/1083 marks by primary key, 1 marks to read from 1 ranges</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">...Reading ...approx. 8192 rows starting from 1441792</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can see in the trace log above, that one mark out of the 1083 existing marks satisfied the query.</p><details class="details_lb9f alert alert--info details_r1OI" data-collapsed="true"><summary>Trace Log Details</summary><div><div class="collapsibleContent_i85q"><p></p><p>Mark 176 was identified (the &#x27;found left boundary mark&#x27; is inclusive, the &#x27;found right boundary mark&#x27; is exclusive), and therefore all 8192 rows from granule 176 (which starts at row 1.441.792 - we will see that later on in this guide) are then streamed into ClickHouse in order to find the actual rows with a UserID column value of <code>749927693</code>.</p><p></p></div></div></details><p>We can also reproduce this by using the <a href="https://clickhouse.com/docs/en/sql-reference/statements/explain/" target="_blank" rel="noopener noreferrer">EXPLAIN clause</a> in our example query:</p><div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">EXPLAIN</span><span class="token plain"> indexes </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> URL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">count</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">URL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> Count</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> hits_UserID_URL</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> UserID </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">749927693</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> URL</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> Count </span><span class="token keyword" style="color:rgb(86, 156, 214)">DESC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">10</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The response looks like:</p><div class="language-response codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-response codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">┌─explain───────────────────────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ Expression (Projection)                                                               │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│   Limit (preliminary LIMIT (without OFFSET))                                          │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│     Sorting (Sorting for ORDER BY)                                                    │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│       Expression (Before ORDER BY)                                                    │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│         Aggregating                                                                   │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│           Expression (Before GROUP BY)                                                │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│             Filter (WHERE)                                                            │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│               SettingQuotaAndLimits (Set limits and quota after reading from storage) │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│                 ReadFromMergeTree                                                     │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│                 Indexes:                                                              │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│                   PrimaryKey                                                          │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│                     Keys:                                                             │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│                       UserID                                                          │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│                     Condition: (UserID in [749927693, 749927693])                     │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│                     Parts: 1/1                                                        │</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#9CDCFE"><span class="token plain">│                     Granules: 1/1083                                                  │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">└───────────────────────────────────────────────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">16 rows in set. Elapsed: 0.003 sec.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The client output is showing that one out of the 1083 granules was selected as possibly containing rows with a UserID column value of 749927693.</p><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_WoCw"><div class="alert-icon admonitionIcon_Ibzs"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></div><div class="alert-content admonitionContent_vXIg"><div class="admonitionHeading_TMsN">Conclusion</div><p>When a query is filtering on a column that is part of a compound key and is the first key column, then ClickHouse is running the binary search algorithm over the key column&#x27;s index marks.</p></div></div><br><p>As discussed above, ClickHouse is using its sparse primary index for quickly (via binary search) selecting granules that could possibly contain rows that match a query.</p><p>This is the <strong>first stage (granule selection)</strong> of ClickHouse query execution.</p><p>In the <strong>second stage (data reading)</strong>, ClickHouse is locating the selected granules in order to stream all their rows into the ClickHouse engine in order to find the rows that are actually matching the query.</p><p>We discuss that second stage in more detail in the following section.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="mark-files-are-used-for-locating-granules">Mark files are used for locating granules<a href="#mark-files-are-used-for-locating-granules" class="hash-link" aria-label="Direct link to Mark files are used for locating granules" title="Direct link to Mark files are used for locating granules">​</a></h3><p>The following diagram illustrates a part of the primary index file for our table.</p><img loading="lazy" src="/docs/assets/images/sparse-primary-indexes-04-404eeaadb2a222c2a7fca9827bcfda4a.png" class="image" class="img_ev3q"><p>As discussed above, via a binary search over the index’s 1083 UserID marks, mark 176 was identified. Its corresponding granule 176 can therefore possibly contain rows with a UserID column value of 749.927.693.</p><details class="details_lb9f alert alert--info details_r1OI" data-collapsed="true"><summary>Granule Selection Details</summary><div><div class="collapsibleContent_i85q"><p></p><p>The diagram above shows that mark 176 is the first index entry where both the minimum UserID value of the associated granule 176 is smaller than 749.927.693, and the minimum UserID value of granule 177 for the next mark (mark 177) is greater than this value. Therefore only the corresponding granule 176 for mark 176 can possibly contain rows with a UserID column value of 749.927.693.</p><p></p></div></div></details><p>In order to confirm (or not) that some row(s) in granule 176 contain a UserID column value of 749.927.693, all 8192 rows belonging to this granule need to be streamed into ClickHouse.</p><p>To achieve this, ClickHouse needs to know the physical location of granule 176.</p><p>In ClickHouse the physical locations of all granules for our table are stored in mark files. Similar to data files, there is one mark file per table column.</p><p>The following diagram shows the three mark files UserID.mrk, URL.mrk, and EventTime.mrk that store the physical locations of the granules for the table’s UserID, URL, and EventTime columns.</p><img loading="lazy" src="/docs/assets/images/sparse-primary-indexes-05-02e2356da8eb292a54513b2f587cfaf6.png" class="image" class="img_ev3q"><p>We have discussed how the primary index is a flat uncompressed array file (primary.idx), containing index marks that are numbered starting at 0.</p><p>Similarly, a mark file is also a flat uncompressed array file (*.mrk) containing marks that are numbered starting at 0.</p><p>Once ClickHouse has identified and selected the index mark for a granule that can possibly contain matching rows for a query, a positional array lookup can be performed in the mark files in order to obtain the physical locations of the granule.</p><p>Each mark file entry for a specific column is storing two locations in the form of offsets:</p><ul><li><p>The first offset (&#x27;block_offset&#x27; in the diagram above) is locating the <a href="https://clickhouse.com/docs/en/development/architecture/#block" target="_blank" rel="noopener noreferrer">block</a> in the <a href="https://clickhouse.com/docs/en/introduction/distinctive-features/#data-compression" target="_blank" rel="noopener noreferrer">compressed</a> column data file that contains the compressed version of the selected granule. This compressed block potentially contains a few compressed granules. The located compressed file block is uncompressed into the main memory on read.</p></li><li><p>The second offset (&#x27;granule_offset&#x27; in the diagram above) from the mark-file provides the location of the granule within the uncompressed block data.</p></li></ul><p>All the 8192 rows belonging to the located uncompressed granule are then streamed into ClickHouse for further processing.</p><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_WoCw"><div class="alert-icon admonitionIcon_Ibzs"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></div><div class="alert-content admonitionContent_vXIg"><div class="admonitionHeading_TMsN">note</div><ul><li><p>For tables with <a href="/docs/en/engines/table-engines/mergetree-family/mergetree#mergetree-data-storage">wide format</a> and without <a href="/docs/en/whats-new/changelog/2019#experimental-features-1">adaptive index granularity</a>, ClickHouse uses <code>.mrk</code> mark files as visualised above, that contain entries with two 8 byte long addresses per entry. These entries are physical locations of granules that all have the same size.</p><p>Index granularity is adaptive by <a href="/docs/en/engines/table-engines/mergetree-family/mergetree#index_granularity_bytes">default</a>, but for our example table we disabled adaptive index granularity (in order to simplify the discussions in this guide, as well as make the diagrams and results reproducible). Our table is using wide format because the size of the data is larger than <a href="/docs/en/engines/table-engines/mergetree-family/mergetree#min_bytes_for_wide_part">min_bytes_for_wide_part</a> (which is 10 MB by default for self-managed clusters).</p></li><li><p>For tables with wide format and with adaptive index granularity, ClickHouse uses <code>.mrk2</code> mark files, that contain similar entries to <code>.mrk</code> mark files but with an additional third value per entry: the number of rows of the granule that the current entry is associated with.</p></li><li><p>For tables with <a href="/docs/en/engines/table-engines/mergetree-family/mergetree#mergetree-data-storage">compact format</a>, ClickHouse uses <code>.mrk3</code> mark files.</p></li></ul></div></div><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_WoCw"><div class="alert-icon admonitionIcon_Ibzs"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></div><div class="alert-content admonitionContent_vXIg"><div class="admonitionHeading_TMsN">Why Mark Files</div><p>Why does the primary index not directly contain the physical locations of the granules that are corresponding to index marks?</p><p>Because at that very large scale that ClickHouse is designed for, it is important to be very disk and memory efficient.</p><p>The primary index file needs to fit into the main memory.</p><p>For our example query, ClickHouse used the primary index and selected a single granule that can possibly contain rows matching our query. Only for that one granule does ClickHouse then need the physical locations in order to stream the corresponding rows for further processing.</p><p>Furthermore, this offset information is only needed for the UserID and URL columns.</p><p>Offset information is not needed for columns that are not used in the query e.g. the EventTime.</p><p>For our sample query, ClickHouse needs only the two physical location offsets for granule 176 in the UserID data file (UserID.bin) and the two physical location offsets for granule 176 in the URL data file (URL.bin).</p><p>The indirection provided by mark files avoids storing, directly within the primary index, entries for the physical locations of all 1083 granules for all three columns: thus avoiding having unnecessary (potentially unused) data in main memory.</p></div></div><p>The following diagram and the text below illustrate how for our example query ClickHouse locates granule 176 in the UserID.bin data file.</p><img loading="lazy" src="/docs/assets/images/sparse-primary-indexes-06-8c596fa6d0425def7d7389acc954a63e.png" class="image" class="img_ev3q"><p>We discussed earlier in this guide that ClickHouse selected the primary index mark 176 and therefore granule 176 as possibly containing matching rows for our query.</p><p>ClickHouse now uses the selected mark number (176) from the index for a positional array lookup in the UserID.mrk mark file in order to get the two offsets for locating granule 176.</p><p>As shown, the first offset is locating the compressed file block within the UserID.bin data file that in turn contains the compressed version of granule 176.</p><p>Once the located file block is uncompressed into the main memory, the second offset from the mark file can be used to locate granule 176 within the uncompressed data.</p><p>ClickHouse needs to locate (and stream all values from) granule 176 from both the UserID.bin data file and the URL.bin data file in order to execute our example query (top 10 most clicked URLs for the internet user with the UserID 749.927.693).</p><p>The diagram above shows how ClickHouse is locating the granule for the UserID.bin data file.</p><p>In parallel, ClickHouse is doing the same for granule 176 for the URL.bin data file. The two respective granules are aligned and streamed into the ClickHouse engine for further processing i.e. aggregating and counting the URL values per group for all rows where the UserID is 749.927.693, before finally outputting the 10 largest URL groups in descending count order.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="using-multiple-primary-indexes">Using multiple primary indexes<a href="#using-multiple-primary-indexes" class="hash-link" aria-label="Direct link to Using multiple primary indexes" title="Direct link to Using multiple primary indexes">​</a></h2><a name="filtering-on-key-columns-after-the-first"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="secondary-key-columns-can-not-be-inefficient">Secondary key columns can (not) be inefficient<a href="#secondary-key-columns-can-not-be-inefficient" class="hash-link" aria-label="Direct link to Secondary key columns can (not) be inefficient" title="Direct link to Secondary key columns can (not) be inefficient">​</a></h3><p>When a query is filtering on a column that is part of a compound key and is the first key column, <a href="#the-primary-index-is-used-for-selecting-granules">then ClickHouse is running the binary search algorithm over the key column&#x27;s index marks</a>.</p><p>But what happens when a query is filtering on a column that is part of a compound key, but is not the first key column?</p><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_WoCw"><div class="alert-icon admonitionIcon_Ibzs"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></div><div class="alert-content admonitionContent_vXIg"><div class="admonitionHeading_TMsN">note</div><p>We discuss a scenario when a query is explicitly not filtering on the first key colum, but on a secondary key column.</p><p>When a query is filtering on both the first key column and on any key column(s) after the first then ClickHouse is running binary search over the first key column&#x27;s index marks.</p></div></div><br><br><a name="query-on-url"></a>We use a query that calculates the top 10 users that have most frequently clicked on the URL &quot;http://public_search&quot;:<div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> UserID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">count</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">UserID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> Count</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> hits_UserID_URL</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> URL </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;http://public_search&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> UserID</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> Count </span><span class="token keyword" style="color:rgb(86, 156, 214)">DESC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">10</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The response is: <a name="query-on-url-slow"></a></p><div class="language-response codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-response codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">┌─────UserID─┬─Count─┐</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ 2459550954 │  3741 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ 1084649151 │  2484 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│  723361875 │   729 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ 3087145896 │   695 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ 2754931092 │   672 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ 1509037307 │   582 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ 3085460200 │   573 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ 2454360090 │   556 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ 3884990840 │   539 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│  765730816 │   536 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">└────────────┴───────┘</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">10 rows in set. Elapsed: 0.086 sec.</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#9CDCFE"><span class="token plain">Processed 8.81 million rows,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">799.69 MB (102.11 million rows/s., 9.27 GB/s.)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The client output indicates that ClickHouse almost executed a full table scan despite the <a href="#a-table-with-a-primary-key">URL column being part of the compound primary key</a>! ClickHouse reads 8.81 million rows from the 8.87 million rows of the table.</p><p>If <a href="/docs/en/operations/server-configuration-parameters/settings#server_configuration_parameters-logger">trace_logging</a> is enabled then the ClickHouse server log file shows that ClickHouse used a <a href="https://github.com/ClickHouse/ClickHouse/blob/22.3/src/Storages/MergeTree/MergeTreeDataSelectExecutor.cpp#L1444" target="_blank" rel="noopener noreferrer">generic exclusion search</a> over the 1083 URL index marks in order to identify those granules that possibly can contain rows with a URL column value of &quot;http://public_search&quot;:</p><div class="language-response codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-response codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">...Executor): Key condition: (column 1 in [&#x27;http://public_search&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                                           &#x27;http://public_search&#x27;])</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#9CDCFE"><span class="token plain">...Executor): Used generic exclusion search over index for part all_1_9_2</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">              with 1537 steps</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">...Executor): Selected 1/1 parts by partition key, 1 parts by primary key,</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#9CDCFE"><span class="token plain">              1076/1083 marks by primary key, 1076 marks to read from 5 ranges</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">...Executor): Reading approx. 8814592 rows with 10 streams</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can see in the sample trace log above, that 1076 (via the marks) out of 1083 granules were selected as possibly containing rows with a matching URL value.</p><p>This results in 8.81 million rows being streamed into the ClickHouse engine (in parallel by using 10 streams), in order to identify the rows that are actually contain the URL value &quot;http://public_search&quot;.</p><p>However, <a href="#query-on-url-fast">as we will see later</a> only 39 granules out of that selected 1076 granules actually contain matching rows.</p><p>Whilst the primary index based on the compound primary key (UserID, URL) was very useful for speeding up queries filtering for rows with a specific UserID value, the index is not providing significant help with speeding up the query that filters for rows with a specific URL value.</p><p>The reason for this is that the URL column is not the first key column and therefore ClickHouse is using a generic exclusion search algorithm (instead of binary search) over the URL column&#x27;s index marks, and <strong>the effectiveness of that algorithm is dependant on the cardinality difference</strong> between the URL column and it&#x27;s predecessor key column UserID.</p><p>In order to illustrate that, we give some details about how the generic exclusion search works.</p><a name="generic-exclusion-search-algorithm"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="generic-exclusion-search-algorithm">Generic exclusion search algorithm<a href="#generic-exclusion-search-algorithm" class="hash-link" aria-label="Direct link to Generic exclusion search algorithm" title="Direct link to Generic exclusion search algorithm">​</a></h3><p>The following is illustrating how the <a href="https://github.com/ClickHouse/ClickHouse/blob/22.3/src/Storages/MergeTree/MergeTreeDataSelectExecutor.cpp#L1438" target="_blank" rel="noopener noreferrer">ClickHouse generic exclusion search algorithm</a> works when granules are selected via a secondary column where the predecessor key column has a low(er) or high(er) cardinality.</p><p>As an example for both cases we will assume:</p><ul><li>a query that is searching for rows with URL value = &quot;W3&quot;.</li><li>an abstract version of our hits table with simplified values for UserID and URL.</li><li>the same compound primary key (UserID, URL) for the index. This means rows are first ordered by UserID values. Rows with the same UserID value are then ordered by URL.</li><li>a granule size of two i.e. each granule contains two rows.</li></ul><p>We have marked the key column values for the first table rows for each granule in orange in the diagrams below..</p><p><strong>Predecessor key column has low(er) cardinality</strong><a name="generic-exclusion-search-fast"></a></p><p>Suppose UserID had low cardinality. In this case it would be likely that the same UserID value is spread over multiple table rows and granules and therefore index marks. For index marks with the same UserID, the URL values for the index marks are sorted in ascending order (because the table rows are ordered first by UserID and then by URL). This allows efficient filtering as described below:</p><img loading="lazy" src="/docs/assets/images/sparse-primary-indexes-07-ca969e10017e98b0bbc54d7d12e015ce.png" class="image" class="img_ev3q"><p>There are three different scenarios for the granule selection process for our abstract sample data in the diagram above:</p><ol><li><p>Index mark 0 for which the <strong>URL value is smaller than W3 and for which the URL value of the directly succeeding index mark is also smaller than W3</strong> can be excluded because mark 0, and 1 have the same UserID value. Note that this exclusion-precondition ensures that granule 0 is completely composed of U1 UserID values so that ClickHouse can assume that also the maximum URL value in granule 0 is smaller than W3 and exclude the granule.</p></li><li><p>Index mark 1 for which the <strong>URL value is smaller (or equal) than W3 and for which the URL value of the directly succeeding index mark is greater (or equal) than W3</strong> is selected because it means that granule 1 can possibly contain rows with URL W3.</p></li><li><p>Index marks 2 and 3 for which the <strong>URL value is greater than W3</strong> can be excluded, since index marks of a primary index store the key column values for the first table row for each granule and the table rows are sorted on disk by the key column values, therefore granule 2 and 3 can&#x27;t possibly contain URL value W3.</p></li></ol><p><strong>Predecessor key column has high(er) cardinality</strong><a name="generic-exclusion-search-slow"></a></p><p>When the UserID has high cardinality then it is unlikely that the same UserID value is spread over multiple table rows and granules. This means the URL values for the index marks are not monotonically increasing:</p><img loading="lazy" src="/docs/assets/images/sparse-primary-indexes-08-8e5bd1e1a5785278224099e37c34945e.png" class="image" class="img_ev3q"><p>As we can see in the diagram above, all shown marks whose URL values are smaller than W3 are getting selected for streaming its associated granule&#x27;s rows into the ClickHouse engine.</p><p>This is because whilst all index marks in the diagram fall into scenario 1 described above, they do not satisfy the mentioned exclusion-precondition that <em>the directly succeeding index mark has the same UserID value as the current mark</em> and thus can’t be excluded.</p><p>For example, consider index mark 0 for which the <strong>URL value is smaller than W3 and for which the URL value of the directly succeeding index mark is also smaller than W3</strong>. This can <em>not</em> be excluded because the directly succeeding index mark 1 does <em>not</em> have the same UserID value as the current mark 0.</p><p>This ultimately prevents ClickHouse from making assumptions about the maximum URL value in granule 0. Instead it has to assume that granule 0 potentially contains rows with URL value W3 and is forced to select mark 0.</p><p>The same scenario is true for mark 1, 2, and 3.</p><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_WoCw"><div class="alert-icon admonitionIcon_Ibzs"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></div><div class="alert-content admonitionContent_vXIg"><div class="admonitionHeading_TMsN">Conclusion</div><p>The <a href="https://github.com/ClickHouse/ClickHouse/blob/22.3/src/Storages/MergeTree/MergeTreeDataSelectExecutor.cpp#L1444" target="_blank" rel="noopener noreferrer">generic exclusion search algorithm</a> that ClickHouse is using instead of the <a href="https://github.com/ClickHouse/ClickHouse/blob/22.3/src/Storages/MergeTree/MergeTreeDataSelectExecutor.cpp#L1452" target="_blank" rel="noopener noreferrer">binary search algorithm</a> when a query is filtering on a column that is part of a compound key, but is not the first key column is most effective when the predecessor key column has low(er) cardinality.</p></div></div><p>In our sample data set both key columns (UserID, URL) have similar high cardinality, and, as explained, the generic exclusion search algorithm is not very effective when the predecessor key column of the URL column has a high(er) or similar cardinality.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="note-about-data-skipping-index">Note about data skipping index<a href="#note-about-data-skipping-index" class="hash-link" aria-label="Direct link to Note about data skipping index" title="Direct link to Note about data skipping index">​</a></h3><p>Because of the similarly high cardinality of UserID and URL, our <a href="#query-on-url">query filtering on URL</a> also wouldn&#x27;t benefit much from creating a <a href="/docs/en/optimize/skipping-indexes">secondary data skipping index</a> on the URL column
of our <a href="#a-table-with-a-primary-key">table with compound primary key (UserID, URL)</a>.</p><p>For example this two statements create and populate a <a href="/docs/en/engines/table-engines/mergetree-family/mergetree#primary-keys-and-indexes-in-queries">minmax</a> data skipping index on the URL column of our table:</p><div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TABLE</span><span class="token plain"> hits_UserID_URL </span><span class="token keyword" style="color:rgb(86, 156, 214)">ADD</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">INDEX</span><span class="token plain"> url_skipping_index URL </span><span class="token keyword" style="color:rgb(86, 156, 214)">TYPE</span><span class="token plain"> minmax GRANULARITY </span><span class="token number" style="color:rgb(181, 206, 168)">4</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TABLE</span><span class="token plain"> hits_UserID_URL MATERIALIZE </span><span class="token keyword" style="color:rgb(86, 156, 214)">INDEX</span><span class="token plain"> url_skipping_index</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ClickHouse now created an additional index that is storing - per group of 4 consecutive <a href="#data-is-organized-into-granules-for-parallel-data-processing">granules</a> (note the <code>GRANULARITY 4</code> clause in the <code>ALTER TABLE</code> statement above) - the minimum and maximum URL value:</p><img loading="lazy" src="/docs/assets/images/sparse-primary-indexes-13a-bb454960e2aee77973232e65468a19a6.png" class="image" class="img_ev3q"><p>The first index entry (‘mark 0’ in the diagram above) is storing the minimum and maximum URL values for the <a href="#data-is-organized-into-granules-for-parallel-data-processing">rows belonging to the first 4 granules of our table</a>.</p><p>The second index entry (‘mark 1’) is storing the minimum and maximum URL values for the rows belonging to the next 4 granules of our table, and so on.</p><p>(ClickHouse also created a special <a href="#mark-files-are-used-for-locating-granules">mark file</a> for to the data skipping index for <a href="#mark-files-are-used-for-locating-granules">locating</a> the groups of granules associated with the index marks.)</p><p>Because of the similarly high cardinality of UserID and URL, this secondary data skipping index can&#x27;t help with excluding granules from being selected when our <a href="#query-on-url">query filtering on URL</a> is executed.</p><p>The specific URL value that the query is looking for (i.e. &#x27;http://public_search&#x27;) very likely is between the minimum and maximum value stored by the index for each group of granules resulting in ClickHouse being forced to select the group of granules (because they might contain row(s) matching the query).</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="a-need-to-use-multiple-primary-indexes">A need to use multiple primary indexes<a href="#a-need-to-use-multiple-primary-indexes" class="hash-link" aria-label="Direct link to A need to use multiple primary indexes" title="Direct link to A need to use multiple primary indexes">​</a></h3><p>As a consequence, if we want to significantly speed up our sample query that filters for rows with a specific URL then we need to use a primary index optimized to that query.</p><p>If in addition we want to keep the good performance of our sample query that filters for rows with a specific UserID then we need to use multiple primary indexes.</p><p>The following is showing ways for achieving that.</p><a name="multiple-primary-indexes"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="options-for-creating-additional-primary-indexes">Options for creating additional primary indexes<a href="#options-for-creating-additional-primary-indexes" class="hash-link" aria-label="Direct link to Options for creating additional primary indexes" title="Direct link to Options for creating additional primary indexes">​</a></h3><p>If we want to significantly speed up both of our sample queries - the one that  filters for rows with a specific UserID and the one that filters for rows with a specific URL - then we need to use multiple primary indexes by using one of these three options:</p><ul><li>Creating a <strong>second table</strong> with a different primary key.</li><li>Creating a <strong>materialized view</strong> on our existing table.</li><li>Adding a <strong>projection</strong> to our existing table.</li></ul><p>All three options will effectively duplicate our sample data into a additional table in order to reorganize the table primary index and row sort order.</p><p>However, the three options differ in how transparent that additional table is to the user with respect to the routing of queries and insert statements.</p><p>When creating a <strong>second table</strong> with a different primary key then queries must be explicitly send to the table version best suited for the query, and new data must be inserted explicitly into both tables in order to keep the tables in sync:</p><img loading="lazy" src="/docs/assets/images/sparse-primary-indexes-09a-003957a1db28ae299e76de115d417152.png" class="image" class="img_ev3q"><p>With a <strong>materialized view</strong> the additional table is implicitly created and data is automatically kept in sync between both tables:</p><img loading="lazy" src="/docs/assets/images/sparse-primary-indexes-09b-0a3561fdefc32a8186cd253bd350ee1e.png" class="image" class="img_ev3q"><p>And the <strong>projection</strong> is the most transparent option because next to automatically keeping the implicitly created (and hidden) additional table in sync with data changes, ClickHouse will automatically choose the most effective table version for queries:</p><img loading="lazy" src="/docs/assets/images/sparse-primary-indexes-09c-f119a3e25f91776b8afb3f5c637435e4.png" class="image" class="img_ev3q"><p>In the following we discuss this three options for creating and using multiple primary indexes in more detail and with real examples.</p><a name="multiple-primary-indexes-via-secondary-tables"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="option-1-secondary-tables">Option 1: Secondary Tables<a href="#option-1-secondary-tables" class="hash-link" aria-label="Direct link to Option 1: Secondary Tables" title="Direct link to Option 1: Secondary Tables">​</a></h3><a name="secondary-table"></a>We are creating a new additional table where we switch the order of the key columns (compared to our original table) in the primary key:<div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TABLE</span><span class="token plain"> hits_URL_UserID</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token identifier">UserID</span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token plain"> UInt32</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token identifier">URL</span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token plain"> String</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token identifier">EventTime</span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">DateTime</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ENGINE</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> MergeTree</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">KEY</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">URL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> UserID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">URL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> UserID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> EventTime</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">SETTINGS index_granularity </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">8192</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> index_granularity_bytes </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Insert all 8.87 million rows from our <a href="#a-table-with-a-primary-key">original table</a> into the additional table:</p><div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">INTO</span><span class="token plain"> hits_URL_UserID</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> hits_UserID_URL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The response looks like:</p><div class="language-response codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-response codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">Ok.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">0 rows in set. Elapsed: 2.898 sec. Processed 8.87 million rows, 838.84 MB (3.06 million rows/s., 289.46 MB/s.)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>And finally optimize the table:</p><div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">OPTIMIZE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TABLE</span><span class="token plain"> hits_URL_UserID FINAL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Because we switched the order of the columns in the primary key, the inserted rows are now stored on disk in a different lexicographical order (compared to our <a href="#a-table-with-a-primary-key">original table</a>) and therefore also the 1083 granules of that table are containing different values than before:</p><img loading="lazy" src="/docs/assets/images/sparse-primary-indexes-10-4b8b5369ec9aadee678a4ad974877d81.png" class="image" class="img_ev3q"><p>This is the resulting primary key:</p><img loading="lazy" src="/docs/assets/images/sparse-primary-indexes-11-393dd1421fd310c4c3dc6a1ee0210a94.png" class="image" class="img_ev3q"><p>That can now be used to significantly speed up the execution of our example query filtering on the URL column in order to calculate the top 10 users that most frequently clicked on the URL &quot;http://public_search&quot;:</p><div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> UserID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">count</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">UserID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> Count</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> hits_URL_UserID</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> URL </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;http://public_search&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> UserID</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> Count </span><span class="token keyword" style="color:rgb(86, 156, 214)">DESC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">10</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The response is:</p><a name="query-on-url-fast"></a><div class="language-response codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-response codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">┌─────UserID─┬─Count─┐</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ 2459550954 │  3741 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ 1084649151 │  2484 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│  723361875 │   729 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ 3087145896 │   695 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ 2754931092 │   672 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ 1509037307 │   582 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ 3085460200 │   573 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ 2454360090 │   556 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ 3884990840 │   539 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│  765730816 │   536 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">└────────────┴───────┘</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">10 rows in set. Elapsed: 0.017 sec.</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#9CDCFE"><span class="token plain">Processed 319.49 thousand rows,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">11.38 MB (18.41 million rows/s., 655.75 MB/s.)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now, instead of <a href="#filtering-on-key-columns-after-the-first">almost doing a full table scan</a>, ClickHouse executed that query much more effectively.</p><p>With the primary index from the <a href="#a-table-with-a-primary-key">original table</a> where UserID was the first, and URL the second key column, ClickHouse used a <a href="#generic-exclusion-search-algorithm">generic exclusion search</a> over the index marks for executing that query and that was not very effective because of the similarly high cardinality of UserID and URL.</p><p>With URL as the first column in the primary index, ClickHouse is now running <a href="https://github.com/ClickHouse/ClickHouse/blob/22.3/src/Storages/MergeTree/MergeTreeDataSelectExecutor.cpp#L1452" target="_blank" rel="noopener noreferrer">binary search</a> over the index marks.
The corresponding trace log in the ClickHouse server log file confirms that:</p><div class="language-response codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-response codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">...Executor): Key condition: (column 0 in [&#x27;http://public_search&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                                           &#x27;http://public_search&#x27;])</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#9CDCFE"><span class="token plain">...Executor): Running binary search on index range for part all_1_9_2 (1083 marks)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">...Executor): Found (LEFT) boundary mark: 644</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">...Executor): Found (RIGHT) boundary mark: 683</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">...Executor): Found continuous range in 19 steps</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">...Executor): Selected 1/1 parts by partition key, 1 parts by primary key,</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#9CDCFE"><span class="token plain">              39/1083 marks by primary key, 39 marks to read from 1 ranges</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">...Executor): Reading approx. 319488 rows with 2 streams</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ClickHouse selected only 39 index marks, instead of 1076 when generic exclusion search was used.</p><p>Note that the additional table is optimized for speeding up the execution of our example query filtering on URLs.</p><p>Similar to the <a href="#query-on-url-slow">bad performance</a> of that query with our <a href="#a-table-with-a-primary-key">original table</a>, our <a href="#the-primary-index-is-used-for-selecting-granules">example query filtering on UserIDs</a> will not run very effectively with the new additional table, because UserID is now the second key column in the primary index of that table and therefore ClickHouse will use generic exclusion search for granule selection, which is <a href="#generic-exclusion-search-slow">not very effective for similarly high cardinality</a> of UserID and URL.
Open the details box for specifics.</p><details class="details_lb9f alert alert--info details_r1OI" data-collapsed="true"><summary>Query filtering on UserIDs now has bad performance<a name="query-on-userid-slow"></a></summary><div><div class="collapsibleContent_i85q"><p></p><div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> URL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">count</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">URL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> Count</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> hits_URL_UserID</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> UserID </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">749927693</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> URL</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> Count </span><span class="token keyword" style="color:rgb(86, 156, 214)">DESC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">10</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The response is:</p><div class="language-response codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-response codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">┌─URL────────────────────────────┬─Count─┐</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ http://auto.ru/chatay-barana.. │   170 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ http://auto.ru/chatay-id=371...│    52 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ http://public_search           │    45 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ http://kovrik-medvedevushku-...│    36 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ http://forumal                 │    33 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ http://korablitz.ru/L_1OFFER...│    14 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ http://auto.ru/chatay-id=371...│    14 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ http://auto.ru/chatay-john-D...│    13 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ http://auto.ru/chatay-john-D...│    10 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ http://wot/html?page/23600_m...│     9 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">└────────────────────────────────┴───────┘</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">10 rows in set. Elapsed: 0.024 sec.</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#9CDCFE"><span class="token plain">Processed 8.02 million rows,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">73.04 MB (340.26 million rows/s., 3.10 GB/s.)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Server Log:</p><div class="language-response codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-response codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">...Executor): Key condition: (column 1 in [749927693, 749927693])</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#9CDCFE"><span class="token plain">...Executor): Used generic exclusion search over index for part all_1_9_2</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">              with 1453 steps</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">...Executor): Selected 1/1 parts by partition key, 1 parts by primary key,</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#9CDCFE"><span class="token plain">              980/1083 marks by primary key, 980 marks to read from 23 ranges</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">...Executor): Reading approx. 8028160 rows with 10 streams</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p></p></div></div></details><p>We now have two tables. Optimized for speeding up queries filtering on UserIDs, and speeding up queries filtering on URLs, respectively:</p><img loading="lazy" src="/docs/assets/images/sparse-primary-indexes-12a-b65486178bcc260f789db394e5cd7cec.png" class="image" class="img_ev3q"><h3 class="anchor anchorWithStickyNavbar_LWe7" id="option-2-materialized-views">Option 2: Materialized Views<a href="#option-2-materialized-views" class="hash-link" aria-label="Direct link to Option 2: Materialized Views" title="Direct link to Option 2: Materialized Views">​</a></h3><p>Create a <a href="/docs/en/sql-reference/statements/create/view">materialized view</a> on our existing table.</p><div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">CREATE</span><span class="token plain"> MATERIALIZED </span><span class="token keyword" style="color:rgb(86, 156, 214)">VIEW</span><span class="token plain"> mv_hits_URL_UserID</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ENGINE</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> MergeTree</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">KEY</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">URL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> UserID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">URL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> UserID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> EventTime</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">POPULATE</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> hits_UserID_URL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The response looks like:</p><div class="language-response codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-response codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">Ok.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">0 rows in set. Elapsed: 2.935 sec. Processed 8.87 million rows, 838.84 MB (3.02 million rows/s., 285.84 MB/s.)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_WoCw"><div class="alert-icon admonitionIcon_Ibzs"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></div><div class="alert-content admonitionContent_vXIg"><div class="admonitionHeading_TMsN">note</div><ul><li>we switch the order of the key columns (compared to our <a href="#a-table-with-a-primary-key">original table</a> ) in the view&#x27;s primary key</li><li>the materialized view is backed by a <strong>implicitly created table</strong> whose row order and primary index is based on the given primary key definition</li><li>the implicitly created table is listed by the <code>SHOW TABLES</code> query and has a name starting with <code>.inner</code></li><li>it is also possible to first explicitly create the backing table for a materialized view and then the view can target that table via the <code>TO [db].[table]</code> <a href="/docs/en/sql-reference/statements/create/view">clause</a></li><li>we use the <code>POPULATE</code> keyword in order to immediately populate the implicitly created table with all 8.87 million rows from the source table <a href="#a-table-with-a-primary-key">hits_UserID_URL</a></li><li>if new rows are inserted into the source table hits_UserID_URL, then that rows are automatically also inserted into the implicitly created table</li><li>Effectively the implicitly created table has the same row order and primary index as the <a href="#multiple-primary-indexes-via-secondary-tables">secondary table that we created explicitly</a>:</li></ul><img loading="lazy" src="/docs/assets/images/sparse-primary-indexes-12b-1-8ff5162847bd90a30339ac660412ec76.png" class="image" class="img_ev3q"><p>ClickHouse is storing the <a href="#data-is-stored-on-disk-ordered-by-primary-key-columns">column data files</a> (<em>.bin), the <a href="#mark-files-are-used-for-locating-granules">mark files</a> (</em>.mrk2) and the <a href="#the-primary-index-has-one-entry-per-granule">primary index</a> (primary.idx) of the implicitly created table in a special folder withing the ClickHouse server&#x27;s data directory:</p><img loading="lazy" src="/docs/assets/images/sparse-primary-indexes-12b-2-f0fe4fee1e1c4e9e46097ecaa4ae0313.png" class="image" class="img_ev3q"></div></div><p>The implicitly created table (and it&#x27;s primary index) backing the materialized view can now be used to significantly speed up the execution of our example query filtering on the URL column:</p><div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> UserID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">count</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">UserID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> Count</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> mv_hits_URL_UserID</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> URL </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;http://public_search&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> UserID</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> Count </span><span class="token keyword" style="color:rgb(86, 156, 214)">DESC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">10</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The response is:</p><div class="language-response codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-response codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">┌─────UserID─┬─Count─┐</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ 2459550954 │  3741 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ 1084649151 │  2484 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│  723361875 │   729 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ 3087145896 │   695 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ 2754931092 │   672 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ 1509037307 │   582 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ 3085460200 │   573 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ 2454360090 │   556 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ 3884990840 │   539 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│  765730816 │   536 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">└────────────┴───────┘</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">10 rows in set. Elapsed: 0.026 sec.</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#9CDCFE"><span class="token plain">Processed 335.87 thousand rows,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">13.54 MB (12.91 million rows/s., 520.38 MB/s.)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Because effectively the implicitly created table (and it&#x27;s primary index) backing the materialized view is identical to the <a href="#multiple-primary-indexes-via-secondary-tables">secondary table that we created explicitly</a>, the query is executed in the same effective way as with the explicitly created table.</p><p>The corresponding trace log in the ClickHouse server log file confirms that ClickHouse is running binary search over the index marks:</p><div class="language-response codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-response codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">...Executor): Key condition: (column 0 in [&#x27;http://public_search&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                                           &#x27;http://public_search&#x27;])</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#9CDCFE"><span class="token plain">...Executor): Running binary search on index range ...</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">...</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">...Executor): Selected 4/4 parts by partition key, 4 parts by primary key,</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#9CDCFE"><span class="token plain">              41/1083 marks by primary key, 41 marks to read from 4 ranges</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">...Executor): Reading approx. 335872 rows with 4 streams</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="option-3-projections">Option 3: Projections<a href="#option-3-projections" class="hash-link" aria-label="Direct link to Option 3: Projections" title="Direct link to Option 3: Projections">​</a></h3><p>Create a projection on our existing table:</p><div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TABLE</span><span class="token plain"> hits_UserID_URL</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">ADD</span><span class="token plain"> PROJECTION prj_url_userid</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">URL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> UserID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>And materialize the projection:</p><div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TABLE</span><span class="token plain"> hits_UserID_URL</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    MATERIALIZE PROJECTION prj_url_userid</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_WoCw"><div class="alert-icon admonitionIcon_Ibzs"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></div><div class="alert-content admonitionContent_vXIg"><div class="admonitionHeading_TMsN">note</div><ul><li>the projection is creating a <strong>hidden table</strong> whose row order and primary index is based on the given <code>ORDER BY</code> clause of the projection</li><li>the hidden table is not listed by the <code>SHOW TABLES</code> query</li><li>we use the <code>MATERIALIZE</code> keyword in order to immediately populate the hidden table with all 8.87 million rows from the source table <a href="#a-table-with-a-primary-key">hits_UserID_URL</a></li><li>if new rows are inserted into the source table hits_UserID_URL, then that rows are automatically also inserted into the hidden table</li><li>a query is always (syntactically) targeting the source table hits_UserID_URL, but if the row order and primary index of the hidden table allows a more effective query execution, then that hidden table will be used instead</li><li>please note that projections do not make queries that use ORDER BY more efficient, even if the ORDER BY matches the projection&#x27;s ORDER BY statement (see <a href="https://github.com/ClickHouse/ClickHouse/issues/47333" target="_blank" rel="noopener noreferrer">https://github.com/ClickHouse/ClickHouse/issues/47333</a>)</li><li>Effectively the implicitly created hidden table has the same row order and primary index as the <a href="#multiple-primary-indexes-via-secondary-tables">secondary table that we created explicitly</a>:</li></ul><img loading="lazy" src="/docs/assets/images/sparse-primary-indexes-12c-1-076567cba621a9fccbaaf4b45b001307.png" class="image" class="img_ev3q"><p>ClickHouse is storing the <a href="#data-is-stored-on-disk-ordered-by-primary-key-columns">column data files</a> (<em>.bin), the <a href="#mark-files-are-used-for-locating-granules">mark files</a> (</em>.mrk2) and the <a href="#the-primary-index-has-one-entry-per-granule">primary index</a> (primary.idx) of the hidden table in a special folder (marked in orange in the screenshot below) next to the source table&#x27;s data files, mark files, and primary index files:</p><img loading="lazy" src="/docs/assets/images/sparse-primary-indexes-12c-2-197ed8132c0d6c239074af1ea1bb094e.png" class="image" class="img_ev3q"></div></div><p>The hidden table (and it&#x27;s primary index) created by the projection can now be (implicitly) used to significantly speed up the execution of our example query filtering on the URL column. Note that the query is syntactically targeting the source table of the projection.</p><div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> UserID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">count</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">UserID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> Count</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> hits_UserID_URL</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> URL </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;http://public_search&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> UserID</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> Count </span><span class="token keyword" style="color:rgb(86, 156, 214)">DESC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">10</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The response is:</p><div class="language-response codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-response codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">┌─────UserID─┬─Count─┐</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ 2459550954 │  3741 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ 1084649151 │  2484 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│  723361875 │   729 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ 3087145896 │   695 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ 2754931092 │   672 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ 1509037307 │   582 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ 3085460200 │   573 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ 2454360090 │   556 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ 3884990840 │   539 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│  765730816 │   536 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">└────────────┴───────┘</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">10 rows in set. Elapsed: 0.029 sec.</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#9CDCFE"><span class="token plain">Processed 319.49 thousand rows, 1</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">1.38 MB (11.05 million rows/s., 393.58 MB/s.)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Because effectively the hidden table (and it&#x27;s primary index) created by the projection is identical to the <a href="#multiple-primary-indexes-via-secondary-tables">secondary table that we created explicitly</a>, the query is executed in the same effective way as with the explicitly created table.</p><p>The corresponding trace log in the ClickHouse server log file confirms that ClickHouse is running binary search over the index marks:</p><div class="language-response codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-response codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">...Executor): Key condition: (column 0 in [&#x27;http://public_search&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                                           &#x27;http://public_search&#x27;])</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#9CDCFE"><span class="token plain">...Executor): Running binary search on index range for part prj_url_userid (1083 marks)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">...Executor): ...</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#9CDCFE"><span class="token plain">...Executor): Choose complete Normal projection prj_url_userid</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">...Executor): projection required columns: URL, UserID</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">...Executor): Selected 1/1 parts by partition key, 1 parts by primary key,</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#9CDCFE"><span class="token plain">              39/1083 marks by primary key, 39 marks to read from 1 ranges</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">...Executor): Reading approx. 319488 rows with 2 streams</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="summary">Summary<a href="#summary" class="hash-link" aria-label="Direct link to Summary" title="Direct link to Summary">​</a></h3><p>The primary index of our <a href="#a-table-with-a-primary-key">table with compound primary key (UserID, URL)</a> was very useful for speeding up a <a href="#the-primary-index-is-used-for-selecting-granules">query filtering on UserID</a>. But that index is not providing significant help with speeding up a <a href="#query-on-url">query filtering on URL</a>, despite the URL column being part of the compound primary key.</p><p>And vice versa:
The primary index of our <a href="#secondary-table">table with compound primary key (URL, UserID)</a> was speeding up a <a href="#query-on-url">query filtering on URL</a>, but didn&#x27;t provide much support for a <a href="#the-primary-index-is-used-for-selecting-granules">query filtering on UserID</a>.</p><p>Because of the similarly high cardinality of the primary key columns UserID and URL, a query that filters on the second key column <a href="#generic-exclusion-search-slow">doesn’t benefit much from the second key column being in the index</a>.</p><p>Therefore it makes sense to remove the second key column from the primary index (resulting in less memory consumption of the index) and to <a href="#multiple-primary-indexes">use multiple primary indexes</a> instead.</p><p>However if the key columns in a compound primary key have big differences in cardinality, then it is <a href="#generic-exclusion-search-fast">beneficial for queries</a> to order the primary key columns by cardinality in ascending order.</p><p>The higher the cardinality difference between the key columns is, the more the order of those columns in the key matters. We will demonstrate that in the next section.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ordering-key-columns-efficiently">Ordering key columns efficiently<a href="#ordering-key-columns-efficiently" class="hash-link" aria-label="Direct link to Ordering key columns efficiently" title="Direct link to Ordering key columns efficiently">​</a></h2><a name="test"></a><p>In a compound primary key the order of the key columns can significantly influence both:</p><ul><li>the efficiency of the filtering on secondary key columns in queries, and</li><li>the compression ratio for the table&#x27;s data files.</li></ul><p>In order to demonstrate that, we will use a version of our <a href="#data-set">web traffic sample data set</a>
where each row contains three columns that indicate whether or not the access by an internet &#x27;user&#x27; (<code>UserID</code> column) to a URL (<code>URL</code> column) got marked as bot traffic (<code>IsRobot</code> column).</p><p>We will use a compound primary key containing all three aforementioned columns that could be used to speed up typical web analytics queries that calculate</p><ul><li>how much (percentage of) traffic to a specific URL is from bots or</li><li>how confident we are that a specific user is (not) a bot (what percentage of traffic from that user is (not) assumed to be bot traffic)</li></ul><p>We use this query for calculating the cardinalities of the three columns that we want to use as key columns in a compound primary key (note that we are using the <a href="/docs/en/sql-reference/table-functions/url">URL table function</a> for querying TSV data ad-hocly without having to create a local table). Run this query in <code>clickhouse client</code>:</p><div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    formatReadableQuantity</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">uniq</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">URL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> cardinality_URL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    formatReadableQuantity</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">uniq</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">UserID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> cardinality_UserID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    formatReadableQuantity</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">uniq</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">IsRobot</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> cardinality_IsRobot</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        c11::UInt64 </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> UserID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        c15::String </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> URL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        c20::UInt8 </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> IsRobot</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> url</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;https://datasets.clickhouse.com/hits/tsv/hits_v1.tsv.xz&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> URL </span><span class="token operator" style="color:rgb(212, 212, 212)">!=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The response is:</p><div class="language-response codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-response codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">┌─cardinality_URL─┬─cardinality_UserID─┬─cardinality_IsRobot─┐</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ 2.39 million    │ 119.08 thousand    │ 4.00                │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">└─────────────────┴────────────────────┴─────────────────────┘</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">1 row in set. Elapsed: 118.334 sec. Processed 8.87 million rows, 15.88 GB (74.99 thousand rows/s., 134.21 MB/s.)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can see that there is a big difference between the cardinalities, especially between the <code>URL</code> and <code>IsRobot</code> columns, and therefore the order of these columns in a compound primary key is significant for both the efficient speed up of queries filtering on that columns and for achieving optimal compression ratios for the table&#x27;s column data files.</p><p>In order to demonstrate that we are creating two table versions for our bot traffic analysis data:</p><ul><li>a table <code>hits_URL_UserID_IsRobot</code> with the compound primary key <code>(URL, UserID, IsRobot)</code> where we order the key columns by cardinality in descending order</li><li>a table <code>hits_IsRobot_UserID_URL</code> with the compound primary key <code>(IsRobot, UserID, URL)</code> where we order the key columns by cardinality in ascending order</li></ul><p>Create the table <code>hits_URL_UserID_IsRobot</code> with the compound primary key <code>(URL, UserID, IsRobot)</code>:</p><div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TABLE</span><span class="token plain"> hits_URL_UserID_IsRobot</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token identifier">UserID</span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token plain"> UInt32</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token identifier">URL</span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token plain"> String</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token identifier">IsRobot</span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token plain"> UInt8</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ENGINE</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> MergeTree</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">KEY</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">URL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> UserID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> IsRobot</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>And populate it with 8.87 million rows:</p><div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">INTO</span><span class="token plain"> hits_URL_UserID_IsRobot </span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    intHash32</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">c11::UInt64</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> UserID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    c15 </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> URL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    c20 </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> IsRobot</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> url</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;https://datasets.clickhouse.com/hits/tsv/hits_v1.tsv.xz&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> URL </span><span class="token operator" style="color:rgb(212, 212, 212)">!=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This is the response:</p><div class="language-response codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-response codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">0 rows in set. Elapsed: 104.729 sec. Processed 8.87 million rows, 15.88 GB (84.73 thousand rows/s., 151.64 MB/s.)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Next, create the table <code>hits_IsRobot_UserID_URL</code> with the compound primary key <code>(IsRobot, UserID, URL)</code>:</p><div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TABLE</span><span class="token plain"> hits_IsRobot_UserID_URL</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token identifier">UserID</span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token plain"> UInt32</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token identifier">URL</span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token plain"> String</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token identifier">IsRobot</span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token plain"> UInt8</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ENGINE</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> MergeTree</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">KEY</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">IsRobot</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> UserID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> URL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>And populate it with the same 8.87 million rows that we used to populate the previous table:</p><div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">INTO</span><span class="token plain"> hits_IsRobot_UserID_URL </span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    intHash32</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">c11::UInt64</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> UserID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    c15 </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> URL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    c20 </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> IsRobot</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> url</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;https://datasets.clickhouse.com/hits/tsv/hits_v1.tsv.xz&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> URL </span><span class="token operator" style="color:rgb(212, 212, 212)">!=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The response is:</p><div class="language-response codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-response codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">0 rows in set. Elapsed: 95.959 sec. Processed 8.87 million rows, 15.88 GB (92.48 thousand rows/s., 165.50 MB/s.)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="efficient-filtering-on-secondary-key-columns">Efficient filtering on secondary key columns<a href="#efficient-filtering-on-secondary-key-columns" class="hash-link" aria-label="Direct link to Efficient filtering on secondary key columns" title="Direct link to Efficient filtering on secondary key columns">​</a></h3><p>When a query is filtering on at least one column that is part of a compound key, and is the first key column, <a href="#the-primary-index-is-used-for-selecting-granules">then ClickHouse is running the binary search algorithm over the key column&#x27;s index marks</a>.</p><p>When a query is filtering (only) on a column that is part of a compound key, but is not the first key column, <a href="#secondary-key-columns-can-not-be-inefficient">then ClickHouse is using the generic exclusion search algorithm over the key column&#x27;s index marks</a>.</p><p>For the second case the ordering of the key columns in the compound primary key is significant for the effectiveness of the <a href="https://github.com/ClickHouse/ClickHouse/blob/22.3/src/Storages/MergeTree/MergeTreeDataSelectExecutor.cpp#L1444" target="_blank" rel="noopener noreferrer">generic exclusion search algorithm</a>.</p><p>This is a query that is filtering on the <code>UserID</code> column of the table where we ordered the key columns <code>(URL, UserID, IsRobot)</code> by cardinality in descending order:</p><div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">count</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> hits_URL_UserID_IsRobot</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> UserID </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">112304</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The response is:</p><div class="language-response codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-response codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">┌─count()─┐</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│      73 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">└─────────┘</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">1 row in set. Elapsed: 0.026 sec.</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#9CDCFE"><span class="token plain">Processed 7.92 million rows,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">31.67 MB (306.90 million rows/s., 1.23 GB/s.)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This is the same query on the table where we ordered the key columns <code>(IsRobot, UserID, URL)</code> by cardinality in ascending order:</p><div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">count</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> hits_IsRobot_UserID_URL</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> UserID </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">112304</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The response is:</p><div class="language-response codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-response codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">┌─count()─┐</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│      73 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">└─────────┘</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">1 row in set. Elapsed: 0.003 sec.</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#9CDCFE"><span class="token plain">Processed 20.32 thousand rows,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">81.28 KB (6.61 million rows/s., 26.44 MB/s.)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can see that the query execution is significantly more effective and faster on the table where we ordered the key columns by cardinality in ascending order.</p><p>The reason for that is that the <a href="https://github.com/ClickHouse/ClickHouse/blob/22.3/src/Storages/MergeTree/MergeTreeDataSelectExecutor.cpp#L1444" target="_blank" rel="noopener noreferrer">generic exclusion search algorithm</a> works most effective, when <a href="#the-primary-index-is-used-for-selecting-granules">granules</a> are selected via a secondary key column where the predecessor key column has a lower cardinality. We illustrated that in detail in a <a href="#generic-exclusion-search-algorithm">previous section</a> of this guide.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="optimal-compression-ratio-of-data-files">Optimal compression ratio of data files<a href="#optimal-compression-ratio-of-data-files" class="hash-link" aria-label="Direct link to Optimal compression ratio of data files" title="Direct link to Optimal compression ratio of data files">​</a></h3><p>This query compares the compression ratio of the <code>UserID</code> column between the two tables that we created above:</p><div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">table</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">Table</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    name </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">Column</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    formatReadableSize</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">data_uncompressed_bytes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> Uncompressed</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    formatReadableSize</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">data_compressed_bytes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> Compressed</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token function" style="color:rgb(220, 220, 170)">round</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">data_uncompressed_bytes </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> data_compressed_bytes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> Ratio</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> system</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">columns</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">table</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;hits_URL_UserID_IsRobot&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">OR</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">table</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;hits_IsRobot_UserID_URL&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">AND</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;UserID&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> Ratio </span><span class="token keyword" style="color:rgb(86, 156, 214)">ASC</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This is the response:</p><div class="language-response codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-response codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">┌─Table───────────────────┬─Column─┬─Uncompressed─┬─Compressed─┬─Ratio─┐</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ hits_URL_UserID_IsRobot │ UserID │ 33.83 MiB    │ 11.24 MiB  │     3 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ hits_IsRobot_UserID_URL │ UserID │ 33.83 MiB    │ 877.47 KiB │    39 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">└─────────────────────────┴────────┴──────────────┴────────────┴───────┘</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">2 rows in set. Elapsed: 0.006 sec.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can see that the compression ratio for the <code>UserID</code> column is significantly higher for the table where we ordered the key columns <code>(IsRobot, UserID, URL)</code> by cardinality in ascending order.</p><p>Although in both tables exactly the same data is stored (we inserted the same 8.87 million rows into both tables), the order of the key columns in the compound primary key has a significant influence on how much disk space the <a href="https://clickhouse.com/docs/en/introduction/distinctive-features/#data-compression" target="_blank" rel="noopener noreferrer">compressed</a> data in the table&#x27;s <a href="#data-is-stored-on-disk-ordered-by-primary-key-columns">column data files</a> requires:</p><ul><li>in the table <code>hits_URL_UserID_IsRobot</code> with the compound primary key <code>(URL, UserID, IsRobot)</code> where we order the key columns by cardinality in descending order, the <code>UserID.bin</code> data file takes <strong>11.24 MiB</strong> of disk space</li><li>in the table <code>hits_IsRobot_UserID_URL</code> with the compound primary key <code>(IsRobot, UserID, URL)</code> where we order the key columns by cardinality in ascending order, the <code>UserID.bin</code> data file takes only <strong>877.47 KiB</strong> of disk space</li></ul><p>Having a good compression ratio for the data of a table&#x27;s column on disk not only saves space on disk, but also makes queries (especially analytical ones) that require the reading of data from that column faster, as less i/o is required for moving the column&#x27;s data from disk to the main memory (the operating system&#x27;s file cache).</p><p>In the following we illustrate why it&#x27;s beneficial for the compression ratio of a table&#x27;s columns to order the primary key columns by cardinality in ascending order.</p><p>The diagram below sketches the on-disk order of rows for a primary key where the key columns are ordered by cardinality in ascending order:</p><img loading="lazy" src="/docs/assets/images/sparse-primary-indexes-14a-a7b7f3157b9de88aefb317eb8abf526d.png" class="image" class="img_ev3q"><p>We discussed that <a href="#data-is-stored-on-disk-ordered-by-primary-key-columns">the table&#x27;s row data is stored on disk ordered by primary key columns</a>.</p><p>In the diagram above, the table&#x27;s rows (their column values on disk) are first ordered by their <code>cl</code> value, and rows that have the same <code>cl</code> value are ordered by their <code>ch</code> value. And because the first key column <code>cl</code> has low cardinality, it is likely that there are rows with the same <code>cl</code> value. And because of that it is also likely that <code>ch</code> values are ordered (locally - for rows with the same <code>cl</code> value).</p><p>If in a column, similar data is placed close to each other, for example via sorting, then that data will be compressed better.
In general, a compression algorithm benefits from the run length of data (the more data it sees the better for compression)
and locality (the more similar the data is, the better the compression ratio is).</p><p>In contrast to the diagram above, the diagram below sketches the on-disk order of rows for a primary key where the key columns are ordered by cardinality in descending order:</p><img loading="lazy" src="/docs/assets/images/sparse-primary-indexes-14b-2efaccd305d6e2e2a9bad0ed4efe6cff.png" class="image" class="img_ev3q"><p>Now the table&#x27;s rows are first ordered by their <code>ch</code> value, and rows that have the same <code>ch</code> value are ordered by their <code>cl</code> value.
But because the first key column <code>ch</code> has high cardinality, it is unlikely that there are rows with the same <code>ch</code> value. And because of that is is also unlikely that <code>cl</code> values are ordered (locally - for rows with the same <code>ch</code> value).</p><p>Therefore the <code>cl</code> values are most likely in random order and therefore have a bad locality and compression ration, respectively.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="summary-1">Summary<a href="#summary-1" class="hash-link" aria-label="Direct link to Summary" title="Direct link to Summary">​</a></h3><p>For both the efficient filtering on secondary key columns in queries and the compression ratio of a table&#x27;s column data files it is beneficial to order the columns in a primary key by their cardinality in ascending order.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="related-content-1">Related content<a href="#related-content-1" class="hash-link" aria-label="Direct link to Related content" title="Direct link to Related content">​</a></h3><ul><li>Blog: <a href="https://clickhouse.com/blog/clickhouse-faster-queries-with-projections-and-primary-indexes" target="_blank" rel="noopener noreferrer">Super charging your ClickHouse queries</a></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="identifying-single-rows-efficiently">Identifying single rows efficiently<a href="#identifying-single-rows-efficiently" class="hash-link" aria-label="Direct link to Identifying single rows efficiently" title="Direct link to Identifying single rows efficiently">​</a></h2><p>Although in general it is <a href="/docs/knowledgebase/key-value">not</a> the best use case for ClickHouse,
sometimes applications built on top of ClickHouse require to identify single rows of a ClickHouse table.</p><p>An intuitive solution for that might be to use a <a href="https://en.wikipedia.org/wiki/Universally_unique_identifier" target="_blank" rel="noopener noreferrer">UUID</a> column with a unique value per row and for fast retrieval of rows to use that column as a primary key column.</p><p>For the fastest retrieval, the UUID column <a href="#the-primary-index-is-used-for-selecting-granules">would need to be the first key column</a>.</p><p>We discussed that because <a href="#data-is-stored-on-disk-ordered-by-primary-key-columns">a ClickHouse table&#x27;s row data is stored on disk ordered by primary key column(s)</a>, having a very high cardinality column (like a UUID column) in a primary key or in a compound primary key before columns with lower cardinality <a href="#optimal-compression-ratio-of-data-files">is detrimental for the compression ratio of other table columns</a>.</p><p>A compromise between fastest retrieval and optimal data compression is to use a compound primary key where the UUID is the last key column, after low(er) cardinality key columns that are used to ensure a good compression ratio for some of the table&#x27;s columns.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="a-concrete-example">A concrete example<a href="#a-concrete-example" class="hash-link" aria-label="Direct link to A concrete example" title="Direct link to A concrete example">​</a></h3><p>One concrete example is a the plaintext paste service <a href="https://pastila.nl" target="_blank" rel="noopener noreferrer">https://pastila.nl</a> that Alexey Milovidov developed and <a href="https://clickhouse.com/blog/building-a-paste-service-with-clickhouse/" target="_blank" rel="noopener noreferrer">blogged about</a>.</p><p>On every change to the text-area, the data is saved automatically into a ClickHouse table row (one row per change).</p><p>And one way to identify and retrieve (a specific version of) the pasted content is to use a hash of the content as the UUID for the table row that contains the content.</p><p>The following diagram shows</p><ul><li>the insert order of rows when the content changes (for example because of keystrokes typing the text into the text-area) and</li><li>the on-disk order of the data from the inserted rows when the <code>PRIMARY KEY (hash)</code> is used:<img loading="lazy" src="/docs/assets/images/sparse-primary-indexes-15a-7b731b8fb6946cfec1c78d67da26d943.png" class="image" class="img_ev3q"></li></ul><p>Because the <code>hash</code> column is used as the primary key column</p><ul><li>specific rows can be retrieved <a href="#the-primary-index-is-used-for-selecting-granules">very quickly</a>, but</li><li>the table&#x27;s rows (their column data) are stored on disk ordered ascending by (the unique and random) hash values. Therefore also the content column&#x27;s values are stored in random order with no data locality resulting in a <strong>suboptimal compression ratio for the content column data file</strong>.</li></ul><p>In order to significantly improve the compression ratio for the content column while still achieving fast retrieval of specific rows, pastila.nl is using two hashes (and a compound primary key) for identifying a specific row:</p><ul><li>a hash of the content, as discussed above, that is distinct for distinct data, and</li><li>a <a href="https://en.wikipedia.org/wiki/Locality-sensitive_hashing" target="_blank" rel="noopener noreferrer">locality-sensitive hash (fingerprint)</a> that does <strong>not</strong> change on small changes of data.</li></ul><p>The following diagram shows</p><ul><li>the insert order of rows when the content changes (for example because of keystrokes typing the text into the text-area) and</li><li>the on-disk order of the data from the inserted rows when the compound <code>PRIMARY KEY (fingerprint, hash)</code> is used:</li></ul><img loading="lazy" src="/docs/assets/images/sparse-primary-indexes-15b-844d8429b76164eeeedd8da9cece82b7.png" class="image" class="img_ev3q"><p>Now the rows on disk are first ordered by <code>fingerprint</code>, and for rows with the same fingerprint value, their <code>hash</code> value determines the final order.</p><p>Because data that differs only in small changes is getting the same fingerprint value, similar data is now stored on disk close to each other in the content column. And that is very good for the compression ratio of the content column, as a compression algorithm in general benefits from data locality (the more similar the data is the better the compression ratio is).</p><p>The compromise is that two fields (<code>fingerprint</code> and <code>hash</code>) are required for the retrieval of a specific row in order to optimally utilise the primary index that results from the compound <code>PRIMARY KEY (fingerprint, hash)</code>.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/ClickHouse/clickhouse-docs/blob/main/docs/en/guides/best-practices/sparse-primary-indexes.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev paginationNavLink_UdUv" href="/docs/en/guides/developer/transactional"><svg width="24" height="25" viewBox="0 0 24 25" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9.2751 19.175L10.3251 18.125L5.4501 13.25H21.6001V11.75H5.4501L10.3251 6.87501L9.2751 5.82501L2.5751 12.5L9.2751 19.175Z" fill="currentColor"></path></svg><div class="paginationNavContent__3xr"><div class="pagination-nav__sublabel">Previous</div><div class="paginationNavLabel_YPzM pagination-nav__label">Transactional (ACID) support</div></div></a><a class="pagination-nav__link pagination-nav__link--next paginationNavLink_UdUv" href="/docs/en/optimize/skipping-indexes"><div class="paginationNavContent__3xr"><div class="pagination-nav__sublabel">Next</div><div class="paginationNavLabel_YPzM pagination-nav__label">Data Skipping Indexes</div></div><svg width="24" height="25" viewBox="0 0 24 25" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14.7249 19.175L13.6749 18.125L18.5499 13.25H2.3999V11.75H18.5499L13.6749 6.87501L14.7249 5.82501L21.4249 12.5L14.7249 19.175Z" fill="currentColor"></path></svg></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link toc-highlight">Introduction</a><ul><li><a href="#data-set" class="table-of-contents__link toc-highlight">Data Set</a></li><li><a href="#test-machine" class="table-of-contents__link toc-highlight">Test Machine</a></li><li><a href="#a-full-table-scan" class="table-of-contents__link toc-highlight">A full table scan</a></li><li><a href="#related-content" class="table-of-contents__link toc-highlight">Related content</a></li></ul></li><li><a href="#clickhouse-index-design" class="table-of-contents__link toc-highlight">ClickHouse Index Design</a><ul><li><a href="#an-index-design-for-massive-data-scales" class="table-of-contents__link toc-highlight">An index design for massive data scales</a></li><li><a href="#a-table-with-a-primary-key" class="table-of-contents__link toc-highlight">A table with a primary key</a></li><li><a href="#data-is-stored-on-disk-ordered-by-primary-key-columns" class="table-of-contents__link toc-highlight">Data is stored on disk ordered by primary key column(s)</a></li><li><a href="#data-is-organized-into-granules-for-parallel-data-processing" class="table-of-contents__link toc-highlight">Data is organized into granules for parallel data processing</a></li><li><a href="#the-primary-index-has-one-entry-per-granule" class="table-of-contents__link toc-highlight">The primary index has one entry per granule</a></li><li><a href="#the-primary-index-is-used-for-selecting-granules" class="table-of-contents__link toc-highlight">The primary index is used for selecting granules</a></li><li><a href="#mark-files-are-used-for-locating-granules" class="table-of-contents__link toc-highlight">Mark files are used for locating granules</a></li></ul></li><li><a href="#using-multiple-primary-indexes" class="table-of-contents__link toc-highlight">Using multiple primary indexes</a><ul><li><a href="#secondary-key-columns-can-not-be-inefficient" class="table-of-contents__link toc-highlight">Secondary key columns can (not) be inefficient</a></li><li><a href="#generic-exclusion-search-algorithm" class="table-of-contents__link toc-highlight">Generic exclusion search algorithm</a></li><li><a href="#note-about-data-skipping-index" class="table-of-contents__link toc-highlight">Note about data skipping index</a></li><li><a href="#a-need-to-use-multiple-primary-indexes" class="table-of-contents__link toc-highlight">A need to use multiple primary indexes</a></li><li><a href="#options-for-creating-additional-primary-indexes" class="table-of-contents__link toc-highlight">Options for creating additional primary indexes</a></li><li><a href="#option-1-secondary-tables" class="table-of-contents__link toc-highlight">Option 1: Secondary Tables</a></li><li><a href="#option-2-materialized-views" class="table-of-contents__link toc-highlight">Option 2: Materialized Views</a></li><li><a href="#option-3-projections" class="table-of-contents__link toc-highlight">Option 3: Projections</a></li><li><a href="#summary" class="table-of-contents__link toc-highlight">Summary</a></li></ul></li><li><a href="#ordering-key-columns-efficiently" class="table-of-contents__link toc-highlight">Ordering key columns efficiently</a><ul><li><a href="#efficient-filtering-on-secondary-key-columns" class="table-of-contents__link toc-highlight">Efficient filtering on secondary key columns</a></li><li><a href="#optimal-compression-ratio-of-data-files" class="table-of-contents__link toc-highlight">Optimal compression ratio of data files</a></li><li><a href="#summary-1" class="table-of-contents__link toc-highlight">Summary</a></li><li><a href="#related-content-1" class="table-of-contents__link toc-highlight">Related content</a></li></ul></li><li><a href="#identifying-single-rows-efficiently" class="table-of-contents__link toc-highlight">Identifying single rows efficiently</a><ul><li><a href="#a-concrete-example" class="table-of-contents__link toc-highlight">A concrete example</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer_jryj"><div class="container_y1z5 container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">© 2016&ndash;2023 ClickHouse, Inc.</div></div><div><div class="footer__links text--center"><div class="footer__links"><a href="https://clickhouse.com/legal/trademark-policy" target="_blank" rel="noopener noreferrer" class="footer__link-item">Trademark</a><span class="footer__link-separator">·</span><a href="https://clickhouse.com/legal/privacy-policy" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy</a><span class="footer__link-separator">·</span><a href="https://trust.clickhouse.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Security</a><span class="footer__link-separator">·</span><a href="https://clickhouse.com/legal/agreements/terms-of-service" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms of Service</a></div></div></div></div><button class="colorModeButton_hk25"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M8.7227 0.724664C8.7227 0.330045 8.39191 0 8.0036 0C7.60809 0 7.2773 0.330045 7.2773 0.724664V2.18834C7.2773 2.57578 7.60809 2.90583 8.0036 2.90583C8.39191 2.90583 8.7227 2.57578 8.7227 2.18834V0.724664ZM11.5991 3.4009C11.3258 3.67354 11.3258 4.13274 11.6063 4.41256C11.8796 4.6852 12.347 4.69238 12.6274 4.40538L13.6629 3.3722C13.9434 3.09238 13.9362 2.62601 13.6629 2.34619C13.3897 2.07354 12.9222 2.08072 12.649 2.35336L11.5991 3.4009ZM3.37258 4.40538C3.64584 4.6852 4.11326 4.6852 4.38652 4.41256C4.66697 4.14709 4.66697 3.66637 4.4009 3.4009L3.3582 2.35336C3.09213 2.08789 2.61753 2.07354 2.34427 2.34619C2.07101 2.62601 2.06382 3.09238 2.33708 3.36502L3.37258 4.40538ZM7.9964 11.774C10.0602 11.774 11.7717 10.0664 11.7717 8C11.7717 5.93363 10.0602 4.22601 7.9964 4.22601C5.93258 4.22601 4.22112 5.93363 4.22112 8C4.22112 10.0664 5.93258 11.774 7.9964 11.774ZM7.9964 10.4395C6.65888 10.4395 5.55146 9.33453 5.55146 8C5.55146 6.66547 6.65888 5.56054 7.9964 5.56054C9.33393 5.56054 10.4413 6.66547 10.4413 8C10.4413 9.33453 9.33393 10.4395 7.9964 10.4395ZM15.2809 8.71749C15.6692 8.71749 16 8.38744 16 8C16 7.60538 15.6692 7.28251 15.2809 7.28251H13.8211C13.4328 7.28251 13.102 7.60538 13.102 8C13.102 8.38744 13.4328 8.71749 13.8211 8.71749H15.2809ZM0.719101 7.28251C0.330787 7.28251 0 7.60538 0 8C0 8.38744 0.330787 8.71749 0.719101 8.71749H2.17888C2.57438 8.71749 2.90517 8.38744 2.90517 8C2.90517 7.60538 2.57438 7.28251 2.17888 7.28251H0.719101ZM12.6202 11.5946C12.347 11.322 11.8796 11.322 11.5991 11.5946C11.3258 11.8744 11.3258 12.3336 11.6063 12.6135L12.649 13.6538C12.9294 13.9265 13.3897 13.9193 13.6701 13.6395C13.9434 13.3668 13.9434 12.9076 13.6629 12.6278L12.6202 11.5946ZM2.33708 12.6206C2.05663 12.9004 2.05663 13.3668 2.3227 13.6395C2.60315 13.9121 3.07056 13.9193 3.34382 13.6466L4.38652 12.6135C4.66697 12.3336 4.66697 11.8744 4.4009 11.6018C4.12045 11.322 3.65303 11.322 3.37258 11.5946L2.33708 12.6206ZM8.7227 13.8117C8.7227 13.4242 8.39191 13.0942 8.0036 13.0942C7.60809 13.0942 7.2773 13.4242 7.2773 13.8117V15.2753C7.2773 15.6628 7.60809 16 8.0036 16C8.39191 16 8.7227 15.6628 8.7227 15.2753V13.8117Z" fill="currentColor"></path></svg><span>light Mode</span></button></footer></div>
<script src="/docs/assets/js/runtime~main.c931671b.js"></script>
<script src="/docs/assets/js/main.05424d61.js"></script>
</body>
</html>