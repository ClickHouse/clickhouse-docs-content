"use strict";(self.webpackChunknew_nav_docusaurus_2_2=self.webpackChunknew_nav_docusaurus_2_2||[]).push([[48258],{3905:(e,n,t)=>{t.d(n,{Zo:()=>c,kt:()=>b});var r=t(67294);function a(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function l(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){a(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function o(e,n){if(null==e)return{};var t,r,a=function(e,n){if(null==e)return{};var t,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)t=i[r],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)t=i[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}var s=r.createContext({}),u=function(e){var n=r.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):l(l({},n),e)),t},c=function(e){var n=u(e.components);return r.createElement(s.Provider,{value:n},e.children)},d="mdxType",p={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},m=r.forwardRef((function(e,n){var t=e.components,a=e.mdxType,i=e.originalType,s=e.parentName,c=o(e,["components","mdxType","originalType","parentName"]),d=u(t),m=a,b=d["".concat(s,".").concat(m)]||d[m]||p[m]||i;return t?r.createElement(b,l(l({ref:n},c),{},{components:t})):r.createElement(b,l({ref:n},c))}));function b(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var i=t.length,l=new Array(i);l[0]=m;var o={};for(var s in n)hasOwnProperty.call(n,s)&&(o[s]=n[s]);o.originalType=e,o[d]="string"==typeof e?e:a,l[1]=o;for(var u=2;u<i;u++)l[u]=t[u];return r.createElement.apply(null,l)}return r.createElement.apply(null,t)}m.displayName="MDXCreateElement"},39632:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>s,contentTitle:()=>l,default:()=>p,frontMatter:()=>i,metadata:()=>o,toc:()=>u});var r=t(87462),a=(t(67294),t(3905));const i={slug:"/en/development/build-cross-s390x",sidebar_position:69,title:"How to Build, Run and Debug ClickHouse on Linux for s390x (zLinux)",sidebar_label:"Build on Linux for s390x (zLinux)"},l=void 0,o={unversionedId:"en/development/build-cross-s390x",id:"en/development/build-cross-s390x",title:"How to Build, Run and Debug ClickHouse on Linux for s390x (zLinux)",description:"As of writing (2023/3/10) building for s390x considered to be experimental. Not all features can be enabled, has broken features and is currently under active development.",source:"@site/docs/en/development/build-cross-s390x.md",sourceDirName:"en/development",slug:"/en/development/build-cross-s390x",permalink:"/docs/en/development/build-cross-s390x",draft:!1,editUrl:"https://github.com/ClickHouse/ClickHouse/tree/master/docs/en/development/build-cross-s390x.md",tags:[],version:"current",sidebarPosition:69,frontMatter:{slug:"/en/development/build-cross-s390x",sidebar_position:69,title:"How to Build, Run and Debug ClickHouse on Linux for s390x (zLinux)",sidebar_label:"Build on Linux for s390x (zLinux)"},sidebar:"docs",previous:{title:"Build on Linux for RISC-V 64",permalink:"/docs/en/development/build-cross-riscv"},next:{title:"C++ Guide",permalink:"/docs/en/development/style"}},s={},u=[{value:"Building",id:"building",level:2},{value:"Running",id:"running",level:2},{value:"Debugging",id:"debugging",level:2},{value:"Visual Studio Code integration",id:"visual-studio-code-integration",level:2}],c={toc:u},d="wrapper";function p(e){let{components:n,...t}=e;return(0,a.kt)(d,(0,r.Z)({},c,t,{components:n,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"As of writing (2023/3/10) building for s390x considered to be experimental. Not all features can be enabled, has broken features and is currently under active development. "),(0,a.kt)("h2",{id:"building"},"Building"),(0,a.kt)("p",null,"As s390x does not support boringssl, it uses OpenSSL and has two related build options. "),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"By default, the s390x build will dynamically link to OpenSSL libraries. It will build OpenSSL shared objects, so it's not necessary to install OpenSSL beforehand. (This option is recommended in all cases.)"),(0,a.kt)("li",{parentName:"ul"},"Another option is to build OpenSSL in-tree. In this case two build flags need to be supplied to cmake")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"-DENABLE_OPENSSL_DYNAMIC=0 -DENABLE_OPENSSL=1\n")),(0,a.kt)("p",null,"These instructions assume that the host machine is x86_64 and has all the tooling required to build natively based on the ",(0,a.kt)("a",{parentName:"p",href:"/docs/en/development/build"},"build instructions"),". It also assumes that the host is Ubuntu 22.04 but the following instructions should also work on Ubuntu 20.04."),(0,a.kt)("p",null,"In addition to installing the tooling used to build natively, the following additional packages need to be installed:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"apt-get install binutils-s390x-linux-gnu libc6-dev-s390x-cross gcc-s390x-linux-gnu binfmt-support qemu-user-static\n")),(0,a.kt)("p",null,"If you wish to cross compile rust code install the rust cross compile target for s390x:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"rustup target add s390x-unknown-linux-gnu\n")),(0,a.kt)("p",null,"To build for s390x:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"cmake -DCMAKE_TOOLCHAIN_FILE=cmake/linux/toolchain-s390x.cmake ..\nninja\n")),(0,a.kt)("h2",{id:"running"},"Running"),(0,a.kt)("p",null,"Once built, the binary can be run with, eg.:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"qemu-s390x-static -L /usr/s390x-linux-gnu ./clickhouse\n")),(0,a.kt)("h2",{id:"debugging"},"Debugging"),(0,a.kt)("p",null,"Install LLDB:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"apt-get install lldb-15\n")),(0,a.kt)("p",null,"To Debug a s390x executable, run clickhouse using QEMU in debug mode:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"qemu-s390x-static -g 31338 -L /usr/s390x-linux-gnu ./clickhouse\n")),(0,a.kt)("p",null,"In another shell run LLDB and attach, replace ",(0,a.kt)("inlineCode",{parentName:"p"},"<Clickhouse Parent Directory>")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"<build directory>")," with the values corresponding to your environment."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"lldb-15\n(lldb) target create ./clickhouse\nCurrent executable set to '/<Clickhouse Parent Directory>/ClickHouse/<build directory>/programs/clickhouse' (s390x).\n(lldb) settings set target.source-map <build directory> /<Clickhouse Parent Directory>/ClickHouse\n(lldb) gdb-remote 31338\nProcess 1 stopped\n* thread #1, stop reason = signal SIGTRAP\n    frame #0: 0x0000004020e74cd0\n->  0x4020e74cd0: lgr    %r2, %r15\n    0x4020e74cd4: aghi   %r15, -160\n    0x4020e74cd8: xc     0(8,%r15), 0(%r15)\n    0x4020e74cde: brasl  %r14, 275429939040\n(lldb) b main\nBreakpoint 1: 9 locations.\n(lldb) c\nProcess 1 resuming\nProcess 1 stopped\n* thread #1, stop reason = breakpoint 1.1\n    frame #0: 0x0000004005cd9fc0 clickhouse`main(argc_=1, argv_=0x0000004020e594a8) at main.cpp:450:17\n   447  #if !defined(FUZZING_MODE)\n   448  int main(int argc_, char ** argv_)\n   449  {\n-> 450      inside_main = true;\n   451      SCOPE_EXIT({ inside_main = false; });\n   452\n   453      /// PHDR cache is required for query profiler to work reliably\n")),(0,a.kt)("h2",{id:"visual-studio-code-integration"},"Visual Studio Code integration"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"(CodeLLDB extension)","[https://github.com/vadimcn/vscode-lldb]"," is required for visual debugging, the (Command Variable)","[https://github.com/rioj7/command-variable]"," extension can help dynamic launches if using (cmake variants)","[https://github.com/microsoft/vscode-cmake-tools/blob/main/docs/variants.md]","."),(0,a.kt)("li",{parentName:"ul"},"Make sure to set the backend to your llvm installation eg. ",(0,a.kt)("inlineCode",{parentName:"li"},'"lldb.library": "/usr/lib/x86_64-linux-gnu/liblldb-15.so"')),(0,a.kt)("li",{parentName:"ul"},"Launcher:")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "version": "0.2.0",\n    "configurations": [\n        {\n            "name": "Debug",\n            "type": "lldb",\n            "request": "custom",\n            "targetCreateCommands": ["target create ${command:cmake.launchTargetDirectory}/clickhouse"],\n            "processCreateCommands": ["settings set target.source-map ${input:targetdir} ${workspaceFolder}", "gdb-remote 31338"],\n            "sourceMap": { "${input:targetdir}": "${workspaceFolder}" },\n        }\n    ],\n    "inputs": [\n        {\n            "id": "targetdir",\n            "type": "command",\n            "command": "extension.commandvariable.transform",\n            "args": {\n                "text": "${command:cmake.launchTargetDirectory}",\n                "find": ".*/([^/]+)/[^/]+$",\n                "replace": "$1"\n            }\n        }\n    ]\n}\n')),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Make sure to run the clickhouse executable in debug mode prior to launch. (It is also possible to create a ",(0,a.kt)("inlineCode",{parentName:"li"},"preLaunchTask")," that automates this)")))}p.isMDXComponent=!0}}]);