"use strict";(self.webpackChunkclickhouse=self.webpackChunkclickhouse||[]).push([[31708],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>d});var r=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},s=Object.keys(e);for(r=0;r<s.length;r++)n=s[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(r=0;r<s.length;r++)n=s[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var c=r.createContext({}),l=function(e){var t=r.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=l(e.components);return r.createElement(c.Provider,{value:t},e.children)},h={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},p=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,s=e.originalType,c=e.parentName,u=o(e,["components","mdxType","originalType","parentName"]),p=l(n),d=a,m=p["".concat(c,".").concat(d)]||p[d]||h[d]||s;return n?r.createElement(m,i(i({ref:t},u),{},{components:n})):r.createElement(m,i({ref:t},u))}));function d(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var s=n.length,i=new Array(s);i[0]=p;var o={};for(var c in t)hasOwnProperty.call(t,c)&&(o[c]=t[c]);o.originalType=e,o.mdxType="string"==typeof e?e:a,i[1]=o;for(var l=2;l<s;l++)i[l]=n[l];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}p.displayName="MDXCreateElement"},13027:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>i,default:()=>h,frontMatter:()=>s,metadata:()=>o,toc:()=>l});var r=n(87462),a=(n(67294),n(3905));const s={slug:"/en/operations/query-result-cache",sidebar_position:65,sidebar_label:"Query Result Cache [experimental]"},i="Query Result Cache [experimental]",o={unversionedId:"en/operations/query-result-cache",id:"en/operations/query-result-cache",title:"Query Result Cache [experimental]",description:"The query result cache allows to compute SELECT queries just once and to serve further executions of the same query directly from the cache.",source:"@site/docs/en/operations/query-result-cache.md",sourceDirName:"en/operations",slug:"/en/operations/query-result-cache",permalink:"/docs/en/operations/query-result-cache",draft:!1,editUrl:"https://github.com/ClickHouse/ClickHouse/tree/master/docs/en/operations/query-result-cache.md",tags:[],version:"current",sidebarPosition:65,frontMatter:{slug:"/en/operations/query-result-cache",sidebar_position:65,sidebar_label:"Query Result Cache [experimental]"}},c={},l=[{value:"Background, Design and Limitations",id:"background-design-and-limitations",level:2},{value:"Configuration Settings and Usage",id:"configuration-settings-and-usage",level:2}],u={toc:l};function h(e){let{components:t,...n}=e;return(0,a.kt)("wrapper",(0,r.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"query-result-cache-experimental"},"Query Result Cache ","[experimental]"),(0,a.kt)("p",null,"The query result cache allows to compute SELECT queries just once and to serve further executions of the same query directly from the cache.\nDepending on the type of the queries, this can dramatically reduce latency and resource consumption of the ClickHouse server."),(0,a.kt)("h2",{id:"background-design-and-limitations"},"Background, Design and Limitations"),(0,a.kt)("p",null,"Query result caches can generally be viewed as transactionally consistent or inconsistent."),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"In transactionally consistent caches, the database invalidates (discards) cached query results if the result of the SELECT query changes\nor potentially changes. In ClickHouse, operations which change the data include inserts/updates/deletes in/of/from tables or collapsing\nmerges. Transactionally consistent caching is especially suitable for OLTP databases, for example\n",(0,a.kt)("a",{parentName:"li",href:"https://dev.mysql.com/doc/refman/5.6/en/query-cache.html"},"MySQL")," (which removed query result cache after v8.0) and\n",(0,a.kt)("a",{parentName:"li",href:"https://docs.oracle.com/database/121/TGDBA/tune_result_cache.htm"},"Oracle"),"."),(0,a.kt)("li",{parentName:"ul"},"In transactionally inconsistent caches, slight inaccuracies in query results are accepted under the assumption that all cache entries are\nassigned a validity period after which they expire (e.g. 1 minute) and that the underlying data changes only little during this period.\nThis approach is overall more suitable for OLAP databases. As an example where transactionally inconsistent caching is sufficient,\nconsider an hourly sales report in a reporting tool which is simultaneously accessed by multiple users. Sales data changes typically\nslowly enough that the database only needs to compute the report once (represented by the first SELECT query). Further queries can be\nserved directly from the query result cache. In this example, a reasonable validity period could be 30 min.")),(0,a.kt)("p",null,"Transactionally inconsistent caching is traditionally provided by client tools or proxy packages interacting with the database. As a result,\nthe same caching logic and configuration is often duplicated. With ClickHouse's query result cache, the caching logic moves to the server\nside. This reduces maintenance effort and avoids redundancy."),(0,a.kt)("div",{className:"admonition admonition-warning alert alert--danger"},(0,a.kt)("div",{parentName:"div",className:"admonition-heading"},(0,a.kt)("h5",{parentName:"div"},(0,a.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,a.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,a.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"}))),"warning")),(0,a.kt)("div",{parentName:"div",className:"admonition-content"},(0,a.kt)("p",{parentName:"div"},"The query result cache is an experimental feature that should not be used in production. There are known cases (e.g. in distributed query\nprocessing) where wrong results are returned."))),(0,a.kt)("h2",{id:"configuration-settings-and-usage"},"Configuration Settings and Usage"),(0,a.kt)("p",null,"Parameter ",(0,a.kt)("a",{parentName:"p",href:"/docs/en/operations/settings/settings#enable-experimental-query-result-cache"},"enable_experimental_query_result_cache")," controls whether query\nresults are inserted into / retrieved from the cache for the current query or session. For example, the first execution of query"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT some_expensive_calculation(column_1, column_2)\nFROM table\nSETTINGS enable_experimental_query_result_cache = true;\n")),(0,a.kt)("p",null,"stores the query result into the query result cache. Subsequent executions of the same query (also with parameter\n",(0,a.kt)("inlineCode",{parentName:"p"},"enable_experimental_query_result_cache = true"),") will read the computed result directly from the cache."),(0,a.kt)("p",null,"Sometimes, it is desirable to use the query result cache only passively, i.e. to allow reading from it but not writing into it (if the cache\nresult is not stored yet). Parameter ",(0,a.kt)("a",{parentName:"p",href:"/docs/en/operations/settings/settings#enable-experimental-query-result-cache-passive-usage"},"enable_experimental_query_result_cache_passive_usage"),"\ninstead of 'enable_experimental_query_result_cache' can be used for that."),(0,a.kt)("p",null,'For maximum control, it is generally recommended to provide settings "enable_experimental_query_result_cache" or\n"enable_experimental_query_result_cache_passive_usage" only with specific queries. It is also possible to enable caching at user or profile\nlevel but one should keep in mind that all SELECT queries may return a cached results, including monitoring or debugging queries to system\ntables.'),(0,a.kt)("p",null,"The query result cache can be cleared using statement ",(0,a.kt)("inlineCode",{parentName:"p"},"SYSTEM DROP QUERY RESULT CACHE"),". The content of the query result cache is displayed\nin system table ",(0,a.kt)("inlineCode",{parentName:"p"},"SYSTEM.QUERY_RESULT_CACHE"),'. The number of query result cache hits and misses are shown as events "QueryResultCacheHits" and\n"QueryResultCacheMisses" in system table ',(0,a.kt)("inlineCode",{parentName:"p"},"SYSTEM.EVENTS"),'. Both counters are only updated for SELECT queries which run with settings\n"enable_experimental_query_result_cache = true" or "enable_experimental_query_result_cache_passive_usage = true". Other queries do not\naffect the cache miss counter.'),(0,a.kt)("p",null,"The query result cache exists once per ClickHouse server process. However, cache results are by default not shared between users. This can\nbe changed (see below) but doing so is not recommended for security reasons."),(0,a.kt)("p",null,"Query results are referenced in the query result cache by the ",(0,a.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Abstract_syntax_tree"},"Abstract Syntax Tree (AST)"),"\nof their query. This means that caching is agnostic to upper/lowercase, for example ",(0,a.kt)("inlineCode",{parentName:"p"},"SELECT 1")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"select 1")," are treated as the same query.\nTo make the matching more natural, all query-level settings related to the query result cache are removed from the AST."),(0,a.kt)("p",null,"If the query was aborted due to an exception or user cancellation, no entry is written into the query result cache."),(0,a.kt)("p",null,"The size of the query result cache, the maximum number of cache entries and the maximum size of cache entries (in bytes and in records) can\nbe configured using different ",(0,a.kt)("a",{parentName:"p",href:"/docs/en/operations/server-configuration-parameters/settings#server_configuration_parameters_query-result-cache"},"server configuration options"),"."),(0,a.kt)("p",null,"To define how long a query must run at least such that its result can be cached, you can use setting\n",(0,a.kt)("a",{parentName:"p",href:"/docs/en/operations/settings/settings#query-result-cache-min-query-duration"},"query_result_cache_min_query_duration"),". For example, the result of query"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT some_expensive_calculation(column_1, column_2)\nFROM table\nSETTINGS enable_experimental_query_result_cache = true, query_result_cache_min_query_duration = 5000;\n")),(0,a.kt)("p",null,"is only cached if the query runs longer than 5 seconds. It is also possible to specify how often a query needs to run until its result is\ncached - for that use setting ",(0,a.kt)("a",{parentName:"p",href:"/docs/en/operations/settings/settings#query-result-cache-min-query-runs"},"query_result_cache_min_query_runs"),"."),(0,a.kt)("p",null,"Entries in the query result cache become stale after a certain time period (time-to-live). By default, this period is 60 seconds but a\ndifferent value can be specified at session, profile or query level using setting ",(0,a.kt)("a",{parentName:"p",href:"/docs/en/operations/settings/settings#query-result-cache-ttl"},"query_result_cache_ttl"),"."),(0,a.kt)("p",null,"Also, results of queries with non-deterministic functions such as ",(0,a.kt)("inlineCode",{parentName:"p"},"rand()")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"now()")," are not cached. This can be overruled using\nsetting ",(0,a.kt)("a",{parentName:"p",href:"/docs/en/operations/settings/settings#query-result-cache-store-results-of-queries-with-nondeterministic-functions"},"query_result_cache_store_results_of_queries_with_nondeterministic_functions"),"."),(0,a.kt)("p",null,"Finally, entries in the query cache are not shared between users due to security reasons. For example, user A must not be able to bypass a\nrow policy on a table by running the same query as another user B for whom no such policy exists. However, if necessary, cache entries can\nbe marked accessible by other users (i.e. shared) by supplying setting\n","[query_result_cache_share_between_users]","{settings/settings.md#query-result-cache-share-between-users}."))}h.isMDXComponent=!0}}]);