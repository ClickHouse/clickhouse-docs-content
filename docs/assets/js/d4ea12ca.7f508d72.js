"use strict";(self.webpackChunknew_nav_docusaurus_2_2=self.webpackChunknew_nav_docusaurus_2_2||[]).push([[61312],{3905:(e,n,t)=>{t.d(n,{Zo:()=>m,kt:()=>y});var a=t(67294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function s(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?s(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):s(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function i(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},s=Object.keys(e);for(a=0;a<s.length;a++)t=s[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(a=0;a<s.length;a++)t=s[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var l=a.createContext({}),u=function(e){var n=a.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},m=function(e){var n=u(e.components);return a.createElement(l.Provider,{value:n},e.children)},c="mdxType",d={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},p=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,s=e.originalType,l=e.parentName,m=i(e,["components","mdxType","originalType","parentName"]),c=u(t),p=r,y=c["".concat(l,".").concat(p)]||c[p]||d[p]||s;return t?a.createElement(y,o(o({ref:n},m),{},{components:t})):a.createElement(y,o({ref:n},m))}));function y(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var s=t.length,o=new Array(s);o[0]=p;var i={};for(var l in n)hasOwnProperty.call(n,l)&&(i[l]=n[l]);i.originalType=e,i[c]="string"==typeof e?e:r,o[1]=i;for(var u=2;u<s;u++)o[u]=t[u];return a.createElement.apply(null,o)}return a.createElement.apply(null,t)}p.displayName="MDXCreateElement"},15866:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>d,frontMatter:()=>s,metadata:()=>i,toc:()=>u});var a=t(87462),r=(t(67294),t(3905));const s={},o="Useful queries for troubleshooting",i={permalink:"/docs/knowledgebase/useful-queries-for-troubleshooting",source:"@site/knowledgebase/useful-queries-for-troubleshooting.md",title:"Useful queries for troubleshooting",description:"In no particular order, here are some handy queries for troubleshooting ClickHouse and figuring out what is happening. We also have a great blog with some essential queries for monitoring ClickHouse.",date:"2023-03-21T14:04:40.000Z",formattedDate:"March 21, 2023",tags:[],readingTime:3.74,hasTruncateMarker:!1,authors:[],frontMatter:{},prevItem:{title:"Can I use ClickHouse as a time-series database?",permalink:"/docs/knowledgebase/time-series"},nextItem:{title:"How to check grants and standard permissions for default user in ClickHouse Cloud",permalink:"/docs/knowledgebase/user-permissions-on-cloud"}},l={authorsImageUrls:[]},u=[{value:"View which settings have been changed from the default",id:"view-which-settings-have-been-changed-from-the-default",level:2},{value:"Get the size of all your tables",id:"get-the-size-of-all-your-tables",level:2},{value:"Row count and average day size of your table",id:"row-count-and-average-day-size-of-your-table",level:2},{value:"Compression columns percentage as well as the size of primary index in memory",id:"compression-columns-percentage-as-well-as-the-size-of-primary-index-in-memory",level:2},{value:"Number of queries sent by client in the last 10 minutes",id:"number-of-queries-sent-by-client-in-the-last-10-minutes",level:2},{value:"Number of parts in each partition",id:"number-of-parts-in-each-partition",level:2},{value:"Finding long running queries",id:"finding-long-running-queries",level:2},{value:"View the most recent errors",id:"view-the-most-recent-errors",level:2},{value:"Top 10 queries that are using the most CPU and memory",id:"top-10-queries-that-are-using-the-most-cpu-and-memory",level:2},{value:"How much disk space are my projection using",id:"how-much-disk-space-are-my-projection-using",level:2},{value:"Show disk storage, number of parts, number of rows in system.parts and marks across databases",id:"show-disk-storage-number-of-parts-number-of-rows-in-systemparts-and-marks-across-databases",level:2},{value:"List details of recently written new parts",id:"list-details-of-recently-written-new-parts",level:2}],m={toc:u},c="wrapper";function d(e){let{components:n,...t}=e;return(0,r.kt)(c,(0,a.Z)({},m,t,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"In no particular order, here are some handy queries for troubleshooting ClickHouse and figuring out what is happening. We also have a great blog with some ",(0,r.kt)("a",{parentName:"p",href:"https://clickhouse.com/blog/monitoring-troubleshooting-select-queries-clickhouse"},"essential queries for monitoring ClickHouse"),"."),(0,r.kt)("h2",{id:"view-which-settings-have-been-changed-from-the-default"},"View which settings have been changed from the default"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT\n    name,\n    value\nFROM system.settings\nWHERE changed\n")),(0,r.kt)("h2",{id:"get-the-size-of-all-your-tables"},"Get the size of all your tables"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT table,\n    formatReadableSize(sum(bytes)) as size\n    FROM system.parts\n    WHERE active\nGROUP BY table\n")),(0,r.kt)("p",null,"The response looks like:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-response"},"\u250c\u2500table\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500size\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 stat            \u2502 38.89 MiB \u2502\n\u2502 customers       \u2502 525.00 B  \u2502\n\u2502 my_sparse_table \u2502 40.73 MiB \u2502\n\u2502 crypto_prices   \u2502 32.18 MiB \u2502\n\u2502 hackernews      \u2502 6.23 GiB  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n")),(0,r.kt)("h2",{id:"row-count-and-average-day-size-of-your-table"},"Row count and average day size of your table"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT\n    table,\n    formatReadableSize(size) AS size,\n    rows,\n    days,\n    formatReadableSize(avgDaySize) AS avgDaySize\nFROM\n(\n    SELECT\n        table,\n        sum(bytes) AS size,\n        sum(rows) AS rows,\n        min(min_date) AS min_date,\n        max(max_date) AS max_date,\n        max_date - min_date AS days,\n        size / (max_date - min_date) AS avgDaySize\n    FROM system.parts\n    WHERE active\n    GROUP BY table\n    ORDER BY rows DESC\n)\n")),(0,r.kt)("h2",{id:"compression-columns-percentage-as-well-as-the-size-of-primary-index-in-memory"},"Compression columns percentage as well as the size of primary index in memory"),(0,r.kt)("p",null,"You can see how compressed your data is by column. This query also returns the size of your primary indexes in memory - useful to know because primary indexes must fit in memory."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT\n    parts.*,\n    columns.compressed_size,\n    columns.uncompressed_size,\n    columns.compression_ratio,\n    columns.compression_percentage\nFROM\n(\n    SELECT\n        table,\n        formatReadableSize(sum(data_uncompressed_bytes)) AS uncompressed_size,\n        formatReadableSize(sum(data_compressed_bytes)) AS compressed_size,\n        round(sum(data_compressed_bytes) / sum(data_uncompressed_bytes), 3) AS compression_ratio,\n        round(100 - ((sum(data_compressed_bytes) * 100) / sum(data_uncompressed_bytes)), 3) AS compression_percentage\n    FROM system.columns\n    GROUP BY table\n) AS columns\nRIGHT JOIN\n(\n    SELECT\n        table,\n        sum(rows) AS rows,\n        max(modification_time) AS latest_modification,\n        formatReadableSize(sum(bytes)) AS disk_size,\n        formatReadableSize(sum(primary_key_bytes_in_memory)) AS primary_keys_size,\n        any(engine) AS engine,\n        sum(bytes) AS bytes_size\n    FROM system.parts\n    WHERE active\n    GROUP BY\n        database,\n        table\n) AS parts ON columns.table = parts.table\nORDER BY parts.bytes_size DESC\n")),(0,r.kt)("h2",{id:"number-of-queries-sent-by-client-in-the-last-10-minutes"},"Number of queries sent by client in the last 10 minutes"),(0,r.kt)("p",null,"Feel free to increase or decrease the time interval in the ",(0,r.kt)("inlineCode",{parentName:"p"},"toIntervalMinute(10)")," function:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT\n    client_name,\n    count(),\n    query_kind,\n    toStartOfMinute(event_time) AS event_time_m\nFROM system.query_log\nWHERE (type = 'QueryStart') AND (event_time > (now() - toIntervalMinute(10)))\nGROUP BY\n    event_time_m,\n    client_name,\n    query_kind\nORDER BY\n    event_time_m DESC,\n    count() ASC\n")),(0,r.kt)("h2",{id:"number-of-parts-in-each-partition"},"Number of parts in each partition"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT\n    concat(database, '.', table),\n    partition_id,\n    count()\nFROM system.parts\nWHERE active\nGROUP BY\n    database,\n    table,\n    partition_id\n")),(0,r.kt)("h2",{id:"finding-long-running-queries"},"Finding long running queries"),(0,r.kt)("p",null,"This can help find queries that are stuck:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT\n    elapsed,\n    initial_user,\n    client_name,\n    hostname(),\n    query_id,\n    query\nFROM clusterAllReplicas(default, system.processes)\nORDER BY elapsed DESC\n")),(0,r.kt)("p",null,"Using the query id of the worst running query, we can get a stack trace that can help when debugging."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"SET allow_introspection_functions=1;\n\nSELECT\n    arrayStringConcat(\n        arrayMap(\n            x,\n            y -> concat(x, ': ', y),\n            arrayMap(x -> addressToLine(x), trace),\n            arrayMap(x -> demangle(addressToSymbol(x)), trace)\n        ),\n        '\\n'\n    ) as trace\nFROM\n    system.stack_trace\nWHERE\n    query_id = '0bb6e88b-9b9a-4ffc-b612-5746c859e360';\n")),(0,r.kt)("h2",{id:"view-the-most-recent-errors"},"View the most recent errors"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"SELECT *\nFROM system.errors\nORDER BY last_error_time DESC\n")),(0,r.kt)("p",null,"The response looks like:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-response"},"\u250c\u2500name\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500code\u2500\u252c\u2500value\u2500\u252c\u2500\u2500\u2500\u2500\u2500last_error_time\u2500\u252c\u2500last_error_message\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500last_error_trace\u2500\u252c\u2500remote\u2500\u2510\n\u2502 UNKNOWN_TABLE         \u2502   60 \u2502     3 \u2502 2023-03-14 01:02:35 \u2502 Table system.stack_trace doesn't exist                                                                                                              \u2502 []               \u2502      0 \u2502\n\u2502 BAD_GET               \u2502  170 \u2502     1 \u2502 2023-03-14 00:58:55 \u2502 Requested cluster 'default' not found                                                                                                               \u2502 []               \u2502      0 \u2502\n\u2502 UNKNOWN_IDENTIFIER    \u2502   47 \u2502     1 \u2502 2023-03-14 00:49:12 \u2502 Missing columns: 'parts.table' 'table' while processing query: 'table = parts.table', required columns: 'table' 'parts.table' 'table' 'parts.table' \u2502 []               \u2502      0 \u2502\n\u2502 NO_ELEMENTS_IN_CONFIG \u2502  139 \u2502     2 \u2502 2023-03-14 00:42:11 \u2502 Certificate file is not set.                                                                                                                        \u2502 []               \u2502      0 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n")),(0,r.kt)("h2",{id:"top-10-queries-that-are-using-the-most-cpu-and-memory"},"Top 10 queries that are using the most CPU and memory"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT\n    type,\n    event_time,\n    initial_query_id,\n    formatReadableSize(memory_usage) AS memory,\n    `ProfileEvents.Values`[indexOf(`ProfileEvents.Names`, 'UserTimeMicroseconds')] AS userCPU,\n    `ProfileEvents.Values`[indexOf(`ProfileEvents.Names`, 'SystemTimeMicroseconds')] AS systemCPU,\n    normalizedQueryHash(query) AS normalized_query_hash\nFROM system.query_log\nORDER BY memory_usage DESC\nLIMIT 10\n")),(0,r.kt)("h2",{id:"how-much-disk-space-are-my-projection-using"},"How much disk space are my projection using"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT\n    name,\n    parent_name,\n    formatReadableSize(bytes_on_disk) AS bytes,\n    formatReadableSize(parent_bytes_on_disk) AS parent_bytes,\n    bytes_on_disk / parent_bytes_on_disk AS ratio\nFROM system.projection_parts\n")),(0,r.kt)("h2",{id:"show-disk-storage-number-of-parts-number-of-rows-in-systemparts-and-marks-across-databases"},"Show disk storage, number of parts, number of rows in system.parts and marks across databases"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT\n    database,\n    table,\n    partition,\n    count() AS parts,\n    formatReadableSize(sum(bytes_on_disk)) AS bytes_on_disk,\n    formatReadableQuantity(sum(rows)) AS rows,\n    sum(marks) AS marks\nFROM system.parts\nWHERE (database != 'system') AND active\nGROUP BY\n    database,\n    table,\n    partition\nORDER BY database ASC\n")),(0,r.kt)("h2",{id:"list-details-of-recently-written-new-parts"},"List details of recently written new parts"),(0,r.kt)("p",null,"The details include when they got created, how large they are, how many rows, and more:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT\n    modification_time,\n    rows,\n    formatReadableSize(bytes_on_disk),\n    *\nFROM clusterAllReplicas(default, system.parts)\nWHERE (database = 'default') AND active AND (level = 0)\nORDER BY modification_time DESC\nLIMIT 100\n")))}d.isMDXComponent=!0}}]);