"use strict";(self.webpackChunkclickhouse=self.webpackChunkclickhouse||[]).push([[44715],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>d});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},s=Object.keys(e);for(a=0;a<s.length;a++)n=s[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(a=0;a<s.length;a++)n=s[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var c=a.createContext({}),l=function(e){var t=a.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=l(e.components);return a.createElement(c.Provider,{value:t},e.children)},h={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},p=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,s=e.originalType,c=e.parentName,u=o(e,["components","mdxType","originalType","parentName"]),p=l(n),d=r,m=p["".concat(c,".").concat(d)]||p[d]||h[d]||s;return n?a.createElement(m,i(i({ref:t},u),{},{components:n})):a.createElement(m,i({ref:t},u))}));function d(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var s=n.length,i=new Array(s);i[0]=p;var o={};for(var c in t)hasOwnProperty.call(t,c)&&(o[c]=t[c]);o.originalType=e,o.mdxType="string"==typeof e?e:r,i[1]=o;for(var l=2;l<s;l++)i[l]=n[l];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}p.displayName="MDXCreateElement"},70245:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>i,default:()=>h,frontMatter:()=>s,metadata:()=>o,toc:()=>l});var a=n(87462),r=(n(67294),n(3905));const s={slug:"/en/operations/query-cache",sidebar_position:65,sidebar_label:"Query Cache [experimental]"},i="Query Cache [experimental]",o={unversionedId:"en/operations/query-cache",id:"en/operations/query-cache",title:"Query Cache [experimental]",description:"The query cache allows to compute SELECT queries just once and to serve further executions of the same query directly from the cache.",source:"@site/docs/en/operations/query-cache.md",sourceDirName:"en/operations",slug:"/en/operations/query-cache",permalink:"/docs/en/operations/query-cache",draft:!1,editUrl:"https://github.com/ClickHouse/ClickHouse/tree/master/docs/en/operations/query-cache.md",tags:[],version:"current",sidebarPosition:65,frontMatter:{slug:"/en/operations/query-cache",sidebar_position:65,sidebar_label:"Query Cache [experimental]"}},c={},l=[{value:"Background, Design and Limitations",id:"background-design-and-limitations",level:2},{value:"Configuration Settings and Usage",id:"configuration-settings-and-usage",level:2}],u={toc:l};function h(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"query-cache-experimental"},"Query Cache ","[experimental]"),(0,r.kt)("p",null,"The query cache allows to compute ",(0,r.kt)("inlineCode",{parentName:"p"},"SELECT")," queries just once and to serve further executions of the same query directly from the cache.\nDepending on the type of the queries, this can dramatically reduce latency and resource consumption of the ClickHouse server."),(0,r.kt)("h2",{id:"background-design-and-limitations"},"Background, Design and Limitations"),(0,r.kt)("p",null,"Query caches can generally be viewed as transactionally consistent or inconsistent."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"In transactionally consistent caches, the database invalidates (discards) cached query results if the result of the ",(0,r.kt)("inlineCode",{parentName:"li"},"SELECT")," query changes\nor potentially changes. In ClickHouse, operations which change the data include inserts/updates/deletes in/of/from tables or collapsing\nmerges. Transactionally consistent caching is especially suitable for OLTP databases, for example\n",(0,r.kt)("a",{parentName:"li",href:"https://dev.mysql.com/doc/refman/5.6/en/query-cache.html"},"MySQL")," (which removed query cache after v8.0) and\n",(0,r.kt)("a",{parentName:"li",href:"https://docs.oracle.com/database/121/TGDBA/tune_result_cache.htm"},"Oracle"),"."),(0,r.kt)("li",{parentName:"ul"},"In transactionally inconsistent caches, slight inaccuracies in query results are accepted under the assumption that all cache entries are\nassigned a validity period after which they expire (e.g. 1 minute) and that the underlying data changes only little during this period.\nThis approach is overall more suitable for OLAP databases. As an example where transactionally inconsistent caching is sufficient,\nconsider an hourly sales report in a reporting tool which is simultaneously accessed by multiple users. Sales data changes typically\nslowly enough that the database only needs to compute the report once (represented by the first ",(0,r.kt)("inlineCode",{parentName:"li"},"SELECT")," query). Further queries can be\nserved directly from the query cache. In this example, a reasonable validity period could be 30 min.")),(0,r.kt)("p",null,"Transactionally inconsistent caching is traditionally provided by client tools or proxy packages interacting with the database. As a result,\nthe same caching logic and configuration is often duplicated. With ClickHouse's query cache, the caching logic moves to the server side.\nThis reduces maintenance effort and avoids redundancy."),(0,r.kt)("div",{className:"admonition admonition-warning alert alert--danger"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"}))),"warning")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"The query cache is an experimental feature that should not be used in production. There are known cases (e.g. in distributed query\nprocessing) where wrong results are returned."))),(0,r.kt)("h2",{id:"configuration-settings-and-usage"},"Configuration Settings and Usage"),(0,r.kt)("p",null,"As long as the result cache is experimental it must be activated using the following configuration setting:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SET allow_experimental_query_cache = true;\n")),(0,r.kt)("p",null,"Afterwards, setting ",(0,r.kt)("a",{parentName:"p",href:"/docs/en/operations/settings/settings#use-query-cache"},"use_query_cache")," can be used to control whether a specific query or all queries\nof the current session should utilize the query cache. For example, the first execution of query"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT some_expensive_calculation(column_1, column_2)\nFROM table\nSETTINGS use_query_cache = true;\n")),(0,r.kt)("p",null,"will store the query result in the query cache. Subsequent executions of the same query (also with parameter ",(0,r.kt)("inlineCode",{parentName:"p"},"use_query_cache = true"),") will\nread the computed result from the cache and return it immediately."),(0,r.kt)("p",null,"The way the cache is utilized can be configured in more detail using settings ",(0,r.kt)("a",{parentName:"p",href:"/docs/en/operations/settings/settings#enable-writes-to-query-cache"},"enable_writes_to_query_cache"),"\nand ",(0,r.kt)("a",{parentName:"p",href:"/docs/en/operations/settings/settings#enable-reads-from-query-cache"},"enable_reads_from_query_cache")," (both ",(0,r.kt)("inlineCode",{parentName:"p"},"true")," by default). The former setting\ncontrols whether query results are stored in the cache, whereas the latter setting determines if the database should try to retrieve query\nresults from the cache. For example, the following query will use the cache only passively, i.e. attempt to read from it but not store its\nresult in it:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT some_expensive_calculation(column_1, column_2)\nFROM table\nSETTINGS use_query_cache = true, enable_writes_to_query_cache = false;\n")),(0,r.kt)("p",null,'For maximum control, it is generally recommended to provide settings "use_query_cache", "enable_writes_to_query_cache" and\n"enable_reads_from_query_cache" only with specific queries. It is also possible to enable caching at user or profile level (e.g. via ',(0,r.kt)("inlineCode",{parentName:"p"},"SET\nuse_query_cache = true"),") but one should keep in mind that all ",(0,r.kt)("inlineCode",{parentName:"p"},"SELECT")," queries including monitoring or debugging queries to system tables\nmay return cached results then."),(0,r.kt)("p",null,"The query cache can be cleared using statement ",(0,r.kt)("inlineCode",{parentName:"p"},"SYSTEM DROP QUERY CACHE"),". The content of the query cache is displayed in system table\n",(0,r.kt)("inlineCode",{parentName:"p"},"system.query_cache"),'. The number of query cache hits and misses are shown as events "QueryCacheHits" and "QueryCacheMisses" in system table\n',(0,r.kt)("inlineCode",{parentName:"p"},"system.events"),". Both counters are only updated for ",(0,r.kt)("inlineCode",{parentName:"p"},"SELECT"),' queries which run with setting "use_query_cache = true". Other queries do not\naffect the cache miss counter.'),(0,r.kt)("p",null,"The query cache exists once per ClickHouse server process. However, cache results are by default not shared between users. This can be\nchanged (see below) but doing so is not recommended for security reasons."),(0,r.kt)("p",null,"Query results are referenced in the query cache by the ",(0,r.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Abstract_syntax_tree"},"Abstract Syntax Tree (AST)")," of\ntheir query. This means that caching is agnostic to upper/lowercase, for example ",(0,r.kt)("inlineCode",{parentName:"p"},"SELECT 1")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"select 1")," are treated as the same query. To\nmake the matching more natural, all query-level settings related to the query cache are removed from the AST."),(0,r.kt)("p",null,"If the query was aborted due to an exception or user cancellation, no entry is written into the query cache."),(0,r.kt)("p",null,"The size of the query cache, the maximum number of cache entries and the maximum size of cache entries (in bytes and in records) can\nbe configured using different ",(0,r.kt)("a",{parentName:"p",href:"/docs/en/operations/server-configuration-parameters/settings#server_configuration_parameters_query-cache"},"server configuration options"),"."),(0,r.kt)("p",null,"To define how long a query must run at least such that its result can be cached, you can use setting\n",(0,r.kt)("a",{parentName:"p",href:"/docs/en/operations/settings/settings#query-cache-min-query-duration"},"query_cache_min_query_duration"),". For example, the result of query"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT some_expensive_calculation(column_1, column_2)\nFROM table\nSETTINGS use_query_cache = true, query_cache_min_query_duration = 5000;\n")),(0,r.kt)("p",null,"is only cached if the query runs longer than 5 seconds. It is also possible to specify how often a query needs to run until its result is\ncached - for that use setting ",(0,r.kt)("a",{parentName:"p",href:"/docs/en/operations/settings/settings#query-cache-min-query-runs"},"query_cache_min_query_runs"),"."),(0,r.kt)("p",null,"Entries in the query cache become stale after a certain time period (time-to-live). By default, this period is 60 seconds but a different\nvalue can be specified at session, profile or query level using setting ",(0,r.kt)("a",{parentName:"p",href:"/docs/en/operations/settings/settings#query-cache-ttl"},"query_cache_ttl"),"."),(0,r.kt)("p",null,"Also, results of queries with non-deterministic functions such as ",(0,r.kt)("inlineCode",{parentName:"p"},"rand()")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"now()")," are not cached. This can be overruled using\nsetting ",(0,r.kt)("a",{parentName:"p",href:"/docs/en/operations/settings/settings#query-cache-store-results-of-queries-with-nondeterministic-functions"},"query_cache_store_results_of_queries_with_nondeterministic_functions"),"."),(0,r.kt)("p",null,"Finally, entries in the query cache are not shared between users due to security reasons. For example, user A must not be able to bypass a\nrow policy on a table by running the same query as another user B for whom no such policy exists. However, if necessary, cache entries can\nbe marked accessible by other users (i.e. shared) by supplying setting\n",(0,r.kt)("a",{parentName:"p",href:"/docs/en/operations/settings/settings#query-cache-share-between-users"},"query_cache_share_between_users"),"."))}h.isMDXComponent=!0}}]);