<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">ClickHouse Knowledge Base | ClickHouse Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://clickhouse.com/docs/img/logo.png"><meta data-rh="true" name="twitter:image" content="https://clickhouse.com/docs/img/logo.png"><meta data-rh="true" property="og:url" content="https://clickhouse.com/docs/knowledgebase/page/2"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" property="og:title" content="ClickHouse Knowledge Base | ClickHouse Docs"><meta data-rh="true" name="description" content="Knowledge Base"><meta data-rh="true" property="og:description" content="Knowledge Base"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="/docs/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://clickhouse.com/docs/knowledgebase/page/2"><link data-rh="true" rel="alternate" href="https://clickhouse.com/docs/knowledgebase/page/2" hreflang="en"><link data-rh="true" rel="alternate" href="https://clickhouse.com/docs/knowledgebase/page/2" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/docs/knowledgebase/rss.xml" title="ClickHouse Knowledge Base Feed RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/docs/knowledgebase/atom.xml" title="ClickHouse Knowledge Base Feed Atom Feed">
<link rel="alternate" type="application/json" href="/docs/knowledgebase/feed.json" title="ClickHouse Knowledge Base Feed JSON Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-KF1LLRTQ5Q"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-KF1LLRTQ5Q",{})</script>


<link rel="search" type="application/opensearchdescription+xml" title="ClickHouse Docs" href="/docs/opensearch.xml">





<script src="/docs/js/analytics.js"></script><link rel="stylesheet" href="/docs/assets/css/styles.58e6d7ad.css">
<link rel="preload" href="/docs/assets/js/runtime~main.a5ff7323.js" as="script">
<link rel="preload" href="/docs/assets/js/main.5e929b39.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top navBar_gvJn"><div class="navbarHeaderContainer_rccn navbar-header"><div class="navbar__inner navbarInner_W6bg"><div class="navbar__items"><a href="https://clickhouse.com/" target="_blank" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/docs/img/logo_without_text.svg" alt="ClickHouse" class="themedImage_ToTc themedImage--light_HNdA"><img src="/docs/img/logo_without_text.svg" alt="ClickHouse" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">ClickHouse</b></a><div class="navbarItemsList_uIZ2 navbar-items-list"><div class="navbar__item dropdown"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link ch-menu">Product</a><ul class="dropdown__menu"><li><a href="https://clickhouse.com/cloud" target="_blank" rel="noopener noreferrer" class="dropdown__link">ClickHouse Cloud</a></li><li><a href="https://clickhouse.com/clickhouse" target="_blank" rel="noopener noreferrer" class="dropdown__link">ClickHouse Open Source</a></li></ul></div><a href="https://clickhouse.com/customer-stories" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link ch-menu">Use Cases</a><div class="navbar__item dropdown"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link ch-menu">Company</a><ul class="dropdown__menu"><li><a href="https://clickhouse.com/blog" target="_blank" rel="noopener noreferrer" class="dropdown__link">Blog</a></li><li><a href="https://clickhouse.com/company/our-story" target="_blank" rel="noopener noreferrer" class="dropdown__link">Our story</a></li><li><a href="https://clickhouse.com/company/careers" target="_blank" rel="noopener noreferrer" class="dropdown__link">Careers</a></li><li><a href="https://clickhouse.com/company/contact" target="_blank" rel="noopener noreferrer" class="dropdown__link">Contact us</a></li><li><a href="https://clickhouse.com/company/news-events" target="_blank" rel="noopener noreferrer" class="dropdown__link">News and events</a></li></ul></div><div class="navbar__item dropdown"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link ch-menu">Learn</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/en/intro">Docs</a></li><li><a href="https://clickhouse.com/learn" target="_blank" rel="noopener noreferrer" class="dropdown__link">ClickHouse Academy</a></li></ul></div><a href="https://clickhouse.com/pricing" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link ch-menu">Pricing</a></div></div><div class="navbar__items navbar__items--right"><div class="navbar__item">
                <div class="nav-items-btns">
                  <a href="https://clickhouse.cloud/signIn" class="sign-in navbar__item navbar__link ch-menu">
                    Sign in
                  </a>
                  <a href="https://clickhouse.cloud/signUp" class="click-button-anchor">
                    <button class="click-button primary-btn">Free Trial</button>
                  </a>
                </div></div><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button></div></div><div class="secondary-nav--items secondaryMenu_iuff"><div class="scrollableElement_Qqzp secondaryMenuLeft_tFZR secondary-nav--items-left"><a class="navbar__item navbar__link ch-menu" href="/docs/en/intro">Docs</a><a class="navbar__item navbar__link ch-menu" href="/docs/en/cloud/overview">Cloud</a><a class="navbar__item navbar__link ch-menu" href="/docs/en/sql-reference">SQL Reference</a><a aria-current="page" class="navbar__item navbar__link ch-menu navbar__link--active" href="/docs/knowledgebase">Knowledge Base</a></div><div class="secondaryMenuRight__9m4 secondary-nav--items-right"><div class="navbar__item dropdown dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg width="14" height="13" viewBox="0 0 14 13" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M6.95 12.6496L9.75 5.26628H11.0333L13.8333 12.6496H12.55L11.9 10.7663H8.91667L8.25 12.6496H6.95ZM9.28333 9.69961H11.5L10.4167 6.64961H10.3667L9.28333 9.69961ZM2.08333 10.7996L1.21667 9.93294L4.33333 6.83294C3.94444 6.39961 3.60556 5.95228 3.31667 5.49094C3.02778 5.03005 2.77222 4.54405 2.55 4.03294H3.83333C4.02222 4.41072 4.22222 4.74672 4.43333 5.04094C4.64444 5.33561 4.89444 5.64405 5.18333 5.96628C5.63889 5.47739 6.01667 4.97472 6.31667 4.45828C6.61667 3.94139 6.86667 3.3885 7.06667 2.79961H0.25V1.58294H4.55V0.349609H5.78333V1.58294H10.0833V2.79961H8.3C8.07778 3.53294 7.78333 4.24116 7.41667 4.92428C7.05 5.60783 6.59444 6.25516 6.05 6.86628L7.53333 8.36628L7.06667 9.63294L5.16667 7.73294L2.08333 10.7996Z" fill="currentColor"/>
</svg></a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/en/intro">English</a></li><li><a class="dropdown__link" href="/docs/ru">Russian</a></li><li><a class="dropdown__link" href="/docs/zh">Chinese</a></li></ul></div><button class="colorModeButton_hk25 navbar-color-toggle"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M8.7227 0.724664C8.7227 0.330045 8.39191 0 8.0036 0C7.60809 0 7.2773 0.330045 7.2773 0.724664V2.18834C7.2773 2.57578 7.60809 2.90583 8.0036 2.90583C8.39191 2.90583 8.7227 2.57578 8.7227 2.18834V0.724664ZM11.5991 3.4009C11.3258 3.67354 11.3258 4.13274 11.6063 4.41256C11.8796 4.6852 12.347 4.69238 12.6274 4.40538L13.6629 3.3722C13.9434 3.09238 13.9362 2.62601 13.6629 2.34619C13.3897 2.07354 12.9222 2.08072 12.649 2.35336L11.5991 3.4009ZM3.37258 4.40538C3.64584 4.6852 4.11326 4.6852 4.38652 4.41256C4.66697 4.14709 4.66697 3.66637 4.4009 3.4009L3.3582 2.35336C3.09213 2.08789 2.61753 2.07354 2.34427 2.34619C2.07101 2.62601 2.06382 3.09238 2.33708 3.36502L3.37258 4.40538ZM7.9964 11.774C10.0602 11.774 11.7717 10.0664 11.7717 8C11.7717 5.93363 10.0602 4.22601 7.9964 4.22601C5.93258 4.22601 4.22112 5.93363 4.22112 8C4.22112 10.0664 5.93258 11.774 7.9964 11.774ZM7.9964 10.4395C6.65888 10.4395 5.55146 9.33453 5.55146 8C5.55146 6.66547 6.65888 5.56054 7.9964 5.56054C9.33393 5.56054 10.4413 6.66547 10.4413 8C10.4413 9.33453 9.33393 10.4395 7.9964 10.4395ZM15.2809 8.71749C15.6692 8.71749 16 8.38744 16 8C16 7.60538 15.6692 7.28251 15.2809 7.28251H13.8211C13.4328 7.28251 13.102 7.60538 13.102 8C13.102 8.38744 13.4328 8.71749 13.8211 8.71749H15.2809ZM0.719101 7.28251C0.330787 7.28251 0 7.60538 0 8C0 8.38744 0.330787 8.71749 0.719101 8.71749H2.17888C2.57438 8.71749 2.90517 8.38744 2.90517 8C2.90517 7.60538 2.57438 7.28251 2.17888 7.28251H0.719101ZM12.6202 11.5946C12.347 11.322 11.8796 11.322 11.5991 11.5946C11.3258 11.8744 11.3258 12.3336 11.6063 12.6135L12.649 13.6538C12.9294 13.9265 13.3897 13.9193 13.6701 13.6395C13.9434 13.3668 13.9434 12.9076 13.6629 12.6278L12.6202 11.5946ZM2.33708 12.6206C2.05663 12.9004 2.05663 13.3668 2.3227 13.6395C2.60315 13.9121 3.07056 13.9193 3.34382 13.6466L4.38652 12.6135C4.66697 12.3336 4.66697 11.8744 4.4009 11.6018C4.12045 11.322 3.65303 11.322 3.37258 11.5946L2.33708 12.6206ZM8.7227 13.8117C8.7227 13.4242 8.39191 13.0942 8.0036 13.0942C7.60809 13.0942 7.2773 13.4242 7.2773 13.8117V15.2753C7.2773 15.6628 7.60809 16 8.0036 16C8.39191 16 8.7227 15.6628 8.7227 15.2753V13.8117Z" fill="currentColor"></path></svg><span>light Mode</span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All KB articles</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/are_materialized_views_inserted_asynchronously">Are Materialized Views inserted synchronously?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/async_vs_optimize_read_in_order">Synchronous data reading</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/en/faq/billing">Billing</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/calculate-pi-using-sql">It&#x27;s Pi Day! Let&#x27;s calculate pi using SQL</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/columnar-database">What is a columnar database?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/configure-a-user-setting">How to configure a setting for a user</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/connection_timeout_remote_remoteSecure">Code: 279. DB::NetException: All connection tries failed.</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/dbms-naming">What does “ClickHouse” mean?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/delete-old-data">Is it possible to delete old records from a ClickHouse table?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/exception-too-many-parts">DB::Exception: Too many parts (600). Merges are processing significantly slower than inserts</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/execute-system-queries-in-cloud">Execute SYSTEM statements on all nodes in ClickHouse Cloud</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/en/faq/integration/file-export">How do I export data from ClickHouse to a file?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/filtered-aggregates">Filtered aggregates in ClickHouse</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/how-do-i-contribute-code-to-clickhouse">How do I contribute code to ClickHouse?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/ignoring-incorrect-settings">Ignoring incorrect settings</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/improve-map-performance">Improving Map performance</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/ingest-parquet-files-in-s3">How to ingest Parquet files from an S3 bucket</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/json-import">How to import JSON into ClickHouse?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/key-value">Can I use ClickHouse as a key-value storage?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/mapreduce">Why not use something like MapReduce?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/en/faq/marketplace">Marketplace</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/maximum_number_of_tables_and_databases">How many maximum databases or tables is recommended in a ClickHouse cluster?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/en/faq/operations/multi-region-replication">Does ClickHouse support multi-region replication?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/mysql-to-parquet-csv-json">Export MySQL data to Parquet, CSV or JSON</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/en/faq/general/ne-tormozit">What does “не тормозит” mean?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/olap">What is OLAP?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/oracle-odbc">What if I have a problem with encodings when using Oracle via ODBC?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/parquet-to-csv-json">Converting Files from Parquet to CSV or JSON</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/postgresql-to-parquet-csv-json">Export PostgreSQL data to Parquet, CSV or JSON</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/production">Which ClickHouse version to use in production?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/send_logs_level">Capturing server logs of queries at the client</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/time-series">Can I use ClickHouse as a time-series database?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/en/faq/troubleshooting">Troubleshooting</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/useful-queries-for-troubleshooting">Useful queries for troubleshooting</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/user-permissions-on-cloud">How to check grants and standard permissions for default user in ClickHouse Cloud</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/who-is-using-clickhouse">Who is using ClickHouse?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/why-clickhouse-is-so-fast">Why is ClickHouse so fast?</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/docs/knowledgebase/execute-system-queries-in-cloud">Execute SYSTEM statements on all nodes in ClickHouse Cloud</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-03-23T00:04:08.000Z" itemprop="datePublished">March 23, 2023</time> · <!-- -->One min read</div></header><div class="markdown" itemprop="articleBody"><p>In order to execute the same query on all nodes of a ClickHouse Cloud service, we can use <a href="https://clickhouse.com/docs/en/sql-reference/table-functions/cluster/" target="_blank" rel="noopener noreferrer">clusterAllReplicas</a>.</p><p>For example, in order to get entries from a (node-local) system table from all nodes, you can use:</p><div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> clusterAllReplicas</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">default</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> system</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token keyword" style="color:rgb(86, 156, 214)">TABLE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Similarly, you can execute the same <a href="https://clickhouse.com/docs/en/sql-reference/statements/system/" target="_blank" rel="noopener noreferrer">SYSTEM statement</a> on all nodes with a single statement, by using the <a href="https://clickhouse.com/docs/en/sql-reference/distributed-ddl/" target="_blank" rel="noopener noreferrer">ON CLUSTER</a> clause:</p><div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">SYSTEM </span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> CLUSTER </span><span class="token keyword" style="color:rgb(86, 156, 214)">default</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>For example for <a href="https://clickhouse.com/docs/en/sql-reference/statements/system/#drop-filesystem-cache" target="_blank" rel="noopener noreferrer">dropping the filesystem cache</a> from all nodes, you can use:</p><div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">SYSTEM </span><span class="token keyword" style="color:rgb(86, 156, 214)">DROP</span><span class="token plain"> FILESYSTEM CACHE </span><span class="token keyword" style="color:rgb(86, 156, 214)">ON</span><span class="token plain"> CLUSTER </span><span class="token keyword" style="color:rgb(86, 156, 214)">default</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/docs/knowledgebase/en/faq/integration/file-export">How do I export data from ClickHouse to a file?</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-03-23T00:04:08.000Z" itemprop="datePublished">March 23, 2023</time> · <!-- -->2 min read</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="using-into-outfile-clause">Using INTO OUTFILE Clause<a href="#using-into-outfile-clause" class="hash-link" aria-label="Direct link to Using INTO OUTFILE Clause" title="Direct link to Using INTO OUTFILE Clause">​</a></h2><p>Add an <a href="https://clickhouse.com/docs/en/sql-reference/statements/select/into-outfile.md" target="_blank" rel="noopener noreferrer">INTO OUTFILE</a> clause to your query.</p><p>For example:</p><div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">table</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">INTO</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">OUTFILE</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;file&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>By default, ClickHouse uses the file extension of the filename to deteremine the output format and compression. For example, all of the rows in <code>nyc_taxi</code> will be exported to the <code>nyc_taxi.parquet</code> using the Parquet format:</p><div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> nyc_taxi</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">INTO</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">OUTFILE</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;taxi_rides.parquet&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>And the following file will be a compressed, tab-separated file:</p><div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> nyc_taxi</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">INTO</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">OUTFILE</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;taxi_rides.tsv.gz&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If ClickHouse can not determine the format from the file extension, then the output format defaults to <a href="https://clickhouse.com/docs/en/interfaces/formats.md" target="_blank" rel="noopener noreferrer">TabSeparated</a> for output data. To specify the <a href="https://clickhouse.com/docs/en/interfaces/formats.md" target="_blank" rel="noopener noreferrer">output format</a>, use the <a href="https://clickhouse.com/docs/en/sql-reference/statements/select/format.md" target="_blank" rel="noopener noreferrer">FORMAT clause</a>.</p><p>For example:</p><div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> nyc_taxi</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">INTO</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">OUTFILE</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;taxi_rides.txt&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">FORMAT CSV</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="using-a-file-engine-table">Using a File-Engine Table<a href="#using-a-file-engine-table" class="hash-link" aria-label="Direct link to Using a File-Engine Table" title="Direct link to Using a File-Engine Table">​</a></h2><p>Another option is to use the <a href="https://clickhouse.com/docs/en/engines/table-engines/special/file.md" target="_blank" rel="noopener noreferrer">File</a> table engine, where ClickHouse uses the file to store the data. You can perform queries and inserts directly on the file.</p><p>For example:</p><div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TABLE</span><span class="token plain"> my_table </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">   x UInt32</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">   y String</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">   z </span><span class="token keyword" style="color:rgb(86, 156, 214)">DateTime</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ENGINE</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">File</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">Parquet</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Insert a few rows:</p><div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">INTO</span><span class="token plain"> my_table </span><span class="token keyword" style="color:rgb(86, 156, 214)">VALUES</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">   </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;Hello&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">now</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">   </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;World&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">now</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">   </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">3</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;Goodbye&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">now</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The file is stored in the <code>data</code> folder of your ClickHouse server - specifically in <code>/data/default/my_table</code> in a file named <code>data.Parquet</code>.</p><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_WoCw"><div class="alert-icon admonitionIcon_Ibzs"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></div><div class="alert-content admonitionContent_vXIg"><div class="admonitionHeading_TMsN">note</div><p>Using the <code>File</code> table engine is incredibly handy for creating and querying files on your file system, but keep in mind that <code>File</code> tables are not <code>MergeTree</code> tables, so you don&#x27;t get all the benefits that come with <code>MergeTree</code>. Use <code>File</code> for convenience when exporting data out of ClickHouse in convenient formats.</p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="using-command-line-redirection">Using Command-Line Redirection<a href="#using-command-line-redirection" class="hash-link" aria-label="Direct link to Using Command-Line Redirection" title="Direct link to Using Command-Line Redirection">​</a></h2><div class="language-bash codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ clickhouse-client --query </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;SELECT * from table&quot;</span><span class="token plain"> --format FormatName </span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> result.txt</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>See <a href="https://clickhouse.com/docs/en/interfaces/cli.md" target="_blank" rel="noopener noreferrer">clickhouse-client</a>.</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/docs/knowledgebase/filtered-aggregates">Filtered aggregates in ClickHouse</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-03-23T00:04:08.000Z" itemprop="datePublished">March 23, 2023</time> · <!-- -->One min read</div></header><div class="markdown" itemprop="articleBody"><p>ClickHouse provides a simple and intuitive way to write <em>filtered aggregates</em>. For example, compare the standard SQL way to write filtered aggregates (which work fine in ClickHouse) with the shorthand syntax using the <code>-If</code> <a href="https://clickhouse.com/docs/en/sql-reference/aggregate-functions/combinators/" target="_blank" rel="noopener noreferrer">aggregate function combinator</a>, which can be appended to any aggregate function:</p><div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">--standard SQL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">   </span><span class="token function" style="color:rgb(220, 220, 170)">avg</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">number</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">FILTER </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> number </span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">50</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> numbers</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">100</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">--ClickHouse using an aggregate combinator</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">   avgIf</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">number</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> number </span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">50</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> numbers</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">100</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Similarly, there is a <code>-Distinct</code> aggregate combinator:</p><div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">--standard SQL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">avg</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">DISTINCT</span><span class="token plain"> number</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">--ClickHouse using an aggregate combinator</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> avgDistinct</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">number</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Why are filtered aggregates are important? Because they allow you to implement the <strong>&quot;segment comparison&quot;</strong> feature in web analytics services.
For example:</p><div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">WITH</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">   Region </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;us&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> segment1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">   Browser </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;Chrome&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> segment2</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">   uniqIf</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">UserID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> segment1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">   uniqIf</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">UserID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> segment2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> segment1 </span><span class="token operator" style="color:rgb(212, 212, 212)">OR</span><span class="token plain"> segment2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Check out the <a href="https://clickhouse.com/docs/en/sql-reference/aggregate-functions/combinators/" target="_blank" rel="noopener noreferrer">aggregate function combinator</a> page in the docs
for more details.</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/docs/knowledgebase/how-do-i-contribute-code-to-clickhouse">How do I contribute code to ClickHouse?</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-03-23T00:04:08.000Z" itemprop="datePublished">March 23, 2023</time> · <!-- -->One min read</div></header><div class="markdown" itemprop="articleBody"><p>ClickHouse is an open-source project <a href="https://github.com/ClickHouse/ClickHouse" target="_blank" rel="noopener noreferrer">developed on GitHub</a>.</p><p>As customary, contribution instructions are published in <a href="https://github.com/ClickHouse/ClickHouse/blob/master/CONTRIBUTING" target="_blank" rel="noopener noreferrer">CONTRIBUTING</a> file in the root of the source code repository.</p><p>If you want to suggest a substantial change to ClickHouse, consider <a href="https://github.com/ClickHouse/ClickHouse/issues/new/choose" target="_blank" rel="noopener noreferrer">opening a GitHub issue</a> explaining what you want to do, to discuss it with maintainers and community first. <a href="https://github.com/ClickHouse/ClickHouse/issues?q=is%3Aissue+is%3Aopen+rfc" target="_blank" rel="noopener noreferrer">Examples of such RFC issues</a>.</p><p>If your contributions are security related, please check out <a href="https://github.com/ClickHouse/ClickHouse/security/policy/" target="_blank" rel="noopener noreferrer">our security policy</a> too.</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/docs/knowledgebase/ignoring-incorrect-settings">Ignoring incorrect settings</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-03-23T00:04:08.000Z" itemprop="datePublished">March 23, 2023</time> · <!-- -->One min read</div></header><div class="markdown" itemprop="articleBody"><p>When a user-level setting is specified in the wrong place, the server won&#x27;t start and an exception message is sent to the log. However, you can tell ClickHouse to ignore the incorrect setting using the <code>skip_check_for_incorrect_settings</code> setting:</p><p>Add the following to <code>config.xml</code>:</p><div class="language-xml codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">skip_check_for_incorrect_settings</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain">1</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;/</span><span class="token tag" style="color:rgb(78, 201, 176)">skip_check_for_incorrect_settings</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_WoCw"><div class="alert-icon admonitionIcon_Ibzs"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></div><div class="alert-content admonitionContent_vXIg"><div class="admonitionHeading_TMsN">note</div><p>User-level settings should be specified in <code>users.xml</code> inside a <code>&lt;profile&gt;</code> section for the specific user profile, (or in <code>&lt;default&gt;</code> for default settings.</p></div></div></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/docs/knowledgebase/improve-map-performance">Improving Map performance</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-03-23T00:04:08.000Z" itemprop="datePublished">March 23, 2023</time> · <!-- -->3 min read</div></header><div class="markdown" itemprop="articleBody"><p><strong>Problem</strong></p><p>Map lookup such as <code>a[&#x27;key&#x27;]</code> works with linear complexity (mentioned <a href="https://clickhouse.com/docs/en/sql-reference/data-types/map" target="_blank" rel="noopener noreferrer">here</a>) and can be inefficient. This is because selecting a value with a specific key from a table would require iterating through all keys (~M) across all rows (N) in the Map column, resulting in ~MxN lookups.</p><p>A lookup using Map can be 10x slower than a String column. The experiment below also shows ~10x slowdown for cold query, and difference in multiple magnitudes of data processed (7.21 MB vs 5.65 GB).</p><div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">-- create table with SpanNAme as String and ResourceAttributes as Map</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">DROP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TABLE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">IF</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">EXISTS</span><span class="token plain"> tbl</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TABLE</span><span class="token plain"> tbl </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token identifier">Timestamp</span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token plain"> DateTime64</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">9</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> CODEC </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">Delta</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">8</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> ZSTD</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token identifier">TraceId</span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token plain"> String CODEC </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ZSTD</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token identifier">ServiceName</span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token plain"> LowCardinality</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">String</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> CODEC </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ZSTD</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token identifier">Duration</span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token plain"> UInt8 CODEC </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ZSTD</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Int64</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token identifier">SpanName</span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token plain"> LowCardinality</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">String</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> CODEC </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ZSTD</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token identifier">ResourceAttributes</span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token plain"> Map</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">LowCardinality</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">String</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> String</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> CODEC </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ZSTD</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ENGINE</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> MergeTree</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">PARTITION</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> toDate</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">Timestamp</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ServiceName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> SpanName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> toUnixTimestamp</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">Timestamp</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> TraceId</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- create UDF to generate random Map data for ResourceAttributes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">DROP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">FUNCTION</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">IF</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">EXISTS</span><span class="token plain"> genmap</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">FUNCTION</span><span class="token plain"> genmap </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">n</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> arrayMap </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">x</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">x::String</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">x</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain">rand32</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">::String</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> range</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> n</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- check that genmap is working as intended</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> genmap</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">10</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">::Map</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">String</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> String</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- insert 1M rows</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">INTO</span><span class="token plain"> tbl</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token function" style="color:rgb(220, 220, 170)">now</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> randUniform</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1000000.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">Timestamp</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    randomPrintableASCII</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> TraceId</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    randomPrintableASCII</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> ServiceName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    rand32</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> Duration</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    randomPrintableASCII</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> SpanName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    genmap</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">rand64</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token operator" style="color:rgb(212, 212, 212)">%</span><span class="token number" style="color:rgb(181, 206, 168)">500</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">::Map</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">String</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> String</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> ResourceAttributes</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> numbers</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain">_000_000</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- querying for SpanName is faster</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- [cold] 0 rows in set. Elapsed: 0.642 sec. Processed 1.00 million rows, 7.21 MB (1.56 million rows/s., 11.22 MB/s.)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- [warm] 0 rows in set. Elapsed: 0.164 sec. Processed 1.00 million rows, 7.21 MB (6.10 million rows/s., 43.99 MB/s.)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token function" style="color:rgb(220, 220, 170)">COUNT</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token function" style="color:rgb(220, 220, 170)">avg</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">Duration</span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain">E6</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> average</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    quantile</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">0.95</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">Duration</span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain">E6</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> p95</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    quantile</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">0.99</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">Duration</span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain">E6</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> p99</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    SpanName</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> tbl</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> SpanName </span><span class="token keyword" style="color:rgb(86, 156, 214)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">DESC</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">50</span><span class="token plain"> FORMAT </span><span class="token boolean">Null</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- query for ResourceAttributes is slower</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- [cold] 0 rows in set. Elapsed: 6.432 sec. Processed 1.00 million rows, 5.65 GB (155.46 thousand rows/s., 879.07 MB/s.)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- [warm] 0 rows in set. Elapsed: 5.935 sec. Processed 1.00 million rows, 5.65 GB (168.50 thousand rows/s., 952.81 MB/s.)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token function" style="color:rgb(220, 220, 170)">COUNT</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token function" style="color:rgb(220, 220, 170)">avg</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">Duration</span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain">E6</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> average</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    quantile</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">0.95</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">Duration</span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain">E6</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> p95</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    quantile</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">0.99</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">Duration</span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain">E6</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> p99</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    ResourceAttributes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;1&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> hostname</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> tbl</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> hostname </span><span class="token keyword" style="color:rgb(86, 156, 214)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">DESC</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">50</span><span class="token plain"> FORMAT </span><span class="token boolean">Null</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>Solution</strong>
To improve the query, we can add another column with the value defaulting to a particular key in the Map column, and then materializing it to populate value for existing rows. This way, we extract and store the necessary value at insertion time, thereby speeding up the lookup at query time.</p><div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">-- solution is to add a column with value defaulting to a particular key in Map</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TABLE</span><span class="token plain"> tbl </span><span class="token keyword" style="color:rgb(86, 156, 214)">ADD</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">COLUMN</span><span class="token plain"> hostname LowCardinality</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">String</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">DEFAULT</span><span class="token plain"> ResourceAttributes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;1&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TABLE</span><span class="token plain"> tbl MATERIALIZE </span><span class="token keyword" style="color:rgb(86, 156, 214)">COLUMN</span><span class="token plain"> hostname</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- query for hostname (new column) is now faster</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- [cold] 0 rows in set. Elapsed: 2.215 sec. Processed 1.00 million rows, 21.67 MB (451.52 thousand rows/s., 9.78 MB/s.)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- [warm] 0 rows in set. Elapsed: 0.541 sec. Processed 1.00 million rows, 21.67 MB (1.85 million rows/s., 40.04 MB/s.)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token function" style="color:rgb(220, 220, 170)">COUNT</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token function" style="color:rgb(220, 220, 170)">avg</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">Duration</span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain">E6</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> average</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    quantile</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">0.95</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">Duration</span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain">E6</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> p95</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    quantile</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">0.99</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">Duration</span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain">E6</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> p99</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    hostname</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> tbl</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> hostname </span><span class="token keyword" style="color:rgb(86, 156, 214)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">DESC</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">50</span><span class="token plain"> FORMAT </span><span class="token boolean">Null</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- drop cache to run query cold</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">SYSTEM </span><span class="token keyword" style="color:rgb(86, 156, 214)">DROP</span><span class="token plain"> FILESYSTEM CACHE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/docs/knowledgebase/ingest-parquet-files-in-s3">How to ingest Parquet files from an S3 bucket</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-03-23T00:04:08.000Z" itemprop="datePublished">March 23, 2023</time> · <!-- -->3 min read</div></header><div class="markdown" itemprop="articleBody"><p>Below are some basics of using the S3 table engine to read parquet files.</p><ul><li><p>create access and secret keys for an IAM service user.
normal login users usually don&#x27;t work since they may have been configured with an MFA policy.</p></li><li><p>set the permissions on the policy to allow the service user to access the bucket and folders.</p></li></ul><p>The following is a very simple example that you can use to test the mechanics of accessing your parquet files successfully prior to applying to your actual data.</p><p>If you need an example of creating a user and bucket, you can follow the first two sections (create user and create bucket):
<a href="https://clickhouse.com/docs/en/guides/sre/configuring-s3-for-clickhouse-use/" target="_blank" rel="noopener noreferrer">https://clickhouse.com/docs/en/guides/sre/configuring-s3-for-clickhouse-use/</a></p><p>I used this sample file: <a href="https://github.com/Teradata/kylo/tree/master/samples/sample-data/parquet" target="_blank" rel="noopener noreferrer">https://github.com/Teradata/kylo/tree/master/samples/sample-data/parquet</a>
and uploaded it to my test bucket</p><p>You can set the policy something like this on the bucket:
(adjust as needed, this one is fairly open for privileges but will help in testing. you can narrow your permissions as necessary)</p><div class="codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">{</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    &quot;Version&quot;: &quot;2012-10-17&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    &quot;Id&quot;: &quot;Policy123456&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    &quot;Statement&quot;: [</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            &quot;Sid&quot;: &quot;abc123&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            &quot;Effect&quot;: &quot;Allow&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            &quot;Principal&quot;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                &quot;AWS&quot;: [</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    &quot;arn:aws:iam::1234567890:user/mars-s3-user&quot;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                ]</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            &quot;Action&quot;: &quot;s3:*&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            &quot;Resource&quot;: [</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                &quot;arn:aws:s3:::mars-doc-test&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                &quot;arn:aws:s3:::mars-doc-test/*&quot;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            ]</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You can run queries with this type of syntax using the S3 table engine:
<a href="https://clickhouse.com/docs/en/sql-reference/table-functions/s3/" target="_blank" rel="noopener noreferrer">https://clickhouse.com/docs/en/sql-reference/table-functions/s3/</a></p><div class="codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">clickhouse-cloud :)  select count(*) from s3(&#x27;https://mars-doc-test.s3.amazonaws.com/s3-parquet-test/userdata1.parquet&#x27;,&#x27;ABC123&#x27;, &#x27;abc+123&#x27;, &#x27;Parquet&#x27;, &#x27;first_name String&#x27;);</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">SELECT count(*)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">FROM s3(&#x27;https://mars-doc-test.s3.amazonaws.com/s3-parquet-test/userdata1.parquet&#x27;, &#x27;ABC123&#x27;, &#x27;abc+123&#x27;, &#x27;Parquet&#x27;, &#x27;first_name String&#x27;)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Query id: fd4f1193-d604-4ac0-9a46-bdd2d5e14727</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">┌─count()─┐</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│    1000 │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">└─────────┘</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">1 row in set. Elapsed: 1.274 sec. Processed 1.00 thousand rows, 14.64 KB (784.81 rows/s., 11.49 KB/s.)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The data types reference for parquet format are here:
<a href="https://clickhouse.com/docs/en/interfaces/formats/#data-format-parquet" target="_blank" rel="noopener noreferrer">https://clickhouse.com/docs/en/interfaces/formats/#data-format-parquet</a></p><p>To bring in the data into a native ClickHouse table:</p><p>create the table, something like this (just chose a couple of the columns in the parquet file):</p><div class="codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">clickhouse-cloud :) CREATE TABLE my_parquet_table (id UInt64, first_name String) ENGINE = MergeTree ORDER BY id;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">CREATE TABLE my_parquet_table</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">(</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    `id` UInt64,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    `first_name` String</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">ENGINE = MergeTree</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">ORDER BY id</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Query id: 412e3994-bf8e-444e-ac43-a7c82642b7da</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Ok.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">0 rows in set. Elapsed: 0.600 sec.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Select the data from the S3 bucket to insert into the new table:</p><div class="codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">clickhouse-cloud :) INSERT INTO my_parquet_table (id, first_name) SELECT id, first_name FROM s3(&#x27;https://mars-doc-test.s3.amazonaws.com/s3-parquet-test/userdata1.parquet&#x27;, &#x27;ABC123&#x27;,&#x27;abc+123&#x27;, &#x27;Parquet&#x27;, &#x27;id UInt64, first_name String&#x27;) FORMAT Parquet</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">INSERT INTO my_parquet_table (id, first_name) SELECT</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    id,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    first_name</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">FROM s3(&#x27;https://mars-doc-test.s3.amazonaws.com/s3-parquet-test/userdata1.parquet&#x27;, &#x27;ABC123&#x27;, &#x27;abc+123&#x27;, &#x27;Parquet&#x27;, &#x27;id UInt64, first_name String&#x27;)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Query id: c3cdc871-f338-462d-8797-6751b45a0b58</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Ok.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">0 rows in set. Elapsed: 1.220 sec. Processed 1.00 thousand rows, 22.64 KB (819.61 rows/s., 18.56 KB/s.)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Verify the import:</p><div class="codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">clickhouse-cloud :) SELECT * FROM my_parquet_table LIMIT 10;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">SELECT *</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">FROM my_parquet_table</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">LIMIT 10</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Query id: 1ccf59dd-d804-46a9-aadd-ed5c57b9e1a0</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">┌─id─┬─first_name─┐</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│  1 │ Amanda     │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│  2 │ Albert     │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│  3 │ Evelyn     │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│  4 │ Denise     │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│  5 │ Carlos     │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│  6 │ Kathryn    │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│  7 │ Samuel     │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│  8 │ Harry      │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│  9 │ Jose       │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">│ 10 │ Emily      │</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">└────┴────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>When you are ready to import your real data, you can use some special syntax like wildcards and ranges to specify your folders, subfolders and files in your bucket.
I&#x27;d recommend to filter a few directories and files to test the import, maybe a certain year, a couple months and some date range to test first.</p><p>besides the path options here, newly released is syntax <code>**</code> which specifies all subdirectories recursively.
<a href="https://clickhouse.com/docs/en/sql-reference/table-functions/s3/" target="_blank" rel="noopener noreferrer">https://clickhouse.com/docs/en/sql-reference/table-functions/s3/</a></p><p>For example, assuming the paths and bucket structure is something like this:
<code>https://your_s3_bucket.s3.amazonaws.com/&lt;your_folder&gt;/&lt;year&gt;/&lt;month&gt;/&lt;day&gt;/&lt;filename&gt;.parquet</code>
<code>https://mars-doc-test.s3.amazonaws.com/system_logs/2022/11/01/my-app-logs-0001.parquet</code></p><p>This would get all files for 1st day of every month in 2021-2022
<code>https://mars-doc-test.s3.amazonaws.com/system_logs/{2021-2022}/**/01/*.parquet</code></p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/docs/knowledgebase/json-import">How to import JSON into ClickHouse?</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-03-23T00:04:08.000Z" itemprop="datePublished">March 23, 2023</time> · <!-- -->One min read</div></header><div class="markdown" itemprop="articleBody"><p>ClickHouse supports a wide range of <a href="https://clickhouse.com/docs/en/interfaces/formats/" target="_blank" rel="noopener noreferrer">data formats for input and output</a>. There are multiple JSON variations among them, but the most commonly used for data ingestion is <a href="https://clickhouse.com/docs/en/interfaces/formats/#jsoneachrow" target="_blank" rel="noopener noreferrer">JSONEachRow</a>. It expects one JSON object per row, each object separated by a newline.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="examples">Examples<a href="#examples" class="hash-link" aria-label="Direct link to Examples" title="Direct link to Examples">​</a></h2><p>Using <a href="https://clickhouse.com/docs/en/interfaces/http/" target="_blank" rel="noopener noreferrer">HTTP interface</a>:</p><div class="language-bash codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ </span><span class="token builtin class-name" style="color:rgb(78, 201, 176)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;{&quot;foo&quot;:&quot;bar&quot;}&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">curl</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;http://localhost:8123/?query=INSERT%20INTO%20test%20FORMAT%20JSONEachRow&#x27;</span><span class="token plain"> --data-binary @-</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Using <a href="https://clickhouse.com/docs/en/interfaces/cli/" target="_blank" rel="noopener noreferrer">CLI interface</a>:</p><div class="language-bash codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ </span><span class="token builtin class-name" style="color:rgb(78, 201, 176)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;{&quot;foo&quot;:&quot;bar&quot;}&#x27;</span><span class="token plain">  </span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain"> clickhouse-client --query</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;INSERT INTO test FORMAT JSONEachRow&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Instead of inserting data manually, you might consider to use one of <a href="https://clickhouse.com/docs/en/interfaces/" target="_blank" rel="noopener noreferrer">client libraries</a> instead.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="useful-settings">Useful Settings<a href="#useful-settings" class="hash-link" aria-label="Direct link to Useful Settings" title="Direct link to Useful Settings">​</a></h2><ul><li><code>input_format_skip_unknown_fields</code> allows to insert JSON even if there were additional fields not present in table schema (by discarding them).</li><li><code>input_format_import_nested_json</code> allows to insert nested JSON objects into columns of <a href="https://clickhouse.com/docs/en/sql-reference/data-types/nested-data-structures/nested/" target="_blank" rel="noopener noreferrer">Nested</a> type.</li></ul><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_WoCw"><div class="alert-icon admonitionIcon_Ibzs"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></div><div class="alert-content admonitionContent_vXIg"><div class="admonitionHeading_TMsN">note</div><p>Settings are specified as <code>GET</code> parameters for the HTTP interface or as additional command-line arguments prefixed with <code>--</code> for the <code>CLI</code> interface.</p></div></div></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/docs/knowledgebase/key-value">Can I use ClickHouse as a key-value storage?</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-03-23T00:04:08.000Z" itemprop="datePublished">March 23, 2023</time> · <!-- -->2 min read</div></header><div class="markdown" itemprop="articleBody"><p>The short answer is <strong>“no”</strong>. The key-value workload is among top positions in the list of cases when <span class="text-danger"><strong>NOT</strong></span> to use ClickHouse. It’s an <a href="https://clickhouse.com/docs/en/faq/general/olap" target="_blank" rel="noopener noreferrer">OLAP</a> system after all, while there are many excellent key-value storage systems out there.</p><p>However, there might be situations where it still makes sense to use ClickHouse for key-value-like queries. Usually, it’s some low-budget products where the main workload is analytical in nature and fits ClickHouse well, but there’s also some secondary process that needs a key-value pattern with not so high request throughput and without strict latency requirements. If you had an unlimited budget, you would have installed a secondary key-value database for this secondary workload, but in reality, there’s an additional cost of maintaining one more storage system (monitoring, backups, etc.) which might be desirable to avoid.</p><p>If you decide to go against recommendations and run some key-value-like queries against ClickHouse, here are some tips:</p><ul><li>The key reason why point queries are expensive in ClickHouse is its sparse primary index of main <a href="https://clickhouse.com/docs/en//engines/table-engines/mergetree-family/mergetree" target="_blank" rel="noopener noreferrer">MergeTree table engine family</a>. This index can’t point to each specific row of data, instead, it points to each N-th and the system has to scan from the neighboring N-th row to the desired one, reading excessive data along the way. In a key-value scenario, it might be useful to reduce the value of N with the <code>index_granularity</code> setting.</li><li>ClickHouse keeps each column in a separate set of files, so to assemble one complete row it needs to go through each of those files. Their count increases linearly with the number of columns, so in the key-value scenario, it might be worth avoiding using many columns and put all your payload in a single <code>String</code> column encoded in some serialization format like JSON, Protobuf, or whatever makes sense.</li><li>There’s an alternative approach that uses <a href="https://clickhouse.com/docs/en/engines/table-engines/special/join" target="_blank" rel="noopener noreferrer">Join</a> table engine instead of normal <code>MergeTree</code> tables and <a href="https://clickhouse.com/docs/en/sql-reference/functions/other-functions/#joinget" target="_blank" rel="noopener noreferrer">joinGet</a> function to retrieve the data. It can provide better query performance but might have some usability and reliability issues. Here’s an <a href="https://github.com/ClickHouse/ClickHouse/blob/master/tests/queries/0_stateless/00800_versatile_storage_join.sql#L49-L51" target="_blank" rel="noopener noreferrer">usage example</a>.</li></ul></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/docs/knowledgebase/mapreduce">Why not use something like MapReduce?</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-03-23T00:04:08.000Z" itemprop="datePublished">March 23, 2023</time> · <!-- -->2 min read</div></header><div class="markdown" itemprop="articleBody"><p>We can refer to systems like MapReduce as distributed computing systems in which the reduce operation is based on distributed sorting. The most common open-source solution in this class is <a href="http://hadoop.apache.org" target="_blank" rel="noopener noreferrer">Apache Hadoop</a>.</p><p>These systems aren’t appropriate for online queries due to their high latency. In other words, they can’t be used as the back-end for a web interface. These types of systems aren’t useful for real-time data updates. Distributed sorting isn’t the best way to perform reduce operations if the result of the operation and all the intermediate results (if there are any) are located in the RAM of a single server, which is usually the case for online queries. In such a case, a hash table is an optimal way to perform reduce operations. A common approach to optimizing map-reduce tasks is pre-aggregation (partial reduce) using a hash table in RAM. The user performs this optimization manually. Distributed sorting is one of the main causes of reduced performance when running simple map-reduce tasks.</p><p>Most MapReduce implementations allow you to execute arbitrary code on a cluster. But a declarative query language is better suited to OLAP to run experiments quickly. For example, Hadoop has Hive and Pig. Also consider Cloudera Impala or Shark (outdated) for Spark, as well as Spark SQL, Presto, and Apache Drill. Performance when running such tasks is highly sub-optimal compared to specialized systems, but relatively high latency makes it unrealistic to use these systems as the backend for a web interface.</p></div></article><nav class="pagination-nav" aria-label="Blog list page navigation"><a class="pagination-nav__link pagination-nav__link--prev paginationNavLink_UdUv" href="/docs/knowledgebase"><svg width="24" height="25" viewBox="0 0 24 25" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9.2751 19.175L10.3251 18.125L5.4501 13.25H21.6001V11.75H5.4501L10.3251 6.87501L9.2751 5.82501L2.5751 12.5L9.2751 19.175Z" fill="currentColor"></path></svg><div class="paginationNavContent__3xr"><div class="paginationNavLabel_YPzM pagination-nav__label">Newer Entries</div></div></a><a class="pagination-nav__link pagination-nav__link--next paginationNavLink_UdUv" href="/docs/knowledgebase/page/3"><div class="paginationNavContent__3xr"><div class="paginationNavLabel_YPzM pagination-nav__label">Older Entries</div></div><svg width="24" height="25" viewBox="0 0 24 25" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14.7249 19.175L13.6749 18.125L18.5499 13.25H2.3999V11.75H18.5499L13.6749 6.87501L14.7249 5.82501L21.4249 12.5L14.7249 19.175Z" fill="currentColor"></path></svg></a></nav></main></div></div></div><footer class="footer footer_jryj"><div class="container_y1z5 container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">© 2016&ndash;2023 ClickHouse, Inc.</div></div><div><div class="footer__links text--center"><div class="footer__links"><a href="https://clickhouse.com/legal/trademark-policy" target="_blank" rel="noopener noreferrer" class="footer__link-item">Trademark</a><span class="footer__link-separator">·</span><a href="https://clickhouse.com/legal/privacy-policy" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy</a><span class="footer__link-separator">·</span><a href="https://trust.clickhouse.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Security</a><span class="footer__link-separator">·</span><a href="https://clickhouse.com/legal/agreements/terms-of-service" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms of Service</a></div></div></div></div><button class="colorModeButton_hk25"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M8.7227 0.724664C8.7227 0.330045 8.39191 0 8.0036 0C7.60809 0 7.2773 0.330045 7.2773 0.724664V2.18834C7.2773 2.57578 7.60809 2.90583 8.0036 2.90583C8.39191 2.90583 8.7227 2.57578 8.7227 2.18834V0.724664ZM11.5991 3.4009C11.3258 3.67354 11.3258 4.13274 11.6063 4.41256C11.8796 4.6852 12.347 4.69238 12.6274 4.40538L13.6629 3.3722C13.9434 3.09238 13.9362 2.62601 13.6629 2.34619C13.3897 2.07354 12.9222 2.08072 12.649 2.35336L11.5991 3.4009ZM3.37258 4.40538C3.64584 4.6852 4.11326 4.6852 4.38652 4.41256C4.66697 4.14709 4.66697 3.66637 4.4009 3.4009L3.3582 2.35336C3.09213 2.08789 2.61753 2.07354 2.34427 2.34619C2.07101 2.62601 2.06382 3.09238 2.33708 3.36502L3.37258 4.40538ZM7.9964 11.774C10.0602 11.774 11.7717 10.0664 11.7717 8C11.7717 5.93363 10.0602 4.22601 7.9964 4.22601C5.93258 4.22601 4.22112 5.93363 4.22112 8C4.22112 10.0664 5.93258 11.774 7.9964 11.774ZM7.9964 10.4395C6.65888 10.4395 5.55146 9.33453 5.55146 8C5.55146 6.66547 6.65888 5.56054 7.9964 5.56054C9.33393 5.56054 10.4413 6.66547 10.4413 8C10.4413 9.33453 9.33393 10.4395 7.9964 10.4395ZM15.2809 8.71749C15.6692 8.71749 16 8.38744 16 8C16 7.60538 15.6692 7.28251 15.2809 7.28251H13.8211C13.4328 7.28251 13.102 7.60538 13.102 8C13.102 8.38744 13.4328 8.71749 13.8211 8.71749H15.2809ZM0.719101 7.28251C0.330787 7.28251 0 7.60538 0 8C0 8.38744 0.330787 8.71749 0.719101 8.71749H2.17888C2.57438 8.71749 2.90517 8.38744 2.90517 8C2.90517 7.60538 2.57438 7.28251 2.17888 7.28251H0.719101ZM12.6202 11.5946C12.347 11.322 11.8796 11.322 11.5991 11.5946C11.3258 11.8744 11.3258 12.3336 11.6063 12.6135L12.649 13.6538C12.9294 13.9265 13.3897 13.9193 13.6701 13.6395C13.9434 13.3668 13.9434 12.9076 13.6629 12.6278L12.6202 11.5946ZM2.33708 12.6206C2.05663 12.9004 2.05663 13.3668 2.3227 13.6395C2.60315 13.9121 3.07056 13.9193 3.34382 13.6466L4.38652 12.6135C4.66697 12.3336 4.66697 11.8744 4.4009 11.6018C4.12045 11.322 3.65303 11.322 3.37258 11.5946L2.33708 12.6206ZM8.7227 13.8117C8.7227 13.4242 8.39191 13.0942 8.0036 13.0942C7.60809 13.0942 7.2773 13.4242 7.2773 13.8117V15.2753C7.2773 15.6628 7.60809 16 8.0036 16C8.39191 16 8.7227 15.6628 8.7227 15.2753V13.8117Z" fill="currentColor"></path></svg><span>light Mode</span></button></footer></div>
<script src="/docs/assets/js/runtime~main.a5ff7323.js"></script>
<script src="/docs/assets/js/main.5e929b39.js"></script>
</body>
</html>