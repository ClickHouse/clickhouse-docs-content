<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">ClickHouse Knowledge Base | ClickHouse Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://clickhouse.com/docs/img/logo.png"><meta data-rh="true" name="twitter:image" content="https://clickhouse.com/docs/img/logo.png"><meta data-rh="true" property="og:url" content="https://clickhouse.com/docs/knowledgebase/page/3"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" property="og:title" content="ClickHouse Knowledge Base | ClickHouse Docs"><meta data-rh="true" name="description" content="Knowledge Base"><meta data-rh="true" property="og:description" content="Knowledge Base"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="/docs/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://clickhouse.com/docs/knowledgebase/page/3"><link data-rh="true" rel="alternate" href="https://clickhouse.com/docs/knowledgebase/page/3" hreflang="en"><link data-rh="true" rel="alternate" href="https://clickhouse.com/docs/knowledgebase/page/3" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/docs/knowledgebase/rss.xml" title="ClickHouse Knowledge Base Feed RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/docs/knowledgebase/atom.xml" title="ClickHouse Knowledge Base Feed Atom Feed">
<link rel="alternate" type="application/json" href="/docs/knowledgebase/feed.json" title="ClickHouse Knowledge Base Feed JSON Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-KF1LLRTQ5Q"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-KF1LLRTQ5Q",{})</script>


<link rel="search" type="application/opensearchdescription+xml" title="ClickHouse Docs" href="/docs/opensearch.xml">





<script src="/docs/js/analytics.js"></script><link rel="stylesheet" href="/docs/assets/css/styles.d4633d58.css">
<link rel="preload" href="/docs/assets/js/runtime~main.3c6ad612.js" as="script">
<link rel="preload" href="/docs/assets/js/main.b8d4548e.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top navBar_gvJn"><div class="navbarHeaderContainer_rccn navbar-header"><div class="navbar__inner navbarInner_W6bg"><div class="navbar__items"><a href="https://clickhouse.com/" target="_blank" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/docs/img/logo_without_text.svg" alt="ClickHouse" class="themedImage_ToTc themedImage--light_HNdA"><img src="/docs/img/logo_without_text.svg" alt="ClickHouse" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">ClickHouse</b></a><div class="navbarItemsList_uIZ2 navbar-items-list"><div class="navbar__item dropdown"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link ch-menu">Product</a><ul class="dropdown__menu"><li><a href="https://clickhouse.com/cloud" target="_blank" rel="noopener noreferrer" class="dropdown__link">ClickHouse Cloud</a></li><li><a href="https://clickhouse.com/clickhouse" target="_blank" rel="noopener noreferrer" class="dropdown__link">ClickHouse Open Source</a></li></ul></div><a href="https://clickhouse.com/customer-stories" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link ch-menu">Use Cases</a><div class="navbar__item dropdown"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link ch-menu">Company</a><ul class="dropdown__menu"><li><a href="https://clickhouse.com/blog" target="_blank" rel="noopener noreferrer" class="dropdown__link">Blog</a></li><li><a href="https://clickhouse.com/company/our-story" target="_blank" rel="noopener noreferrer" class="dropdown__link">Our story</a></li><li><a href="https://clickhouse.com/company/careers" target="_blank" rel="noopener noreferrer" class="dropdown__link">Careers</a></li><li><a href="https://clickhouse.com/company/contact" target="_blank" rel="noopener noreferrer" class="dropdown__link">Contact us</a></li><li><a href="https://clickhouse.com/company/news-events" target="_blank" rel="noopener noreferrer" class="dropdown__link">News and events</a></li></ul></div><div class="navbar__item dropdown"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link ch-menu">Learn</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/en/intro">Docs</a></li><li><a href="https://clickhouse.com/learn" target="_blank" rel="noopener noreferrer" class="dropdown__link">ClickHouse Academy</a></li></ul></div><a href="https://clickhouse.com/pricing" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link ch-menu">Pricing</a></div></div><div class="navbar__items navbar__items--right"><div class="navbar__item">
                <div class="nav-items-btns">
                  <a href="https://clickhouse.cloud/signIn" class="sign-in navbar__item navbar__link ch-menu">
                    Sign in
                  </a>
                  <a href="https://clickhouse.cloud/signUp" class="click-button-anchor">
                    <button class="click-button primary-btn">Free Trial</button>
                  </a>
                </div></div><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button></div></div><div class="secondary-nav--items secondaryMenu_iuff"><div class="scrollableElement_Qqzp secondaryMenuLeft_tFZR secondary-nav--items-left"><a class="navbar__item navbar__link ch-menu" href="/docs/en/intro">Docs</a><a class="navbar__item navbar__link ch-menu" href="/docs/en/cloud/overview">Cloud</a><a class="navbar__item navbar__link ch-menu" href="/docs/en/sql-reference">SQL Reference</a><a aria-current="page" class="navbar__item navbar__link ch-menu navbar__link--active" href="/docs/knowledgebase">Knowledge Base</a></div><div class="secondaryMenuRight__9m4 secondary-nav--items-right"><div class="navbar__item dropdown dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg width="14" height="13" viewBox="0 0 14 13" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M6.95 12.6496L9.75 5.26628H11.0333L13.8333 12.6496H12.55L11.9 10.7663H8.91667L8.25 12.6496H6.95ZM9.28333 9.69961H11.5L10.4167 6.64961H10.3667L9.28333 9.69961ZM2.08333 10.7996L1.21667 9.93294L4.33333 6.83294C3.94444 6.39961 3.60556 5.95228 3.31667 5.49094C3.02778 5.03005 2.77222 4.54405 2.55 4.03294H3.83333C4.02222 4.41072 4.22222 4.74672 4.43333 5.04094C4.64444 5.33561 4.89444 5.64405 5.18333 5.96628C5.63889 5.47739 6.01667 4.97472 6.31667 4.45828C6.61667 3.94139 6.86667 3.3885 7.06667 2.79961H0.25V1.58294H4.55V0.349609H5.78333V1.58294H10.0833V2.79961H8.3C8.07778 3.53294 7.78333 4.24116 7.41667 4.92428C7.05 5.60783 6.59444 6.25516 6.05 6.86628L7.53333 8.36628L7.06667 9.63294L5.16667 7.73294L2.08333 10.7996Z" fill="currentColor"/>
</svg></a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/en/intro">English</a></li><li><a class="dropdown__link" href="/docs/ru">Russian</a></li><li><a class="dropdown__link" href="/docs/zh">Chinese</a></li></ul></div><button class="colorModeButton_hk25 navbar-color-toggle"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M8.7227 0.724664C8.7227 0.330045 8.39191 0 8.0036 0C7.60809 0 7.2773 0.330045 7.2773 0.724664V2.18834C7.2773 2.57578 7.60809 2.90583 8.0036 2.90583C8.39191 2.90583 8.7227 2.57578 8.7227 2.18834V0.724664ZM11.5991 3.4009C11.3258 3.67354 11.3258 4.13274 11.6063 4.41256C11.8796 4.6852 12.347 4.69238 12.6274 4.40538L13.6629 3.3722C13.9434 3.09238 13.9362 2.62601 13.6629 2.34619C13.3897 2.07354 12.9222 2.08072 12.649 2.35336L11.5991 3.4009ZM3.37258 4.40538C3.64584 4.6852 4.11326 4.6852 4.38652 4.41256C4.66697 4.14709 4.66697 3.66637 4.4009 3.4009L3.3582 2.35336C3.09213 2.08789 2.61753 2.07354 2.34427 2.34619C2.07101 2.62601 2.06382 3.09238 2.33708 3.36502L3.37258 4.40538ZM7.9964 11.774C10.0602 11.774 11.7717 10.0664 11.7717 8C11.7717 5.93363 10.0602 4.22601 7.9964 4.22601C5.93258 4.22601 4.22112 5.93363 4.22112 8C4.22112 10.0664 5.93258 11.774 7.9964 11.774ZM7.9964 10.4395C6.65888 10.4395 5.55146 9.33453 5.55146 8C5.55146 6.66547 6.65888 5.56054 7.9964 5.56054C9.33393 5.56054 10.4413 6.66547 10.4413 8C10.4413 9.33453 9.33393 10.4395 7.9964 10.4395ZM15.2809 8.71749C15.6692 8.71749 16 8.38744 16 8C16 7.60538 15.6692 7.28251 15.2809 7.28251H13.8211C13.4328 7.28251 13.102 7.60538 13.102 8C13.102 8.38744 13.4328 8.71749 13.8211 8.71749H15.2809ZM0.719101 7.28251C0.330787 7.28251 0 7.60538 0 8C0 8.38744 0.330787 8.71749 0.719101 8.71749H2.17888C2.57438 8.71749 2.90517 8.38744 2.90517 8C2.90517 7.60538 2.57438 7.28251 2.17888 7.28251H0.719101ZM12.6202 11.5946C12.347 11.322 11.8796 11.322 11.5991 11.5946C11.3258 11.8744 11.3258 12.3336 11.6063 12.6135L12.649 13.6538C12.9294 13.9265 13.3897 13.9193 13.6701 13.6395C13.9434 13.3668 13.9434 12.9076 13.6629 12.6278L12.6202 11.5946ZM2.33708 12.6206C2.05663 12.9004 2.05663 13.3668 2.3227 13.6395C2.60315 13.9121 3.07056 13.9193 3.34382 13.6466L4.38652 12.6135C4.66697 12.3336 4.66697 11.8744 4.4009 11.6018C4.12045 11.322 3.65303 11.322 3.37258 11.5946L2.33708 12.6206ZM8.7227 13.8117C8.7227 13.4242 8.39191 13.0942 8.0036 13.0942C7.60809 13.0942 7.2773 13.4242 7.2773 13.8117V15.2753C7.2773 15.6628 7.60809 16 8.0036 16C8.39191 16 8.7227 15.6628 8.7227 15.2753V13.8117Z" fill="currentColor"></path></svg><span>light Mode</span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All KB articles</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/cannot-append-data-to-parquet-format">DB::Exception: Cannot append data in format Parquet to file, because this format doesn&#x27;t support appends. (CANNOT_APPEND_TO_FILE)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/how_to_display_queries_using_MV">What queries are using Materialized Views?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/importing_and_working_with_JSON_array_objects">Importing and querying JSON array objects</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/recreate_table_across_terminals">How to quickly recreate a small table across different terminals</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/s3_export_data_year_month_folders">How can I do partitioned writes by year and month on S3?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/which-processes-are-currently-running">How to check what code is currently running on a server?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/file-export">How do I export data from ClickHouse to a file?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/ingest-parquet-files-in-s3">How to ingest Parquet files from an S3 bucket</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/parquet-to-csv-json">Converting Files from Parquet to CSV or JSON</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/postgresql-to-parquet-csv-json">Export PostgreSQL data to Parquet, CSV or JSON</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/mysql-to-parquet-csv-json">Export MySQL data to Parquet, CSV or JSON</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/connection_timeout_remote_remoteSecure">Code: 279. DB::NetException: All connection tries failed.</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/exception-too-many-parts">DB::Exception: Too many parts (600). Merges are processing significantly slower than inserts</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/json-import">How to import JSON into ClickHouse?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/useful-queries-for-troubleshooting">Useful queries for troubleshooting</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/calculate-pi-using-sql">It&#x27;s Pi Day! Let&#x27;s calculate pi using SQL</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/are_materialized_views_inserted_asynchronously">Are Materialized Views inserted synchronously?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/async_vs_optimize_read_in_order">Synchronous data reading</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/configure-a-user-setting">How to configure a setting for a user</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/execute-system-queries-in-cloud">Execute SYSTEM statements on all nodes in ClickHouse Cloud</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/filtered-aggregates">Filtered aggregates in ClickHouse</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/how-to-increase-thread-pool-size">How to increase the number of threads available?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/ignoring-incorrect-settings">Ignoring incorrect settings</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/send_logs_level">Capturing server logs of queries at the client</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/billing">Billing</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/marketplace">Marketplace</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/troubleshooting">Troubleshooting</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/user-permissions-on-cloud">How to check grants and standard permissions for default user in ClickHouse Cloud</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/improve-map-performance">Improving Map performance</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/delete-old-data">Is it possible to delete old records from a ClickHouse table?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/multi-region-replication">Does ClickHouse support multi-region replication?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/oracle-odbc">What if I have a problem with encodings when using Oracle via ODBC?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/columnar-database">What is a columnar database?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/dbms-naming">What does “ClickHouse” mean?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/how-do-i-contribute-code-to-clickhouse">How do I contribute code to ClickHouse?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/key-value">Can I use ClickHouse as a key-value storage?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/mapreduce">Why not use something like MapReduce?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/maximum_number_of_tables_and_databases">How many maximum databases or tables is recommended in a ClickHouse cluster?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/ne-tormozit">What Does “Не тормозит” Mean?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/olap">What is OLAP?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/production">Which ClickHouse version to use in production?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/time-series">Can I use ClickHouse as a time-series database?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/who-is-using-clickhouse">Who is using ClickHouse?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/knowledgebase/why-clickhouse-is-so-fast">Why is ClickHouse so fast?</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/docs/knowledgebase/filtered-aggregates">Filtered aggregates in ClickHouse</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-03-01T00:00:00.000Z" itemprop="datePublished">March 1, 2023</time> · <!-- -->One min read</div></header><div class="markdown" itemprop="articleBody"><p>ClickHouse provides a simple and intuitive way to write <em>filtered aggregates</em>. For example, compare the standard SQL way to write filtered aggregates (which work fine in ClickHouse) with the shorthand syntax using the <code>-If</code> <a href="https://clickhouse.com/docs/en/sql-reference/aggregate-functions/combinators/" target="_blank" rel="noopener noreferrer">aggregate function combinator</a>, which can be appended to any aggregate function:</p><div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">--standard SQL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">   </span><span class="token function" style="color:rgb(220, 220, 170)">avg</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">number</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">FILTER </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> number </span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">50</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> numbers</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">100</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">--ClickHouse using an aggregate combinator</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">   avgIf</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">number</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> number </span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">50</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> numbers</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">100</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Similarly, there is a <code>-Distinct</code> aggregate combinator:</p><div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">--standard SQL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">avg</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">DISTINCT</span><span class="token plain"> number</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">--ClickHouse using an aggregate combinator</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> avgDistinct</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">number</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Why are filtered aggregates are important? Because they allow you to implement the <strong>&quot;segment comparison&quot;</strong> feature in web analytics services.
For example:</p><div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">WITH</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">   Region </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;us&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> segment1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">   Browser </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;Chrome&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> segment2</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">   uniqIf</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">UserID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> segment1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">   uniqIf</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">UserID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> segment2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">WHERE</span><span class="token plain"> segment1 </span><span class="token operator" style="color:rgb(212, 212, 212)">OR</span><span class="token plain"> segment2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Check out the <a href="https://clickhouse.com/docs/en/sql-reference/aggregate-functions/combinators/" target="_blank" rel="noopener noreferrer">aggregate function combinator</a> page in the docs
for more details.</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/docs/knowledgebase/how-to-increase-thread-pool-size">How to increase the number of threads available?</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-03-01T00:00:00.000Z" itemprop="datePublished">March 1, 2023</time> · <!-- -->One min read</div></header><div class="markdown" itemprop="articleBody"><p>ClickHouse uses threads from the <strong>Global Thread pool</strong> to process queries and also perform background operations like merges and mutations. If there is no idle thread to process a query, then a new thread is created in the pool.</p><p>The maximum size of the global thread pool is determined by the <code>max_thread_pool_size</code> setting, which defaults to 10,000. You can modify this value in your config - here we set it to 20,000:</p><div class="language-xml codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">max_thread_pool_size</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain">20000</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;/</span><span class="token tag" style="color:rgb(78, 201, 176)">max_thread_pool_size</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If you modify <code>max_thread_pool_size</code>, we recommend changing <code>thread_pool_queue_size</code> to be the same value. The <code>thread_pool_queue_size</code> setting is the maximum number of jobs that can be scheduled on the Global Thread pool:</p><div class="language-xml codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">thread_pool_queue_size</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain">20000</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;/</span><span class="token tag" style="color:rgb(78, 201, 176)">thread_pool_queue_size</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You can also free up resources if your server has a lot of idle threads - using the <code>max_thread_pool_free_size</code> setting. The default is 1,000, which means your Global Thread pool will never have more than 1,000 idle threads. The following example increases the value to 2,000:</p><div class="language-xml codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">max_thread_pool_free_size</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain">2000</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;/</span><span class="token tag" style="color:rgb(78, 201, 176)">max_thread_pool_free_size</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Check out the <a href="https://clickhouse.com/docs/en/operations/server-configuration-parameters/settings#max-thread-pool-size" target="_blank" rel="noopener noreferrer">docs</a> for more details on the settings above and other settings that affect the Global Thread pool.</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/docs/knowledgebase/ignoring-incorrect-settings">Ignoring incorrect settings</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-03-01T00:00:00.000Z" itemprop="datePublished">March 1, 2023</time> · <!-- -->One min read</div></header><div class="markdown" itemprop="articleBody"><p>When a user-level setting is specified in the wrong place, the server won&#x27;t start and an exception message is sent to the log. However, you can tell ClickHouse to ignore the incorrect setting using the <code>skip_check_for_incorrect_settings</code> setting:</p><p>Add the following to <code>config.xml</code>:</p><div class="language-xml codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">skip_check_for_incorrect_settings</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain">1</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;/</span><span class="token tag" style="color:rgb(78, 201, 176)">skip_check_for_incorrect_settings</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_WoCw"><div class="alert-icon admonitionIcon_Ibzs"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></div><div class="alert-content admonitionContent_vXIg"><div class="admonitionHeading_TMsN">note</div><p>User-level settings should be specified in <code>users.xml</code> inside a <code>&lt;profile&gt;</code> section for the specific user profile, (or in <code>&lt;default&gt;</code> for default settings.</p></div></div></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/docs/knowledgebase/send_logs_level">Capturing server logs of queries at the client</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-03-01T00:00:00.000Z" itemprop="datePublished">March 1, 2023</time> · <!-- -->One min read</div></header><div class="markdown" itemprop="articleBody"><p>A client can view the server logs - even at a different level than what the server log level is configured to - by setting the <code>send_logs_level</code> client setting.</p><p>For example, suppose the client runs:</p><div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">SET</span><span class="token plain"> send_logs_level </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;trace&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The client will receive trace logs even if the server has log level set to info.</p><p>One useful scenario is to use <code>send_logs_level</code> to monitor the insertion of rows into a <code>Distributed</code> table:</p><ul><li>Enable logs in <code>clickhouse-client</code> using <code>SET send_logs_level = &#x27;trace&#x27;;</code></li><li>Run your <code>INSERT</code> query</li><li>Inserts into a distributed table are asynchronous by default. The data is written into a local buffer on disk, then sent to remote servers in background.</li><li>Logs will be sent from all nodes participating in the query processing (distributed tracing)</li></ul><p>To check the status of distributed inserts, check the <a href="https://clickhouse.com/docs/en/operations/system-tables/distribution_queue/" target="_blank" rel="noopener noreferrer"><code>system.distribution_queue</code> table</a>. This table contains information about local files that are in the queue to be sent to the shards. These local files contain new parts that are created by inserting new data into the <code>Distributed</code> table in asynchronous mode.</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/docs/knowledgebase/billing">Billing</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-12-06T00:00:00.000Z" itemprop="datePublished">December 6, 2022</time> · <!-- -->One min read</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="pricing">Pricing<a href="#pricing" class="hash-link" aria-label="Direct link to Pricing" title="Direct link to Pricing">​</a></h2><p>For pricing information see the <a href="https://clickhouse.com/pricing" target="_blank" rel="noopener noreferrer">ClickHouse Cloud Pricing</a> page.  To understand what can affect your bill, and ways that you
can manage your spend, keep reading.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="examples">Examples<a href="#examples" class="hash-link" aria-label="Direct link to Examples" title="Direct link to Examples">​</a></h2><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_WoCw"><div class="alert-icon admonitionIcon_Ibzs"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></div><div class="alert-content admonitionContent_vXIg"><div class="admonitionHeading_TMsN">note</div><p>Prices reflect AWS <code>us-east-1</code> pricing.</p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="development-from-51-per-month">Development: From $51 per month<a href="#development-from-51-per-month" class="hash-link" aria-label="Direct link to Development: From $51 per month" title="Direct link to Development: From $51 per month">​</a></h3><p>Best for: Starter projects &amp; staging</p><ul><li>Development service</li><li>16 GiB RAM, 2 vCPU</li><li>1 TB Data</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="pricing-breakdown-for-this-example">Pricing breakdown for this example:<a href="#pricing-breakdown-for-this-example" class="hash-link" aria-label="Direct link to Pricing breakdown for this example:" title="Direct link to Pricing breakdown for this example:">​</a></h4><table><thead><tr><th></th><th align="right">10% active</th><th align="right">50% active</th><th align="right">Always on</th></tr></thead><tbody><tr><td>Compute</td><td align="right">$16</td><td align="right">$79</td><td align="right">$158</td></tr><tr><td>Storage</td><td align="right">$35</td><td align="right">$35</td><td align="right">$35</td></tr><tr><td>Total</td><td align="right">$51</td><td align="right">$114</td><td align="right">$193</td></tr></tbody></table><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_WoCw"><div class="alert-icon admonitionIcon_Ibzs"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></div><div class="alert-content admonitionContent_vXIg"><div class="admonitionHeading_TMsN">note</div><p>Consumption can be even lower if less than 1TB disk is used</p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="production-idling-auto-scaling-from-172-per-month">Production (Idling, Auto-scaling): From $172 per month<a href="#production-idling-auto-scaling-from-172-per-month" class="hash-link" aria-label="Direct link to Production (Idling, Auto-scaling): From $172 per month" title="Direct link to Production (Idling, Auto-scaling): From $172 per month">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="best-for-cost-sensitive-ad-hoc-analytics-applications">Best for: Cost-sensitive ad-hoc analytics applications<a href="#best-for-cost-sensitive-ad-hoc-analytics-applications" class="hash-link" aria-label="Direct link to Best for: Cost-sensitive ad-hoc analytics applications" title="Direct link to Best for: Cost-sensitive ad-hoc analytics applications">​</a></h4><ul><li>Production Service</li><li>Active workload ~25% time</li><li>Idling on with default settings</li><li>Auto-scaling maximum set to prevent runaway bills</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="pricing-breakdown-for-this-example-1">Pricing breakdown for this example:<a href="#pricing-breakdown-for-this-example-1" class="hash-link" aria-label="Direct link to Pricing breakdown for this example:" title="Direct link to Pricing breakdown for this example:">​</a></h4><table><thead><tr><th></th><th align="right">Small</th><th align="right">Medium</th><th align="right">Large</th></tr></thead><tbody><tr><td>Compute</td><td align="right">24 GiB RAM, 6 vCPU<br>$125</td><td align="right">192 GiB RAM, 48 vCPU<br>$1000</td><td align="right">720 GiB RAM, 180 vCPU<br>$3750</td></tr><tr><td>Storage</td><td align="right">1 TB Data<br>$47</td><td align="right">5 TB Data<br>$235</td><td align="right">10 TB Data<br>$470</td></tr><tr><td>Total</td><td align="right">$172</td><td align="right">$1,235</td><td align="right">$4,220</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="production-always-on-reserved-capacity-from-550-per-month">Production (Always-on, Reserved capacity): From $550 per month​<a href="#production-always-on-reserved-capacity-from-550-per-month" class="hash-link" aria-label="Direct link to Production (Always-on, Reserved capacity): From $550 per month​" title="Direct link to Production (Always-on, Reserved capacity): From $550 per month​">​</a></h3><p>Best for: Latency-sensitive applications</p><ul><li>Production Service</li><li>Active workload ~100% time</li><li>Auto-scaling minimum set to reserve capacity</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="pricing-breakdown-for-this-example-2">Pricing breakdown for this example:<a href="#pricing-breakdown-for-this-example-2" class="hash-link" aria-label="Direct link to Pricing breakdown for this example:" title="Direct link to Pricing breakdown for this example:">​</a></h4><table><thead><tr><th></th><th align="right">Small</th><th align="right">Medium</th><th align="right">Large</th></tr></thead><tbody><tr><td>Compute</td><td align="right">24 GiB RAM, 6 vCPU<br>$503</td><td align="right">96 GiB RAM, 24 vCPU<br>$2,012</td><td align="right">360 GiB RAM, 90 vCPU<br>$7,545</td></tr><tr><td>Storage</td><td align="right">1 TB Data<br>$47</td><td align="right">4 TB Data<br>$188</td><td align="right">8 TB Data<br>$376</td></tr><tr><td>Total</td><td align="right">$550</td><td align="right">$2,200</td><td align="right">$7,921</td></tr></tbody></table><p>For help with further estimation, please contact <a href="https://clickhouse.cloud/support" target="_blank" rel="noopener noreferrer">support</a> if you are already a ClickHouse Cloud user, or <a href="mailto:sales@clickhouse.com" target="_blank" rel="noopener noreferrer">sales@clickhouse.com</a> otherwise.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="faqs">FAQs<a href="#faqs" class="hash-link" aria-label="Direct link to FAQs" title="Direct link to FAQs">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-is-compute-metered">How is compute metered?<a href="#how-is-compute-metered" class="hash-link" aria-label="Direct link to How is compute metered?" title="Direct link to How is compute metered?">​</a></h3><p>ClickHouse Cloud meters compute on a per-minute basis, in 8G RAM increments.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-is-storage-on-disk-calculated">How is storage on disk calculated?<a href="#how-is-storage-on-disk-calculated" class="hash-link" aria-label="Direct link to How is storage on disk calculated?" title="Direct link to How is storage on disk calculated?">​</a></h3><p>ClickHouse Cloud uses cloud object storage and is metered on the compressed size of data stored in ClickHouse tables.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="do-backups-count-toward-total-storage">Do backups count toward total storage?<a href="#do-backups-count-toward-total-storage" class="hash-link" aria-label="Direct link to Do backups count toward total storage?" title="Direct link to Do backups count toward total storage?">​</a></h3><p>ClickHouse Cloud offers two free backups for production services, and one free backup for development services. Backups do not count toward storage.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-do-i-estimate-compression">How do I estimate compression?<a href="#how-do-i-estimate-compression" class="hash-link" aria-label="Direct link to How do I estimate compression?" title="Direct link to How do I estimate compression?">​</a></h3><p>Compression can vary quite a bit by dataset. It is dependent on how compressible the data is in the first place (number of high vs. low cardinality fields), and how the user sets up the schema (using optional codecs or not, for instance). It can be on the order of 10x for common types of analytical data, but it can be significantly lower or higher as well. See the <a href="/docs/en/optimize/asynchronous-inserts">optimizing</a> documentation for guidance and this <a href="https://www.uber.com/blog/logging/" target="_blank" rel="noopener noreferrer">Uber blog</a> for a detailed logging use case example.
The only practical way to know exactly is to ingest your dataset into ClickHouse and compare the size of the dataset with the size stored in ClickHouse.</p><p>You can use the query <code>SELECT formatReadableSize(total_bytes) FROM system.tables WHERE name = &lt;your table name&gt;</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-tools-does-clickhouse-offer-to-estimate-the-cost-of-running-a-service-in-the-cloud-if-i-have-a-self-managed-deployment">What tools does ClickHouse offer to estimate the cost of running a service in the cloud if I have a self-managed deployment?<a href="#what-tools-does-clickhouse-offer-to-estimate-the-cost-of-running-a-service-in-the-cloud-if-i-have-a-self-managed-deployment" class="hash-link" aria-label="Direct link to What tools does ClickHouse offer to estimate the cost of running a service in the cloud if I have a self-managed deployment?" title="Direct link to What tools does ClickHouse offer to estimate the cost of running a service in the cloud if I have a self-managed deployment?">​</a></h3><p>The ClickHouse query log captures <a href="/docs/en/operations/system-tables/query_log">key metrics</a> that can be used to estimate the cost of running a workload in ClickHouse Cloud.  For details on migrating from self-managed to ClickHouse Cloud please refer to the <a href="/docs/en/cloud/migration/clickhouse-to-cloud">migration documentation</a>, and contact <a href="https://clickhouse.cloud/support" target="_blank" rel="noopener noreferrer">ClickHouse Cloud support</a> if you have further questions.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-billing-options-are-available-for-clickhouse-cloud">What billing options are available for ClickHouse Cloud?<a href="#what-billing-options-are-available-for-clickhouse-cloud" class="hash-link" aria-label="Direct link to What billing options are available for ClickHouse Cloud?" title="Direct link to What billing options are available for ClickHouse Cloud?">​</a></h3><p>ClickHouse Cloud supports the following billing options:</p><ul><li>Self-service monthly (in USD, via credit card)</li><li>Direct-sales annual / multi-year (through pre-paid &quot;ClickHouse Credits&quot;, in USD, with additional payment options)</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-long-is-the-billing-cycle">How long is the billing cycle?<a href="#how-long-is-the-billing-cycle" class="hash-link" aria-label="Direct link to How long is the billing cycle?" title="Direct link to How long is the billing cycle?">​</a></h3><p>Billing follows a monthly billing cycle and the start date is tracked as the date when the ClickHouse Cloud organization was created.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-controls-does-clickhouse-cloud-offer-to-manage-costs-for-production-services">What controls does ClickHouse Cloud offer to manage costs for Production services?<a href="#what-controls-does-clickhouse-cloud-offer-to-manage-costs-for-production-services" class="hash-link" aria-label="Direct link to What controls does ClickHouse Cloud offer to manage costs for Production services?" title="Direct link to What controls does ClickHouse Cloud offer to manage costs for Production services?">​</a></h3><ul><li>Trial and Annual Commit customers will be notified with automated emails when the consumption hits certain thresholds - 50%, 75%, and 90%, so that users can take action.</li><li>ClickHouse Cloud allows users to set a maximum auto-scaling limit on their compute via <a href="/docs/en/manage/scaling">Advanced scaling control</a>, a significant cost factor for analytical workloads.</li><li>The <a href="/docs/en/manage/scaling">Advanced scaling control</a> lets you set memory limits with an option to control the behavior of pausing/idling during inactivity.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-controls-does-clickhouse-cloud-offer-to-manage-costs-for-developer-services">What controls does ClickHouse Cloud offer to manage costs for Developer services?<a href="#what-controls-does-clickhouse-cloud-offer-to-manage-costs-for-developer-services" class="hash-link" aria-label="Direct link to What controls does ClickHouse Cloud offer to manage costs for Developer services?" title="Direct link to What controls does ClickHouse Cloud offer to manage costs for Developer services?">​</a></h3><ul><li>The <a href="/docs/en/manage/scaling">Advanced scaling control</a> lets you control the behavior of pausing/idling during inactivity. Adjusting memory allocation is not supported for Developer services</li><li>Note that the default setting pauses the service after a period of inactivity</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="if-i-have-multiple-services-do-i-get-an-invoice-per-service-or-a-consolidated-invoice">If I have multiple services, do I get an invoice per service or a consolidated invoice?<a href="#if-i-have-multiple-services-do-i-get-an-invoice-per-service-or-a-consolidated-invoice" class="hash-link" aria-label="Direct link to If I have multiple services, do I get an invoice per service or a consolidated invoice?" title="Direct link to If I have multiple services, do I get an invoice per service or a consolidated invoice?">​</a></h3><p>A consolidated invoice is generated for all services in a given organization for a billing period.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="if-i-add-my-credit-card-and-upgrade-before-my-trial-period-and-credits-expire-will-i-be-charged">If I add my credit card and upgrade before my trial period and credits expire, will I be charged?<a href="#if-i-add-my-credit-card-and-upgrade-before-my-trial-period-and-credits-expire-will-i-be-charged" class="hash-link" aria-label="Direct link to If I add my credit card and upgrade before my trial period and credits expire, will I be charged?" title="Direct link to If I add my credit card and upgrade before my trial period and credits expire, will I be charged?">​</a></h3><p>When a user converts from trial to paid before the 30-day trial period ends, but with credits remaining from the trial credit allowance, we continue to draw down from the trial credits during the initial 30-day trial period, and then charge the credit card.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-can-i-keep-track-of-my-spending">How can I keep track of my spending?<a href="#how-can-i-keep-track-of-my-spending" class="hash-link" aria-label="Direct link to How can I keep track of my spending?" title="Direct link to How can I keep track of my spending?">​</a></h3><p>ClickHouse Cloud console includes a Usage display that gives detailed information about usage per service on compute and storage. This can be used to understand the cost breakdown by metered units.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-do-i-access-my-invoice-for-my-aws-marketplace-subscription-to-the-clickhouse-cloud-service">How do I access my invoice for my AWS marketplace subscription to the ClickHouse Cloud service?<a href="#how-do-i-access-my-invoice-for-my-aws-marketplace-subscription-to-the-clickhouse-cloud-service" class="hash-link" aria-label="Direct link to How do I access my invoice for my AWS marketplace subscription to the ClickHouse Cloud service?" title="Direct link to How do I access my invoice for my AWS marketplace subscription to the ClickHouse Cloud service?">​</a></h3><p>All marketplace subscriptions will be billed and invoiced by AWS. You can download the invoice from the AWS Billing Dashboard.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="why-do-the-dates-on-the-usage-statements-not-match-my-aws-marketplace-invoice">Why do the dates on the Usage statements not match my AWS Marketplace Invoice?<a href="#why-do-the-dates-on-the-usage-statements-not-match-my-aws-marketplace-invoice" class="hash-link" aria-label="Direct link to Why do the dates on the Usage statements not match my AWS Marketplace Invoice?" title="Direct link to Why do the dates on the Usage statements not match my AWS Marketplace Invoice?">​</a></h3><p>AWS Marketplace billing follows the calendar month cycle eg: For usage between dates 01-Dec-2022 and 01-Jan-2023, an invoice will be generated between 3-Jan - 5-Jan-2023</p><p>ClickHouse Cloud usage statements follow a different billing cycle where usage is metered and reported over 30 days starting from the day of sign up</p><p>The usage and invoice dates will differ if these dates are not the same. Since usage statements track usage by day for a given service, users can rely on statements to see the breakdown of costs.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-are-the-best-practices">What are the best practices?<a href="#what-are-the-best-practices" class="hash-link" aria-label="Direct link to What are the best practices?" title="Direct link to What are the best practices?">​</a></h3><p>There are several <a href="/docs/en/cloud/bestpractices/asynchronous-inserts">areas of optimization</a>, some of these are:</p><ul><li>Batching inserts  in place of frequent small-size inserts</li><li>Having fewer columns in tables</li><li>Choosing a <a href="/docs/en/engines/table-engines/mergetree-family/custom-partitioning-key">partition key</a> so that inserts go into a fewer number of partitions</li><li>Avoiding write-heavy operations in ClickHouse, such as mutations, OPTIMIZE FINAL, and Nullable columns</li></ul></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/docs/knowledgebase/marketplace">Marketplace</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-12-06T00:00:00.000Z" itemprop="datePublished">December 6, 2022</time> · <!-- -->One min read</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-can-i-start-using-clickhouse-cloud-connected-to-my-awsgcpazure-account-billing">How can I start using ClickHouse Cloud connected to my AWS/GCP/Azure account billing?<a href="#how-can-i-start-using-clickhouse-cloud-connected-to-my-awsgcpazure-account-billing" class="hash-link" aria-label="Direct link to How can I start using ClickHouse Cloud connected to my AWS/GCP/Azure account billing?" title="Direct link to How can I start using ClickHouse Cloud connected to my AWS/GCP/Azure account billing?">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="aws-gcp-and-azure-coming-soon">AWS (GCP and AZURE coming soon)<a href="#aws-gcp-and-azure-coming-soon" class="hash-link" aria-label="Direct link to AWS (GCP and AZURE coming soon)" title="Direct link to AWS (GCP and AZURE coming soon)">​</a></h3><ul><li>Log into the AWS console using your AWS account</li><li>Navigate to the <a href="https://aws.amazon.com/marketplace/pp/prodview-jettukeanwrfc" target="_blank" rel="noopener noreferrer">ClickHouse Cloud at aws marketplace</a></li><li>Click &quot;View purchase options&quot;</li><li>In the &quot;Contract Options&quot; section of the page, enter any number in the Units field. This will not affect the price your pay as the price for these units for the public offering is $0. These units are usually used when accepting a private offer from ClickHouse Cloud.</li><li>Click &quot;Create contract&quot;</li><li>Click &quot;Set up your account&quot;.</li><li>You will be redirected to the special aws marketplace ClickHouse Cloud login page. Please, complete your sign-in / sign-up at this page so we can bind your ClickHouse Cloud organization to AWS billing:<ul><li>If you are a new CH Cloud user, click &quot;Register&quot; at the bottom of the page. You will be prompted to create a new user and verify the email. After verifying your email, you can leave the ClickHouse Cloud login page and login using the new username at the <a href="https://clickhouse.cloud" target="_blank" rel="noopener noreferrer">https://clickhouse.cloud</a>.</li><li>If you are an existing CH Cloud user, simply log in using your credentials.</li></ul></li><li>After successful log in, a new ClickHouse Cloud organization will be created. This organization will be connected to your AWS billing account.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-can-i-understand-that-my-organization-is-connected-to-the-aws-marketplace-billing">How can I understand that my organization is connected to the aws marketplace billing?<a href="#how-can-i-understand-that-my-organization-is-connected-to-the-aws-marketplace-billing" class="hash-link" aria-label="Direct link to How can I understand that my organization is connected to the aws marketplace billing?" title="Direct link to How can I understand that my organization is connected to the aws marketplace billing?">​</a></h2><p>In ClickHouse Cloud console, navigate to <strong>Admin</strong> -&gt; <strong>Billing</strong>. You should see the name of the marketplace and the link in the <strong>Payment details section</strong></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="i-am-an-existing-clickhouse-cloud-user-what-will-happen-if-i-subscribe-to-the-ch-cloud-via-aws-marketplace">I am an existing ClickHouse Cloud user. What will happen if I subscribe to the CH Cloud via aws marketplace?<a href="#i-am-an-existing-clickhouse-cloud-user-what-will-happen-if-i-subscribe-to-the-ch-cloud-via-aws-marketplace" class="hash-link" aria-label="Direct link to I am an existing ClickHouse Cloud user. What will happen if I subscribe to the CH Cloud via aws marketplace?" title="Direct link to I am an existing ClickHouse Cloud user. What will happen if I subscribe to the CH Cloud via aws marketplace?">​</a></h2><p>A separate organization connected to the marketplace will be created. Your existing services and organizations will remain and they will not be connected to the marketplace billing.</p><p>You can switch between organizations in the top right corner of the ClickHouse Cloud console.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="i-am-an-existing-clickhouse-cloud-user-and-i-want-my-existing-services-to-be-billed-via-marketplace">I am an existing ClickHouse Cloud user and I want my existing services to be billed via marketplace.<a href="#i-am-an-existing-clickhouse-cloud-user-and-i-want-my-existing-services-to-be-billed-via-marketplace" class="hash-link" aria-label="Direct link to I am an existing ClickHouse Cloud user and I want my existing services to be billed via marketplace." title="Direct link to I am an existing ClickHouse Cloud user and I want my existing services to be billed via marketplace.">​</a></h2><p>Please contact <a href="https://clickhouse.cloud/support" target="_blank" rel="noopener noreferrer">ClickHouse Cloud support</a> in this case.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="i-subscribed-as-a-marketplace-user-and-now-i-want-to-unsubscribe-from-the-clickhouse-cloud">I subscribed as a marketplace user and now I want to unsubscribe from the ClickHouse Cloud.<a href="#i-subscribed-as-a-marketplace-user-and-now-i-want-to-unsubscribe-from-the-clickhouse-cloud" class="hash-link" aria-label="Direct link to I subscribed as a marketplace user and now I want to unsubscribe from the ClickHouse Cloud." title="Direct link to I subscribed as a marketplace user and now I want to unsubscribe from the ClickHouse Cloud.">​</a></h2><p>Note that you can simply stop using ClickHouse Cloud and delete all existing ClickHouse Cloud services. Even though the subscription will still be active, you will not be paying anything as ClickHouse Cloud doesn&#x27;t have any recurring fees.</p><p>If you want to unsubscribe, please navigate to the Cloud Provider console and cancel the subscription renewal there. Once the subscription ends, all existing services will be stopped and you will be prompted to add a credit card. If no card was added, after two weeks all existing services will be deleted.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="previously-i-subscribed-to-clickhouse-cloud-as-a-marketplace-user-then-i-unsubscribed-but-now-i-want-to-subscribe-back">Previously I subscribed to ClickHouse Cloud as a marketplace user, then I unsubscribed, but now I want to subscribe back.<a href="#previously-i-subscribed-to-clickhouse-cloud-as-a-marketplace-user-then-i-unsubscribed-but-now-i-want-to-subscribe-back" class="hash-link" aria-label="Direct link to Previously I subscribed to ClickHouse Cloud as a marketplace user, then I unsubscribed, but now I want to subscribe back." title="Direct link to Previously I subscribed to ClickHouse Cloud as a marketplace user, then I unsubscribed, but now I want to subscribe back.">​</a></h2><p>In that case please subscribe to the ClickHouse Cloud as usual (see &quot;How can I start using ClickHouse Cloud connected to my AWS/GCP/Azure account billing?&quot;). Note that a new ClickHouse Cloud organization will be created and connected to the marketplace.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-do-i-access-my-invoice-for-my-aws-marketplace-subscription-to-the-clickhouse-cloud-service">How do I access my invoice for my AWS marketplace subscription to the ClickHouse Cloud service?<a href="#how-do-i-access-my-invoice-for-my-aws-marketplace-subscription-to-the-clickhouse-cloud-service" class="hash-link" aria-label="Direct link to How do I access my invoice for my AWS marketplace subscription to the ClickHouse Cloud service?" title="Direct link to How do I access my invoice for my AWS marketplace subscription to the ClickHouse Cloud service?">​</a></h2><p>All marketplace subscriptions will be billed and invoiced by AWS. You can download the invoice from the AWS Billing Dashboard.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="why-do-the-dates-on-the-usage-statements-not-match-my-aws-marketplace-invoice">Why do the dates on the Usage statements not match my AWS Marketplace Invoice?<a href="#why-do-the-dates-on-the-usage-statements-not-match-my-aws-marketplace-invoice" class="hash-link" aria-label="Direct link to Why do the dates on the Usage statements not match my AWS Marketplace Invoice?" title="Direct link to Why do the dates on the Usage statements not match my AWS Marketplace Invoice?">​</a></h3><p>AWS Marketplace billing follows the calendar month cycle.  For example, for usage between December 1st and January 1st, an invoice will be generated between January 3rd and January 5th</p><p>ClickHouse Cloud usage statements follow a different billing cycle where usage is metered and reported over 30 days starting from the day of sign up</p><p>The usage and invoice dates will differ if these dates are not the same. Since usage statements track usage by day for a given service, users can rely on statements to see the breakdown of costs.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="where-can-i-find-general-billing-information">Where can I find general billing information<a href="#where-can-i-find-general-billing-information" class="hash-link" aria-label="Direct link to Where can I find general billing information" title="Direct link to Where can I find general billing information">​</a></h2><p>Please see the <a href="/docs/en/manage/billing">billing</a> documentation.</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/docs/knowledgebase/troubleshooting">Troubleshooting</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-12-06T00:00:00.000Z" itemprop="datePublished">December 6, 2022</time> · <!-- -->One min read</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="clickhouse-cloud-troubleshooting">ClickHouse Cloud Troubleshooting<a href="#clickhouse-cloud-troubleshooting" class="hash-link" aria-label="Direct link to ClickHouse Cloud Troubleshooting" title="Direct link to ClickHouse Cloud Troubleshooting">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="unable-to-access-a-clickhouse-cloud-service">Unable to access a ClickHouse Cloud service<a href="#unable-to-access-a-clickhouse-cloud-service" class="hash-link" aria-label="Direct link to Unable to access a ClickHouse Cloud service" title="Direct link to Unable to access a ClickHouse Cloud service">​</a></h3><p>If you are seeing an error message like one of these, your IP Access List may be denying access:</p><div class="language-response codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-response codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">curl: (35) error:02FFF036:system library:func(4095):Connection reset by peer</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>or</p><div class="language-response codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-response codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">curl: (35) LibreSSL SSL_connect: SSL_ERROR_SYSCALL in connection to HOSTNAME.clickhouse.cloud:8443</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>or</p><div class="language-response codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-response codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">Code: 210. DB::NetException: SSL connection unexpectedly closed (e46453teek.us-east-2.aws.clickhouse-staging.com:9440). (NETWORK_ERROR)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Check the <a href="https://clickhouse.com/docs/en/cloud/security/ip-access-list.md" target="_blank" rel="noopener noreferrer">IP Access List</a>, if you are attempting to connect from outside the allowed list then your connection will fail.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="self-managed-clickhouse-troubleshooting">Self-managed ClickHouse Troubleshooting<a href="#self-managed-clickhouse-troubleshooting" class="hash-link" aria-label="Direct link to Self-managed ClickHouse Troubleshooting" title="Direct link to Self-managed ClickHouse Troubleshooting">​</a></h2><ul><li><a href="#troubleshooting-installation-errors">Installation</a></li><li><a href="#troubleshooting-accepts-no-connections">Connecting to the server</a></li><li><a href="#troubleshooting-does-not-process-queries">Query processing</a></li><li><a href="#troubleshooting-too-slow">Efficiency of query processing</a></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="troubleshooting-installation-errors">Installation<a href="#troubleshooting-installation-errors" class="hash-link" aria-label="Direct link to Installation" title="Direct link to Installation">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="you-cannot-get-deb-packages-from-clickhouse-repository-with-apt-get">You Cannot Get Deb Packages from ClickHouse Repository with Apt-get<a href="#you-cannot-get-deb-packages-from-clickhouse-repository-with-apt-get" class="hash-link" aria-label="Direct link to You Cannot Get Deb Packages from ClickHouse Repository with Apt-get" title="Direct link to You Cannot Get Deb Packages from ClickHouse Repository with Apt-get">​</a></h3><ul><li>Check firewall settings.</li><li>If you cannot access the repository for any reason, download packages as described in the <a href="/docs/en/install">install guide</a> article and install them manually using the <code>sudo dpkg -i &lt;packages&gt;</code> command. You will also need the <code>tzdata</code> package.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="you-cannot-update-deb-packages-from-clickhouse-repository-with-apt-get">You Cannot Update Deb Packages from ClickHouse Repository with Apt-get<a href="#you-cannot-update-deb-packages-from-clickhouse-repository-with-apt-get" class="hash-link" aria-label="Direct link to You Cannot Update Deb Packages from ClickHouse Repository with Apt-get" title="Direct link to You Cannot Update Deb Packages from ClickHouse Repository with Apt-get">​</a></h3><ul><li>The issue may be happened when the GPG key is changed.</li></ul><p>Please use the following scripts to resolve the issue:</p><div class="language-bash codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token function" style="color:rgb(220, 220, 170)">sudo</span><span class="token plain"> apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 8919F6BD2B48D754</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token function" style="color:rgb(220, 220, 170)">sudo</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">apt-get</span><span class="token plain"> update</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="you-get-different-warnings-with-apt-get-update">You Get Different Warnings with <code>apt-get update</code><a href="#you-get-different-warnings-with-apt-get-update" class="hash-link" aria-label="Direct link to you-get-different-warnings-with-apt-get-update" title="Direct link to you-get-different-warnings-with-apt-get-update">​</a></h3><ul><li>The completed warning messages are as one of following:</li></ul><div class="codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">N: Skipping acquire of configured file &#x27;main/binary-i386/Packages&#x27; as repository &#x27;https://packages.clickhouse.com/deb stable InRelease&#x27; doesn&#x27;t support architecture &#x27;i386&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">E: Failed to fetch https://packages.clickhouse.com/deb/dists/stable/main/binary-amd64/Packages.gz  File has unexpected size (30451 != 28154). Mirror sync in progress?</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">E: Repository &#x27;https://packages.clickhouse.com/deb stable InRelease&#x27; changed its &#x27;Origin&#x27; value from &#x27;Artifactory&#x27; to &#x27;ClickHouse&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">E: Repository &#x27;https://packages.clickhouse.com/deb stable InRelease&#x27; changed its &#x27;Label&#x27; value from &#x27;Artifactory&#x27; to &#x27;ClickHouse&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">N: Repository &#x27;https://packages.clickhouse.com/deb stable InRelease&#x27; changed its &#x27;Suite&#x27; value from &#x27;stable&#x27; to &#x27;&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">N: This must be accepted explicitly before updates for this repository can be applied. See apt-secure(8) manpage for details.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">Err:11 https://packages.clickhouse.com/deb stable InRelease</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  400  Bad Request [IP: 172.66.40.249 443]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>To resolve the above issue, please use the following script:</p><div class="language-bash codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token function" style="color:rgb(220, 220, 170)">sudo</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">rm</span><span class="token plain"> /var/lib/apt/lists/packages.clickhouse.com_* /var/lib/dpkg/arch /var/lib/apt/lists/partial/packages.clickhouse.com_*</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token function" style="color:rgb(220, 220, 170)">sudo</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">apt-get</span><span class="token plain"> clean</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token function" style="color:rgb(220, 220, 170)">sudo</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">apt-get</span><span class="token plain"> autoclean</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="you-cant-get-packages-with-yum-because-of-wrong-signature">You Can&#x27;t Get Packages With Yum Because Of Wrong Signature<a href="#you-cant-get-packages-with-yum-because-of-wrong-signature" class="hash-link" aria-label="Direct link to You Can&#x27;t Get Packages With Yum Because Of Wrong Signature" title="Direct link to You Can&#x27;t Get Packages With Yum Because Of Wrong Signature">​</a></h3><p>Possible issue: the cache is wrong, maybe it&#x27;s broken after updated GPG key in 2022-09.</p><p>The solution is to clean out the cache and lib directory for yum:</p><div class="codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">sudo find /var/lib/yum/repos/ /var/cache/yum/ -name &#x27;clickhouse-*&#x27; -type d -exec rm -rf {} +</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">sudo rm -f /etc/yum.repos.d/clickhouse.repo</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>After that follow the <a href="/docs/en/install#from-rpm-packages">install guide</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="troubleshooting-accepts-no-connections">Connecting to the Server<a href="#troubleshooting-accepts-no-connections" class="hash-link" aria-label="Direct link to Connecting to the Server" title="Direct link to Connecting to the Server">​</a></h2><p>Possible issues:</p><ul><li>The server is not running.</li><li>Unexpected or wrong configuration parameters.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="server-is-not-running">Server Is Not Running<a href="#server-is-not-running" class="hash-link" aria-label="Direct link to Server Is Not Running" title="Direct link to Server Is Not Running">​</a></h3><p><strong>Check if server is running</strong></p><p>Command:</p><div class="language-bash codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ </span><span class="token function" style="color:rgb(220, 220, 170)">sudo</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">service</span><span class="token plain"> clickhouse-server status</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If the server is not running, start it with the command:</p><div class="language-bash codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ </span><span class="token function" style="color:rgb(220, 220, 170)">sudo</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">service</span><span class="token plain"> clickhouse-server start</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>Check logs</strong></p><p>The main log of <code>clickhouse-server</code> is in <code>/var/log/clickhouse-server/clickhouse-server.log</code> by default.</p><p>If the server started successfully, you should see the strings:</p><ul><li><code>&lt;Information&gt; Application: starting up.</code> — Server started.</li><li><code>&lt;Information&gt; Application: Ready for connections.</code> — Server is running and ready for connections.</li></ul><p>If <code>clickhouse-server</code> start failed with a configuration error, you should see the <code>&lt;Error&gt;</code> string with an error description. For example:</p><div class="language-text codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">2019.01.11 15:23:25.549505 [ 45 ] {} &lt;Error&gt; ExternalDictionaries: Failed reloading &#x27;event2id&#x27; external dictionary: Poco::Exception. Code: 1000, e.code() = 111, e.displayText() = Connection refused, e.what() = Connection refused</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If you do not see an error at the end of the file, look through the entire file starting from the string:</p><div class="language-text codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">&lt;Information&gt; Application: starting up.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If you try to start a second instance of <code>clickhouse-server</code> on the server, you see the following log:</p><div class="language-text codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">2019.01.11 15:25:11.151730 [ 1 ] {} &lt;Information&gt; : Starting ClickHouse 19.1.0 with revision 54413</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">2019.01.11 15:25:11.154578 [ 1 ] {} &lt;Information&gt; Application: starting up</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">2019.01.11 15:25:11.156361 [ 1 ] {} &lt;Information&gt; StatusFile: Status file ./status already exists - unclean restart. Contents:</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">PID: 8510</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Started at: 2019-01-11 15:24:23</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Revision: 54413</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">2019.01.11 15:25:11.156673 [ 1 ] {} &lt;Error&gt; Application: DB::Exception: Cannot lock file ./status. Another server instance in same directory is already running.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">2019.01.11 15:25:11.156682 [ 1 ] {} &lt;Information&gt; Application: shutting down</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">2019.01.11 15:25:11.156686 [ 1 ] {} &lt;Debug&gt; Application: Uninitializing subsystem: Logging Subsystem</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">2019.01.11 15:25:11.156716 [ 2 ] {} &lt;Information&gt; BaseDaemon: Stop SignalListener thread</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>See system.d logs</strong></p><p>If you do not find any useful information in <code>clickhouse-server</code> logs or there aren’t any logs, you can view <code>system.d</code> logs using the command:</p><div class="language-bash codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ </span><span class="token function" style="color:rgb(220, 220, 170)">sudo</span><span class="token plain"> journalctl -u clickhouse-server</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>Start clickhouse-server in interactive mode</strong></p><div class="language-bash codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ </span><span class="token function" style="color:rgb(220, 220, 170)">sudo</span><span class="token plain"> -u clickhouse /usr/bin/clickhouse-server --config-file /etc/clickhouse-server/config.xml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This command starts the server as an interactive app with standard parameters of the autostart script. In this mode <code>clickhouse-server</code> prints all the event messages in the console.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="configuration-parameters">Configuration Parameters<a href="#configuration-parameters" class="hash-link" aria-label="Direct link to Configuration Parameters" title="Direct link to Configuration Parameters">​</a></h3><p>Check:</p><ul><li><p>Docker settings.</p><p>If you run ClickHouse in Docker in an IPv6 network, make sure that <code>network=host</code> is set.</p></li><li><p>Endpoint settings.</p><p>Check <a href="/docs/en/operations/server-configuration-parameters/settings#server_configuration_parameters-listen_host">listen_host</a> and <a href="/docs/en/operations/server-configuration-parameters/settings#server_configuration_parameters-tcp_port">tcp_port</a> settings.</p><p>ClickHouse server accepts localhost connections only by default.</p></li><li><p>HTTP protocol settings.</p><p>Check protocol settings for the HTTP API.</p></li><li><p>Secure connection settings.</p><p>Check:</p><ul><li>The <a href="/docs/en/operations/server-configuration-parameters/settings#server_configuration_parameters-tcp_port_secure">tcp_port_secure</a> setting.</li><li>Settings for <a href="/docs/en/operations/server-configuration-parameters/settings#server_configuration_parameters-openssl">SSL certificates</a>.</li></ul><p>Use proper parameters while connecting. For example, use the <code>port_secure</code> parameter with <code>clickhouse_client</code>.</p></li><li><p>User settings.</p><p>You might be using the wrong user name or password.</p></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="troubleshooting-does-not-process-queries">Query Processing<a href="#troubleshooting-does-not-process-queries" class="hash-link" aria-label="Direct link to Query Processing" title="Direct link to Query Processing">​</a></h2><p>If ClickHouse is not able to process the query, it sends an error description to the client. In the <code>clickhouse-client</code> you get a description of the error in the console. If you are using the HTTP interface, ClickHouse sends the error description in the response body. For example:</p><div class="language-bash codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ </span><span class="token function" style="color:rgb(220, 220, 170)">curl</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;http://localhost:8123/&#x27;</span><span class="token plain"> --data-binary </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;SELECT a&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Code: </span><span class="token number" style="color:rgb(181, 206, 168)">47</span><span class="token plain">, e.displayText</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> DB::Exception: Unknown identifier: a. Note that there are no tables </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">FROM clause</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> your query, context: required_names: </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;a&#x27;</span><span class="token plain"> source_tables: table_aliases: private_aliases: column_aliases: public_columns: </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;a&#x27;</span><span class="token plain"> masked_columns: array_join_columns: source_columns: , e.what</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> DB::Exception</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If you start <code>clickhouse-client</code> with the <code>stack-trace</code> parameter, ClickHouse returns the server stack trace with the description of an error.</p><p>You might see a message about a broken connection. In this case, you can repeat the query. If the connection breaks every time you perform the query, check the server logs for errors.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="troubleshooting-too-slow">Efficiency of Query Processing<a href="#troubleshooting-too-slow" class="hash-link" aria-label="Direct link to Efficiency of Query Processing" title="Direct link to Efficiency of Query Processing">​</a></h2><p>If you see that ClickHouse is working too slowly, you need to profile the load on the server resources and network for your queries.</p><p>You can use the clickhouse-benchmark utility to profile queries. It shows the number of queries processed per second, the number of rows processed per second, and percentiles of query processing times.</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/docs/knowledgebase/user-permissions-on-cloud">How to check grants and standard permissions for default user in ClickHouse Cloud</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-12-06T00:00:00.000Z" itemprop="datePublished">December 6, 2022</time> · <!-- -->One min read</div></header><div class="markdown" itemprop="articleBody"><p>You can check the current privileges and permission (RBAC) for default user and other users&#x27; max privileges in <a href="https://github.com/ClickHouse/data-plane-application/blob/main/clickhouse-operator/util/clickhouseclient/database_user_supervisor.go#L54" target="_blank" rel="noopener noreferrer">this part of the data plane code</a></p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/docs/knowledgebase/improve-map-performance">Improving Map performance</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-10-30T00:00:00.000Z" itemprop="datePublished">October 30, 2022</time> · <!-- -->3 min read</div></header><div class="markdown" itemprop="articleBody"><p><strong>Problem</strong></p><p>Map lookup such as <code>a[&#x27;key&#x27;]</code> works with linear complexity (mentioned <a href="https://clickhouse.com/docs/en/sql-reference/data-types/map" target="_blank" rel="noopener noreferrer">here</a>) and can be inefficient. This is because selecting a value with a specific key from a table would require iterating through all keys (~M) across all rows (N) in the Map column, resulting in ~MxN lookups.</p><p>A lookup using Map can be 10x slower than a String column. The experiment below also shows ~10x slowdown for cold query, and difference in multiple magnitudes of data processed (7.21 MB vs 5.65 GB).</p><div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">-- create table with SpanNAme as String and ResourceAttributes as Map</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">DROP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TABLE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">IF</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">EXISTS</span><span class="token plain"> tbl</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TABLE</span><span class="token plain"> tbl </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token identifier">Timestamp</span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token plain"> DateTime64</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">9</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> CODEC </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">Delta</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">8</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> ZSTD</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token identifier">TraceId</span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token plain"> String CODEC </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ZSTD</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token identifier">ServiceName</span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token plain"> LowCardinality</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">String</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> CODEC </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ZSTD</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token identifier">Duration</span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token plain"> UInt8 CODEC </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ZSTD</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">-- Int64</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token identifier">SpanName</span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token plain"> LowCardinality</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">String</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> CODEC </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ZSTD</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token identifier">ResourceAttributes</span><span class="token identifier punctuation" style="color:rgb(212, 212, 212)">`</span><span class="token plain"> Map</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">LowCardinality</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">String</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> String</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> CODEC </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ZSTD</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ENGINE</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> MergeTree</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">PARTITION</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> toDate</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">Timestamp</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ServiceName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> SpanName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> toUnixTimestamp</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">Timestamp</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> TraceId</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- create UDF to generate random Map data for ResourceAttributes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">DROP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">FUNCTION</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">IF</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">EXISTS</span><span class="token plain"> genmap</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">FUNCTION</span><span class="token plain"> genmap </span><span class="token keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">n</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> arrayMap </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">x</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">x::String</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">x</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain">rand32</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">::String</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> range</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> n</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- check that genmap is working as intended</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"> genmap</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">10</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">::Map</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">String</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> String</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- insert 1M rows</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">INTO</span><span class="token plain"> tbl</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token function" style="color:rgb(220, 220, 170)">now</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> randUniform</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1000000.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">Timestamp</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    randomPrintableASCII</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> TraceId</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    randomPrintableASCII</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> ServiceName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    rand32</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> Duration</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    randomPrintableASCII</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> SpanName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    genmap</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">rand64</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token operator" style="color:rgb(212, 212, 212)">%</span><span class="token number" style="color:rgb(181, 206, 168)">500</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">::Map</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">String</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> String</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> ResourceAttributes</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> numbers</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain">_000_000</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- querying for SpanName is faster</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- [cold] 0 rows in set. Elapsed: 0.642 sec. Processed 1.00 million rows, 7.21 MB (1.56 million rows/s., 11.22 MB/s.)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- [warm] 0 rows in set. Elapsed: 0.164 sec. Processed 1.00 million rows, 7.21 MB (6.10 million rows/s., 43.99 MB/s.)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token function" style="color:rgb(220, 220, 170)">COUNT</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token function" style="color:rgb(220, 220, 170)">avg</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">Duration</span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain">E6</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> average</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    quantile</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">0.95</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">Duration</span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain">E6</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> p95</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    quantile</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">0.99</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">Duration</span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain">E6</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> p99</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    SpanName</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> tbl</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> SpanName </span><span class="token keyword" style="color:rgb(86, 156, 214)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">DESC</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">50</span><span class="token plain"> FORMAT </span><span class="token boolean">Null</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- query for ResourceAttributes is slower</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- [cold] 0 rows in set. Elapsed: 6.432 sec. Processed 1.00 million rows, 5.65 GB (155.46 thousand rows/s., 879.07 MB/s.)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- [warm] 0 rows in set. Elapsed: 5.935 sec. Processed 1.00 million rows, 5.65 GB (168.50 thousand rows/s., 952.81 MB/s.)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token function" style="color:rgb(220, 220, 170)">COUNT</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token function" style="color:rgb(220, 220, 170)">avg</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">Duration</span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain">E6</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> average</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    quantile</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">0.95</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">Duration</span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain">E6</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> p95</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    quantile</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">0.99</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">Duration</span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain">E6</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> p99</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    ResourceAttributes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;1&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> hostname</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> tbl</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> hostname </span><span class="token keyword" style="color:rgb(86, 156, 214)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">DESC</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">50</span><span class="token plain"> FORMAT </span><span class="token boolean">Null</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>Solution</strong>
To improve the query, we can add another column with the value defaulting to a particular key in the Map column, and then materializing it to populate value for existing rows. This way, we extract and store the necessary value at insertion time, thereby speeding up the lookup at query time.</p><div class="language-sql codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">-- solution is to add a column with value defaulting to a particular key in Map</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TABLE</span><span class="token plain"> tbl </span><span class="token keyword" style="color:rgb(86, 156, 214)">ADD</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">COLUMN</span><span class="token plain"> hostname LowCardinality</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">String</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">DEFAULT</span><span class="token plain"> ResourceAttributes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;1&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">TABLE</span><span class="token plain"> tbl MATERIALIZE </span><span class="token keyword" style="color:rgb(86, 156, 214)">COLUMN</span><span class="token plain"> hostname</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- query for hostname (new column) is now faster</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- [cold] 0 rows in set. Elapsed: 2.215 sec. Processed 1.00 million rows, 21.67 MB (451.52 thousand rows/s., 9.78 MB/s.)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- [warm] 0 rows in set. Elapsed: 0.541 sec. Processed 1.00 million rows, 21.67 MB (1.85 million rows/s., 40.04 MB/s.)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token function" style="color:rgb(220, 220, 170)">COUNT</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token function" style="color:rgb(220, 220, 170)">avg</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">Duration</span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain">E6</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> average</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    quantile</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">0.95</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">Duration</span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain">E6</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> p95</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    quantile</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">0.99</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">Duration</span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain">E6</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> p99</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    hostname</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token plain"> tbl</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> hostname </span><span class="token keyword" style="color:rgb(86, 156, 214)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">BY</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">DESC</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">50</span><span class="token plain"> FORMAT </span><span class="token boolean">Null</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">-- drop cache to run query cold</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">SYSTEM </span><span class="token keyword" style="color:rgb(86, 156, 214)">DROP</span><span class="token plain"> FILESYSTEM CACHE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/docs/knowledgebase/delete-old-data">Is it possible to delete old records from a ClickHouse table?</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-10-19T00:00:00.000Z" itemprop="datePublished">October 19, 2022</time> · <!-- -->2 min read</div></header><div class="markdown" itemprop="articleBody"><p>The short answer is “yes”. ClickHouse has multiple mechanisms that allow freeing up disk space by removing old data. Each mechanism is aimed for different scenarios.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ttl">TTL<a href="#ttl" class="hash-link" aria-label="Direct link to TTL" title="Direct link to TTL">​</a></h2><p>ClickHouse allows to automatically drop values when some condition happens. This condition is configured as an expression based on any columns, usually just static offset for any timestamp column.</p><p>The key advantage of this approach is that it does not need any external system to trigger, once TTL is configured, data removal happens automatically in background.</p><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_WoCw"><div class="alert-icon admonitionIcon_Ibzs"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></div><div class="alert-content admonitionContent_vXIg"><div class="admonitionHeading_TMsN">note</div><p>TTL can also be used to move data not only to <a href="https://en.wikipedia.org/wiki/Null_device" target="_blank" rel="noopener noreferrer">/dev/null</a>, but also between different storage systems, like from SSD to HDD.</p></div></div><p>More details on <a href="https://clickhouse.com/docs/en/engines/table-engines/mergetree-family/mergetree#table_engine-mergetree-ttl" target="_blank" rel="noopener noreferrer">configuring TTL</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="delete-from">DELETE FROM<a href="#delete-from" class="hash-link" aria-label="Direct link to DELETE FROM" title="Direct link to DELETE FROM">​</a></h2><p><a href="https://clickhouse.com/docs/en/sql-reference/statements/delete" target="_blank" rel="noopener noreferrer">DELETE FROM</a> allows standard DELETE queries to be run in ClickHouse. The rows targeted in the filter clause are marked as deleted, and removed from future result sets.  Cleanup of the rows happens asynchronously.</p><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_WoCw"><div class="alert-icon admonitionIcon_Ibzs"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></div><div class="alert-content admonitionContent_vXIg"><div class="admonitionHeading_TMsN">note</div><p>DELETE FROM is an experimental feature and must be enabled with:</p><div class="codeBlockContainer_APcc theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">SET allow_experimental_lightweight_delete = true;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="alter-delete">ALTER DELETE<a href="#alter-delete" class="hash-link" aria-label="Direct link to ALTER DELETE" title="Direct link to ALTER DELETE">​</a></h2><p>ALTER DELETE removes rows using asynchronous batch operations. Unlike DELETE FROM, queries run after the ALTER DELETE and before the batch operations complete will include the rows targeted for deletion.  For more details see the <a href="https://clickhouse.com/docs/en/sql-reference/statements/alter/delete" target="_blank" rel="noopener noreferrer">ALTER DELETE</a> docs.</p><p><code>ALTER DELETE</code> can be issued to flexibly remove old data. If you need to do it regularly, the main downside will be the need to have an external system to submit the query. There are also some performance considerations since mutations rewrite complete parts even there is only a single row to be deleted.</p><p>This is the most common approach to make your system based on ClickHouse <a href="https://gdpr-info.eu" target="_blank" rel="noopener noreferrer">GDPR</a>-compliant.</p><p>More details on <a href="https://clickhouse.com/docs/en/sql-reference/statements/alter/#alter-mutations" target="_blank" rel="noopener noreferrer">mutations</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="drop-partition">DROP PARTITION<a href="#drop-partition" class="hash-link" aria-label="Direct link to DROP PARTITION" title="Direct link to DROP PARTITION">​</a></h2><p><code>ALTER TABLE ... DROP PARTITION</code> provides a cost-efficient way to drop a whole partition. It’s not that flexible and needs proper partitioning scheme configured on table creation, but still covers most common cases. Like mutations need to be executed from an external system for regular use.</p><p>More details on <a href="https://clickhouse.com/docs/en/sql-reference/statements/alter/partition/#alter_drop-partition" target="_blank" rel="noopener noreferrer">manipulating partitions</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="truncate">TRUNCATE<a href="#truncate" class="hash-link" aria-label="Direct link to TRUNCATE" title="Direct link to TRUNCATE">​</a></h2><p>It’s rather radical to drop all data from a table, but in some cases it might be exactly what you need.</p><p>More details on <a href="https://clickhouse.com/docs/en/sql-reference/statements/truncate" target="_blank" rel="noopener noreferrer">table truncation</a>.</p></div></article><nav class="pagination-nav" aria-label="Blog list page navigation"><a class="pagination-nav__link pagination-nav__link--prev paginationNavLink_UdUv" href="/docs/knowledgebase/page/2"><svg width="24" height="25" viewBox="0 0 24 25" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9.2751 19.175L10.3251 18.125L5.4501 13.25H21.6001V11.75H5.4501L10.3251 6.87501L9.2751 5.82501L2.5751 12.5L9.2751 19.175Z" fill="currentColor"></path></svg><div class="paginationNavContent__3xr"><div class="paginationNavLabel_YPzM pagination-nav__label">Newer Entries</div></div></a><a class="pagination-nav__link pagination-nav__link--next paginationNavLink_UdUv" href="/docs/knowledgebase/page/4"><div class="paginationNavContent__3xr"><div class="paginationNavLabel_YPzM pagination-nav__label">Older Entries</div></div><svg width="24" height="25" viewBox="0 0 24 25" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14.7249 19.175L13.6749 18.125L18.5499 13.25H2.3999V11.75H18.5499L13.6749 6.87501L14.7249 5.82501L21.4249 12.5L14.7249 19.175Z" fill="currentColor"></path></svg></a></nav></main></div></div></div><footer class="footer footer_jryj"><div class="container_y1z5 container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">© 2016&ndash;2023 ClickHouse, Inc.</div></div><div><div class="footer__links text--center"><div class="footer__links"><a href="https://clickhouse.com/legal/trademark-policy" target="_blank" rel="noopener noreferrer" class="footer__link-item">Trademark</a><span class="footer__link-separator">·</span><a href="https://clickhouse.com/legal/privacy-policy" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy</a><span class="footer__link-separator">·</span><a href="https://trust.clickhouse.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Security</a><span class="footer__link-separator">·</span><a href="https://clickhouse.com/legal/agreements/terms-of-service" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms of Service</a></div></div></div></div><button class="colorModeButton_hk25"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M8.7227 0.724664C8.7227 0.330045 8.39191 0 8.0036 0C7.60809 0 7.2773 0.330045 7.2773 0.724664V2.18834C7.2773 2.57578 7.60809 2.90583 8.0036 2.90583C8.39191 2.90583 8.7227 2.57578 8.7227 2.18834V0.724664ZM11.5991 3.4009C11.3258 3.67354 11.3258 4.13274 11.6063 4.41256C11.8796 4.6852 12.347 4.69238 12.6274 4.40538L13.6629 3.3722C13.9434 3.09238 13.9362 2.62601 13.6629 2.34619C13.3897 2.07354 12.9222 2.08072 12.649 2.35336L11.5991 3.4009ZM3.37258 4.40538C3.64584 4.6852 4.11326 4.6852 4.38652 4.41256C4.66697 4.14709 4.66697 3.66637 4.4009 3.4009L3.3582 2.35336C3.09213 2.08789 2.61753 2.07354 2.34427 2.34619C2.07101 2.62601 2.06382 3.09238 2.33708 3.36502L3.37258 4.40538ZM7.9964 11.774C10.0602 11.774 11.7717 10.0664 11.7717 8C11.7717 5.93363 10.0602 4.22601 7.9964 4.22601C5.93258 4.22601 4.22112 5.93363 4.22112 8C4.22112 10.0664 5.93258 11.774 7.9964 11.774ZM7.9964 10.4395C6.65888 10.4395 5.55146 9.33453 5.55146 8C5.55146 6.66547 6.65888 5.56054 7.9964 5.56054C9.33393 5.56054 10.4413 6.66547 10.4413 8C10.4413 9.33453 9.33393 10.4395 7.9964 10.4395ZM15.2809 8.71749C15.6692 8.71749 16 8.38744 16 8C16 7.60538 15.6692 7.28251 15.2809 7.28251H13.8211C13.4328 7.28251 13.102 7.60538 13.102 8C13.102 8.38744 13.4328 8.71749 13.8211 8.71749H15.2809ZM0.719101 7.28251C0.330787 7.28251 0 7.60538 0 8C0 8.38744 0.330787 8.71749 0.719101 8.71749H2.17888C2.57438 8.71749 2.90517 8.38744 2.90517 8C2.90517 7.60538 2.57438 7.28251 2.17888 7.28251H0.719101ZM12.6202 11.5946C12.347 11.322 11.8796 11.322 11.5991 11.5946C11.3258 11.8744 11.3258 12.3336 11.6063 12.6135L12.649 13.6538C12.9294 13.9265 13.3897 13.9193 13.6701 13.6395C13.9434 13.3668 13.9434 12.9076 13.6629 12.6278L12.6202 11.5946ZM2.33708 12.6206C2.05663 12.9004 2.05663 13.3668 2.3227 13.6395C2.60315 13.9121 3.07056 13.9193 3.34382 13.6466L4.38652 12.6135C4.66697 12.3336 4.66697 11.8744 4.4009 11.6018C4.12045 11.322 3.65303 11.322 3.37258 11.5946L2.33708 12.6206ZM8.7227 13.8117C8.7227 13.4242 8.39191 13.0942 8.0036 13.0942C7.60809 13.0942 7.2773 13.4242 7.2773 13.8117V15.2753C7.2773 15.6628 7.60809 16 8.0036 16C8.39191 16 8.7227 15.6628 8.7227 15.2753V13.8117Z" fill="currentColor"></path></svg><span>light Mode</span></button></footer></div>
<script src="/docs/assets/js/runtime~main.3c6ad612.js"></script>
<script src="/docs/assets/js/main.b8d4548e.js"></script>
</body>
</html>